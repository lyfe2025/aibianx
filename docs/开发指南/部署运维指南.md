# 部署运维指南 🚀

> 📋 AI变现之路项目的完整部署运维指南，涵盖开发环境搭建、生产部署、性能优化、监控告警等

## 📋 部署概览

| 部署信息 | 详情 |
|---------|------|
| **前端框架** | Next.js 14 (App Router) |
| **部署方式** | Vercel (推荐) / 自建服务器 |
| **构建工具** | Turbopack |
| **环境管理** | 开发/测试/生产三环境 |
| **CDN加速** | Vercel Edge Network |
| **域名管理** | Cloudflare DNS |

---

## 🛠️ 开发环境搭建

### 系统要求
```bash
# 必需软件版本
Node.js >= 18.17.0
npm >= 9.6.7
Git >= 2.40.0

# 推荐软件
VSCode + Cursor
Chrome/Edge 浏览器
```

### 快速开始
```bash
# 1. 克隆项目
git clone https://github.com/aibianx/aibianx.git
cd aibianx

# 2. 安装依赖
cd frontend
npm install

# 3. 启动开发服务器
npm run dev

# 4. 浏览器访问
open http://localhost:3000
```

### 环境变量配置
```bash
# frontend/.env.local
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:8000/v1

# 第三方服务配置（开发环境）
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# 分析工具（可选）
NEXT_PUBLIC_GA_ID=your_google_analytics_id
NEXT_PUBLIC_HOTJAR_ID=your_hotjar_id
```

### 开发服务器配置
```javascript
// next.config.ts
const nextConfig = {
  // 开发环境优化
  experimental: {
    turbo: {
      rules: {
        '*.svg': ['@svgr/webpack'],
      },
    },
  },
  
  // 热重载配置
  webpack: (config, { dev }) => {
    if (dev) {
      config.watchOptions = {
        poll: 1000,
        aggregateTimeout: 300,
      }
    }
    return config
  }
}
```

---

## 🚀 生产环境部署

### Vercel部署 (推荐)

#### 1. Vercel CLI部署
```bash
# 安装Vercel CLI
npm i -g vercel

# 登录Vercel
vercel login

# 初始化项目
cd frontend
vercel

# 部署到生产环境
vercel --prod
```

#### 2. GitHub集成部署
```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build project
        run: |
          cd frontend
          npm run build
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
```

#### 3. Vercel配置文件
```json
// vercel.json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "framework": "nextjs",
  "regions": ["sin1", "hkg1"],
  "functions": {
    "frontend/src/app/api/**": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/fonts/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    }
  ],
  "redirects": [
    {
      "source": "/blog",
      "destination": "/weekly",
      "permanent": true
    }
  ]
}
```

### 自建服务器部署

#### 1. Docker部署
```dockerfile
# Dockerfile
FROM node:18-alpine AS deps
WORKDIR /app
COPY frontend/package.json frontend/package-lock.json ./
RUN npm ci --only=production

FROM node:18-alpine AS builder
WORKDIR /app
COPY frontend/ .
COPY --from=deps /app/node_modules ./node_modules
RUN npm run build

FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build: 
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_APP_URL=https://aibianx.com
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
    restart: unless-stopped
```

#### 2. Nginx配置
```nginx
# nginx.conf
upstream frontend {
    server frontend:3000;
}

server {
    listen 80;
    server_name aibianx.com www.aibianx.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name aibianx.com www.aibianx.com;
    
    # SSL配置
    ssl_certificate /etc/nginx/ssl/aibianx.com.crt;
    ssl_certificate_key /etc/nginx/ssl/aibianx.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_types
        text/plain
        text/css
        text/js
        text/javascript
        application/javascript
        application/json
        image/svg+xml;
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        proxy_pass http://frontend;
    }
    
    # 代理到Next.js
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

## 🔧 环境管理

### 环境配置
```bash
# 开发环境 (.env.local)
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:8000/v1

# 测试环境 (.env.staging)
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://staging.aibianx.com
NEXT_PUBLIC_API_URL=https://api-staging.aibianx.com/v1

# 生产环境 (.env.production)
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://aibianx.com
NEXT_PUBLIC_API_URL=https://api.aibianx.com/v1
```

### 构建优化
```javascript
// next.config.ts
const nextConfig = {
  // 生产环境优化
  output: 'standalone',
  compress: true,
  poweredByHeader: false,
  
  // 图片优化
  images: {
    formats: ['image/webp', 'image/avif'],
    domains: ['aibianx.com'],
    minimumCacheTTL: 31536000,
  },
  
  // 字体优化
  experimental: {
    fontLoaders: [
      { loader: '@next/font/google', options: { subsets: ['latin'] } },
    ],
  },
  
  // Bundle分析
  webpack: (config, { isServer }) => {
    if (!isServer) {
      config.resolve.fallback = {
        fs: false,
        net: false,
        tls: false,
      }
    }
    
    // Bundle大小分析
    if (process.env.ANALYZE === 'true') {
      const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer')
      config.plugins.push(
        new BundleAnalyzerPlugin({
          analyzerMode: 'static',
          openAnalyzer: false,
        })
      )
    }
    
    return config
  },
}
```

---

## ⚡ 性能优化

### 构建性能优化
```bash
# 并行构建
TURBO_TEAM=your-team npm run build

# 增量构建
npm run build -- --experimental-build-cache

# Bundle分析
ANALYZE=true npm run build
npm run analyze
```

### 运行时性能优化
```typescript
// app/layout.tsx - 性能优化配置
import { Metadata } from 'next'

// 预加载关键资源
export const metadata: Metadata = {
  other: {
    'resource-hints': [
      '<link rel="preload" href="/fonts/alibaba-puhuiti.woff2" as="font" crossorigin>',
      '<link rel="dns-prefetch" href="//api.aibianx.com">',
    ].join(''),
  },
}

// 关键CSS内联
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <head>
        <style dangerouslySetInnerHTML={{
          __html: `
            /* 关键路径CSS */
            :root{--color-bg-primary:#030303}
            body{background:var(--color-bg-primary)}
          `
        }} />
      </head>
      <body>{children}</body>
    </html>
  )
}
```

### 图片优化
```typescript
// 响应式图片组件
import Image from 'next/image'

export function OptimizedImage({
  src,
  alt,
  width,
  height,
  priority = false,
}: {
  src: string
  alt: string
  width: number
  height: number
  priority?: boolean
}) {
  return (
    <Image
      src={src}
      alt={alt}
      width={width}
      height={height}
      priority={priority}
      placeholder="blur"
      blurDataURL="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
      sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
      style={{
        objectFit: 'cover',
        objectPosition: 'center',
      }}
    />
  )
}
```

---

## 📊 监控和日志

### Vercel Analytics集成
```typescript
// app/layout.tsx
import { Analytics } from '@vercel/analytics/react'
import { SpeedInsights } from '@vercel/speed-insights/next'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
        <SpeedInsights />
      </body>
    </html>
  )
}
```

### 错误监控
```typescript
// lib/error-monitoring.ts
class ErrorMonitoring {
  static init() {
    if (typeof window !== 'undefined') {
      window.addEventListener('error', this.handleError)
      window.addEventListener('unhandledrejection', this.handlePromiseRejection)
    }
  }
  
  static handleError(event: ErrorEvent) {
    console.error('Global error:', event.error)
    
    // 发送到监控服务
    fetch('/api/errors', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'javascript',
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        stack: event.error?.stack,
        userAgent: navigator.userAgent,
        timestamp: new Date().toISOString(),
      }),
    })
  }
  
  static handlePromiseRejection(event: PromiseRejectionEvent) {
    console.error('Unhandled promise rejection:', event.reason)
    
    fetch('/api/errors', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'promise',
        reason: event.reason?.toString(),
        stack: event.reason?.stack,
        timestamp: new Date().toISOString(),
      }),
    })
  }
}

export default ErrorMonitoring
```

### 性能监控
```typescript
// lib/performance-monitoring.ts
export class PerformanceMonitoring {
  static reportWebVitals(metric: any) {
    // Core Web Vitals监控
    const { name, value, id } = metric
    
    // 发送到分析服务
    if (typeof window !== 'undefined') {
      ;(window as any).gtag?.('event', 'web_vitals', {
        event_category: 'Performance',
        event_label: name,
        value: Math.round(name === 'CLS' ? value * 1000 : value),
        custom_parameter_1: id,
        non_interaction: true,
      })
    }
    
    // 发送到自定义监控
    fetch('/api/analytics/web-vitals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name,
        value,
        id,
        timestamp: Date.now(),
      }),
    })
  }
}

// app/layout.tsx
import { reportWebVitals } from '@/lib/performance-monitoring'

export { reportWebVitals }
```

---

## 🔐 安全配置

### CSP安全策略
```typescript
// next.config.ts
const nextConfig = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-eval' 'unsafe-inline' *.vercel-analytics.com *.google-analytics.com",
              "style-src 'self' 'unsafe-inline'",
              "img-src 'self' data: blob: *.aibianx.com",
              "font-src 'self' data:",
              "connect-src 'self' *.vercel-analytics.com *.google-analytics.com api.aibianx.com",
              "frame-ancestors 'none'",
            ].join('; '),
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ]
  },
}
```

### 环境变量安全
```bash
# 敏感信息管理
# .env.local (不要提交到Git)
DATABASE_URL=postgresql://...
JWT_SECRET=your-super-secret-key
GITHUB_CLIENT_SECRET=your-github-secret
STRIPE_SECRET_KEY=sk_test_...

# Vercel环境变量配置
vercel env add DATABASE_URL production
vercel env add JWT_SECRET production
vercel env add GITHUB_CLIENT_SECRET production
```

---

## 📈 SEO优化

### Meta标签优化
```typescript
// app/layout.tsx
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: {
    template: '%s | AI变现之路',
    default: 'AI变现之路 - 专业的AI商业化平台',
  },
  description: '汇聚AI领域专家实战经验，每周分享最新变现机会与实用工具',
  keywords: ['AI变现', 'ChatGPT', 'Midjourney', '人工智能', 'AI工具'],
  
  openGraph: {
    type: 'website',
    locale: 'zh_CN',
    url: 'https://aibianx.com',
    siteName: 'AI变现之路',
    images: [{
      url: '/og-image.jpg',
      width: 1200,
      height: 630,
      alt: 'AI变现之路',
    }],
  },
  
  twitter: {
    card: 'summary_large_image',
    site: '@aibianx',
    creator: '@aibianx',
  },
  
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
  
  verification: {
    google: 'your-google-site-verification',
    baidu: 'your-baidu-site-verification',
  },
}
```

### 结构化数据
```typescript
// components/StructuredData.tsx
export function ArticleStructuredData({ article }: { article: Article }) {
  const structuredData = {
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: article.title,
    description: article.excerpt,
    image: article.coverImage,
    author: {
      '@type': 'Person',
      name: article.author.name,
    },
    publisher: {
      '@type': 'Organization',
      name: 'AI变现之路',
      logo: {
        '@type': 'ImageObject',
        url: '/logo.png',
      },
    },
    datePublished: article.publishedAt,
    dateModified: article.updatedAt,
  }
  
  return (
    <script
      type="application/ld+json"
      dangerouslySetInnerHTML={{ __html: JSON.stringify(structuredData) }}
    />
  )
}
```

---

## 🚨 故障排除

### 常见问题诊断

#### 构建失败
```bash
# 清理缓存
rm -rf .next node_modules package-lock.json
npm install
npm run build

# 检查依赖冲突
npm ls
npm audit

# 调试构建过程
DEBUG=* npm run build
```

#### 部署失败
```bash
# Vercel部署日志
vercel logs

# 检查环境变量
vercel env ls

# 重新部署
vercel --force
```

#### 性能问题
```bash
# 分析Bundle大小
npm run analyze

# 检查内存使用
node --max-old-space-size=4096 node_modules/.bin/next build

# 启用性能分析
NEXT_PUBLIC_PERFORMANCE_DEBUG=true npm run dev
```

### 监控告警
```yaml
# .github/workflows/health-check.yml
name: Health Check

on:
  schedule:
    - cron: '*/5 * * * *'  # 每5分钟检查一次
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check website availability
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://aibianx.com)
          if [ $response -ne 200 ]; then
            echo "Website is down! HTTP code: $response"
            exit 1
          fi
          echo "Website is healthy"
      
      - name: Check API availability
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://api.aibianx.com/v1/health)
          if [ $response -ne 200 ]; then
            echo "API is down! HTTP code: $response"
            exit 1
          fi
          echo "API is healthy"
      
      - name: Notify if failed
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

---

## 📞 运维支持

### 运维团队联系方式
- **紧急故障**: ops-emergency@aibianx.com
- **日常运维**: ops@aibianx.com
- **监控告警**: 企业微信群、Slack频道

### 运维工具
- **监控平台**: Vercel Analytics + 自建监控
- **日志系统**: Vercel Logs + ELK Stack
- **告警系统**: PagerDuty + 企业微信
- **备份策略**: 数据库定时备份 + 代码Git管理

### 运维流程
1. **发布流程**: 开发 → 测试 → 预发布 → 生产
2. **回滚机制**: Vercel一键回滚 + 数据库备份恢复
3. **应急响应**: 15分钟内响应 + 1小时内修复
4. **例行维护**: 每周日凌晨2-4点维护窗口

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**维护团队**: AI变现之路运维团队  

*持续优化部署流程，确保服务稳定可靠* 🚀 