# AIå˜ç°ä¹‹è·¯ - PostgreSQLæ•°æ®åº“è®¾è®¡ ğŸ“Š

> ğŸ“‹ **è®¾è®¡æ–‡æ¡£**ï¼šåŸºäºPostgreSQLçš„å®Œæ•´æ•°æ®åº“è®¾è®¡æ–¹æ¡ˆï¼Œæ”¯æŒSEOä¼˜åŒ–å’Œå•†ä¸šåŒ–åŠŸèƒ½

## ğŸ“š æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æ˜¯ **[æŠ€æœ¯æ–¹æ¡ˆæ€»è§ˆæŒ‡å—](./AIå˜ç°ä¹‹è·¯_æŠ€æœ¯æ–¹æ¡ˆæ€»è§ˆæŒ‡å—.md)** çš„é…å¥—æ–‡æ¡£ï¼Œè¯¦ç»†è®¾è®¡PostgreSQLæ•°æ®åº“è¡¨ç»“æ„ã€‚

### ğŸ¯ è®¾è®¡åŸåˆ™

åŸºäºä¸»æ–‡æ¡£çš„**Strapi + PostgreSQLç»Ÿä¸€æ•°æ®ç®¡ç†ç­–ç•¥**ï¼š
- **å†…å®¹æ•°æ®**ï¼ˆæ–‡ç« ã€ä½œè€…ã€æ ‡ç­¾ã€åˆ†ç±»ï¼‰â†’ Strapiæ•°æ®åº“ç®¡ç†ï¼ŒAPIè‡ªåŠ¨ç”Ÿæˆ
- **ç”¨æˆ·æ•°æ®**ï¼ˆç”¨æˆ·ã€æƒé™ã€ä¼šè¯ã€åå¥½ï¼‰â†’ Strapiç”¨æˆ·ç³»ç»Ÿï¼Œå®Œæ•´è®¤è¯æµç¨‹
- **ä¸šåŠ¡æ•°æ®**ï¼ˆè®¢å•ã€æ”¯ä»˜ã€ä¼šå‘˜ã€è¥é”€ï¼‰â†’ PostgreSQLå­˜å‚¨ï¼ŒStrapiç®¡ç†
- **è¡Œä¸ºæ•°æ®**ï¼ˆæ”¶è—ã€ç»Ÿè®¡ã€åˆ†æã€é€šçŸ¥ï¼‰â†’ æ•°æ®åº“å®æ—¶è®°å½•å’Œåˆ†æ

---

## ğŸ—„ï¸ ä¸ºä»€ä¹ˆé€‰æ‹©PostgreSQLï¼Ÿ

åŸºäºé¡¹ç›®çš„å¤æ‚éœ€æ±‚å’Œé•¿æœŸå‘å±•è€ƒè™‘ï¼ŒPostgreSQLæ˜¯æœ€ä½³é€‰æ‹©ï¼š

### âœ… **æŠ€æœ¯ä¼˜åŠ¿**
- **å¼ºå¤§çš„JSONBæ”¯æŒ**ï¼šè¥é”€æ´»åŠ¨é…ç½®ã€ç”¨æˆ·åå¥½ç­‰å¤æ‚æ•°æ®å­˜å‚¨æ›´é«˜æ•ˆ
- **åŸç”Ÿæ•°ç»„ç±»å‹**ï¼šæƒé™åˆ—è¡¨ã€æ ‡ç­¾æ•°ç»„ç­‰ä¸éœ€è¦é¢å¤–å…³è”è¡¨
- **å¤æ‚æŸ¥è¯¢åŠŸèƒ½**ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€æ”¶å…¥ç»Ÿè®¡ç­‰éœ€è¦å¼ºå¤§çš„åˆ†æåŠŸèƒ½
- **å†…ç½®å…¨æ–‡æœç´¢**ï¼šæ–‡ç« å†…å®¹æœç´¢ï¼Œæ— éœ€é¢å¤–é›†æˆElasticSearch
- **ä¸¥æ ¼çš„ACIDç‰¹æ€§**ï¼šè´¢åŠ¡æ•°æ®å®‰å…¨å¯é 
- **ä¼˜ç§€çš„æ‰©å±•æ€§**ï¼šæ”¯æŒæµ·é‡å†…å®¹å’Œç”¨æˆ·å¢é•¿

### ğŸš€ **å…·ä½“ä¸šåŠ¡åœºæ™¯ä¼˜åŠ¿**

#### **1. è¥é”€æ´»åŠ¨é…ç½®ï¼ˆJSONBå¨åŠ›ï¼‰**
```sql
-- PostgreSQLè½»æ¾å¤„ç†å¤æ‚é…ç½®
CREATE TABLE marketing_activities (
    config JSONB DEFAULT '{}',
    target_audience JSONB
);

-- é«˜æ•ˆæŸ¥è¯¢
SELECT * FROM marketing_activities 
WHERE config->>'type' = 'countdown_sale' 
AND config->'budget'::numeric > 1000;
```

#### **2. ç”¨æˆ·æƒé™ç®¡ç†ï¼ˆæ•°ç»„ä¾¿åˆ©æ€§ï¼‰**
```sql
-- åŸç”Ÿæ•°ç»„æ”¯æŒ
CREATE TABLE users (
    permissions TEXT[] DEFAULT ARRAY[]::TEXT[],
    tags VARCHAR(50)[]
);

-- ç®€å•çš„æƒé™æŸ¥è¯¢
SELECT * FROM users 
WHERE 'premium_content' = ANY(permissions);
```

#### **3. å†…å®¹å…¨æ–‡æœç´¢ï¼ˆå†…ç½®åŠŸèƒ½ï¼‰**
```sql
-- ä¸­æ–‡å†…å®¹æœç´¢
CREATE INDEX idx_articles_search ON articles 
USING gin(to_tsvector('chinese', title || ' ' || content));

-- æœç´¢æŸ¥è¯¢
SELECT * FROM articles 
WHERE to_tsvector('chinese', title || ' ' || content) 
      @@ plainto_tsquery('chinese', 'AIå˜ç°');
```

---

## ğŸ“‹ æ ¸å¿ƒè¡¨ç»“æ„è®¾è®¡

### ğŸ—‚ï¸ **æ•°æ®åº“æ¶æ„æ€»è§ˆ**

```
ç”¨æˆ·ç›¸å…³æ¨¡å—:
users (ç”¨æˆ·åŸºç¡€ä¿¡æ¯)
â”œâ”€â”€ user_profiles (æ‰©å±•èµ„æ–™)
â”œâ”€â”€ user_subscriptions (ä¼šå‘˜è®¢é˜…)
â”œâ”€â”€ user_sessions (ç™»å½•ä¼šè¯)
â”œâ”€â”€ user_bookmarks (æ”¶è—è®°å½•)
â”œâ”€â”€ user_balance (ç”¨æˆ·ä½™é¢)
â””â”€â”€ reading_history (é˜…è¯»å†å²)

å†…å®¹ç®¡ç†æ¨¡å—:
articles (æ–‡ç« ) â†’ Strapiç®¡ç†
â”œâ”€â”€ authors (ä½œè€…) â†’ Strapiç®¡ç†
â”œâ”€â”€ tags (æ ‡ç­¾) â†’ Strapiç®¡ç†
â””â”€â”€ categories (åˆ†ç±») â†’ Strapiç®¡ç†

è´¢åŠ¡ç®¡ç†æ¨¡å—:
orders (è®¢å•è®°å½•)
â”œâ”€â”€ payments (æ”¯ä»˜è®°å½•)
â”œâ”€â”€ withdraws (æç°è®°å½•)
â”œâ”€â”€ income_records (æ”¶å…¥è®°å½•)
â””â”€â”€ coupons (ä¼˜æƒ åˆ¸)

è¥é”€æ¨å¹¿æ¨¡å—:
invite_records (é‚€è¯·è®°å½•)
â”œâ”€â”€ marketing_activities (è¥é”€æ´»åŠ¨)
â”œâ”€â”€ coupon_usage (ä¼˜æƒ åˆ¸ä½¿ç”¨)
â””â”€â”€ referral_rewards (æ¨èå¥–åŠ±)

é€šä¿¡ç³»ç»Ÿæ¨¡å—:
email_subscriptions (é‚®ä»¶è®¢é˜…)
â”œâ”€â”€ email_templates (é‚®ä»¶æ¨¡æ¿)
â”œâ”€â”€ notifications (ç«™å†…é€šçŸ¥)
â””â”€â”€ notification_settings (é€šçŸ¥è®¾ç½®)

ç»Ÿè®¡åˆ†ææ¨¡å—:
article_statistics (æ–‡ç« ç»Ÿè®¡)
â”œâ”€â”€ user_activities (ç”¨æˆ·è¡Œä¸º)
â”œâ”€â”€ business_stats (ä¸šåŠ¡ç»Ÿè®¡)
â””â”€â”€ analytics_events (åˆ†æäº‹ä»¶)

ç³»ç»Ÿé…ç½®æ¨¡å—:
site_configs (ç½‘ç«™é…ç½®)
â”œâ”€â”€ payment_configs (æ”¯ä»˜é…ç½®)
â”œâ”€â”€ seo_configs (SEOé…ç½®)
â””â”€â”€ email_configs (é‚®ä»¶é…ç½®)
```

---

## ğŸ‘¤ ç”¨æˆ·ç®¡ç†æ¨¡å—

### 1. users - ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨

```sql
CREATE TABLE users (
    -- åŸºç¡€å­—æ®µ
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    password_hash VARCHAR(255), -- å¯ä¸ºç©ºï¼Œæ”¯æŒOAuthç™»å½•
    
    -- åŸºæœ¬ä¿¡æ¯
    nickname VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    location VARCHAR(100),
    website_url TEXT,
    
    -- è®¤è¯ç›¸å…³
    github_id VARCHAR(50) UNIQUE, -- GitHub OAuth ID
    google_id VARCHAR(50) UNIQUE, -- Google OAuth ID (é¢„ç•™)
    wechat_id VARCHAR(50) UNIQUE, -- å¾®ä¿¡ç™»å½•ID (é¢„ç•™)
    
    -- ä¼šå‘˜çŠ¶æ€
    membership_level VARCHAR(20) DEFAULT 'free' CHECK (membership_level IN ('free', 'monthly', 'yearly')),
    membership_expire_at TIMESTAMP,
    
    -- ç”¨æˆ·åå¥½ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    preferences JSONB DEFAULT '{}', -- ç”¨æˆ·åå¥½è®¾ç½®
    notification_settings JSONB DEFAULT '{}', -- é€šçŸ¥è®¾ç½®
    
    -- æƒé™ç®¡ç†ï¼ˆæ•°ç»„ä¼˜åŠ¿ï¼‰
    permissions TEXT[] DEFAULT ARRAY[]::TEXT[], -- ç”¨æˆ·æƒé™åˆ—è¡¨
    
    -- åŸºç¡€è®¾ç½®
    language VARCHAR(10) DEFAULT 'zh-CN',
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    
    -- SEOç›¸å…³å­—æ®µ
    public_profile BOOLEAN DEFAULT FALSE, -- æ˜¯å¦å…¬å¼€ä¸ªäººèµ„æ–™é¡µé¢
    profile_slug VARCHAR(100) UNIQUE, -- ç”¨æˆ·ä¸»é¡µslugï¼Œå¦‚ï¼š/user/li-mingyang
    seo_title VARCHAR(200), -- ä¸ªäººé¡µé¢SEOæ ‡é¢˜
    seo_description TEXT, -- ä¸ªäººé¡µé¢SEOæè¿°
    
    -- ç»Ÿè®¡æ•°æ®ï¼ˆå†—ä½™å­—æ®µï¼Œæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
    articles_read_count INTEGER DEFAULT 0,
    bookmarks_count INTEGER DEFAULT 0,
    total_reading_time INTEGER DEFAULT 0, -- æ€»é˜…è¯»æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    
    -- è½¯åˆ é™¤
    deleted_at TIMESTAMP
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_membership ON users(membership_level, membership_expire_at);
CREATE INDEX idx_users_permissions ON users USING gin(permissions);
CREATE INDEX idx_users_preferences ON users USING gin(preferences);
CREATE INDEX idx_users_profile_slug ON users(profile_slug) WHERE profile_slug IS NOT NULL;

-- æ›´æ–°æ—¶é—´è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 2. user_sessions - ç”¨æˆ·ä¼šè¯ç®¡ç†

```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- JWT Tokenç›¸å…³
    token_hash VARCHAR(255) NOT NULL, -- JWT tokençš„hashå€¼
    refresh_token_hash VARCHAR(255), -- åˆ·æ–°tokençš„hashå€¼
    
    -- ä¼šè¯ä¿¡æ¯ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    device_info JSONB, -- è®¾å¤‡ä¿¡æ¯ {browser, os, device_type, version}
    location_info JSONB, -- ä½ç½®ä¿¡æ¯ {country, city, ip}
    
    -- ç½‘ç»œä¿¡æ¯
    ip_address INET,
    user_agent TEXT,
    
    -- æ—¶é—´æ§åˆ¶
    expires_at TIMESTAMP NOT NULL,
    refresh_expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- ä¼šè¯çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE,
    logout_reason VARCHAR(50) -- manual, expired, force_logout
);

-- ç´¢å¼•
CREATE INDEX idx_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_sessions_token_hash ON user_sessions(token_hash);
CREATE INDEX idx_sessions_expires ON user_sessions(expires_at) WHERE is_active = TRUE;
CREATE INDEX idx_sessions_device_info ON user_sessions USING gin(device_info);
```

### 3. user_bookmarks - ç”¨æˆ·æ”¶è—è¡¨

```sql
CREATE TABLE user_bookmarks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- æ”¶è—å†…å®¹ï¼ˆæ–‡ç« é€šè¿‡slugæ ‡è¯†ï¼‰
    article_slug VARCHAR(200) NOT NULL, -- æ–‡ç« slugï¼Œå¯¹åº”Strapiä¸­çš„æ–‡ç« 
    
    -- å†—ä½™å­˜å‚¨ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
    article_data JSONB, -- å†—ä½™å­˜å‚¨æ–‡ç« åŸºæœ¬ä¿¡æ¯ {title, excerpt, cover_image, tags}
    
    -- æ”¶è—ä¿¡æ¯
    bookmark_note TEXT, -- ç”¨æˆ·æ·»åŠ çš„æ”¶è—å¤‡æ³¨
    is_public BOOLEAN DEFAULT FALSE, -- æ˜¯å¦å…¬å¼€æ­¤æ”¶è—
    
    -- åˆ†ç±»ç®¡ç†
    collection_name VARCHAR(100) DEFAULT 'default', -- æ”¶è—å¤¹åç§°
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å”¯ä¸€çº¦æŸå’Œç´¢å¼•
CREATE UNIQUE INDEX idx_bookmarks_user_article ON user_bookmarks(user_id, article_slug);
CREATE INDEX idx_bookmarks_user_collection ON user_bookmarks(user_id, collection_name);
CREATE INDEX idx_bookmarks_article_data ON user_bookmarks USING gin(article_data);
CREATE INDEX idx_bookmarks_created_at ON user_bookmarks(created_at);
```

---

## ğŸ’ ä¼šå‘˜è®¢é˜…æ¨¡å—

### 4. user_subscriptions - ä¼šå‘˜è®¢é˜…è®°å½•

```sql
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- è®¢é˜…ä¿¡æ¯
    plan_type VARCHAR(20) NOT NULL CHECK (plan_type IN ('monthly', 'yearly')),
    plan_name VARCHAR(100) NOT NULL, -- å¥—é¤æ˜¾ç¤ºåç§°
    original_price DECIMAL(10,2) NOT NULL, -- åŸä»·
    paid_price DECIMAL(10,2) NOT NULL, -- å®ä»˜ä»·æ ¼
    currency VARCHAR(3) DEFAULT 'CNY',
    
    -- æ—¶é—´èŒƒå›´
    started_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    
    -- è®¢é˜…çŠ¶æ€
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'expired', 'cancelled', 'suspended')),
    auto_renew BOOLEAN DEFAULT TRUE,
    
    -- å…³è”è®¢å•
    order_id UUID, -- å…³è”ordersè¡¨
    
    -- ä¼˜æƒ ä¿¡æ¯ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    discount_info JSONB, -- ä¼˜æƒ è¯¦æƒ… {coupon_code, discount_amount, discount_type}
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP,
    cancel_reason TEXT
);

-- ç´¢å¼•
CREATE INDEX idx_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_subscriptions_status_expires ON user_subscriptions(status, expires_at);
CREATE INDEX idx_subscriptions_order_id ON user_subscriptions(order_id);
CREATE INDEX idx_subscriptions_discount_info ON user_subscriptions USING gin(discount_info);
```

### 5. orders - è®¢å•è®°å½•è¡¨

```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(50) UNIQUE NOT NULL, -- è®¢å•å·ï¼šORD20241201001
    user_id UUID REFERENCES users(id),
    
    -- è®¢å•å†…å®¹ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    order_items JSONB NOT NULL, -- è®¢å•é¡¹ç›®è¯¦æƒ…
    order_metadata JSONB DEFAULT '{}', -- è®¢å•å…ƒæ•°æ®
    
    -- é‡‘é¢ä¿¡æ¯
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    final_amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    
    -- ä¼˜æƒ ä¿¡æ¯ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    promotions JSONB DEFAULT '[]', -- åº”ç”¨çš„ä¼˜æƒ æ´»åŠ¨åˆ—è¡¨
    
    -- è®¢å•çŠ¶æ€
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'cancelled', 'refunded', 'expired')),
    
    -- æ”¯ä»˜ä¿¡æ¯
    payment_method VARCHAR(20), -- alipay, wechat, unionpay
    paid_at TIMESTAMP,
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP, -- è®¢å•è¿‡æœŸæ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
    
    -- é™„åŠ ä¿¡æ¯
    notes TEXT
);

-- ç´¢å¼•
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_number ON orders(order_number);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_expires_at ON orders(expires_at) WHERE status = 'pending';
CREATE INDEX idx_orders_items ON orders USING gin(order_items);
```

---

## ğŸ’° è´¢åŠ¡ç®¡ç†æ¨¡å—

### 6. user_balance - ç”¨æˆ·ä½™é¢è¡¨

```sql
CREATE TABLE user_balance (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- ä½™é¢ä¿¡æ¯
    available_balance DECIMAL(10,2) DEFAULT 0.00,    -- å¯ç”¨ä½™é¢
    frozen_balance DECIMAL(10,2) DEFAULT 0.00,       -- å†»ç»“ä½™é¢
    total_income DECIMAL(10,2) DEFAULT 0.00,         -- ç´¯è®¡æ”¶å…¥
    total_withdraw DECIMAL(10,2) DEFAULT 0.00,       -- ç´¯è®¡æç°
    
    -- ç‰ˆæœ¬æ§åˆ¶ï¼ˆä¹è§‚é”ï¼‰
    version INTEGER DEFAULT 1,
    
    -- æ—¶é—´æˆ³
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_balance_positive CHECK (available_balance >= 0),
    CONSTRAINT check_frozen_positive CHECK (frozen_balance >= 0),
    CONSTRAINT unique_user_balance UNIQUE (user_id)
);

-- ç´¢å¼•
CREATE INDEX idx_user_balance_user_id ON user_balance(user_id);
```

### 7. withdraws - æç°è®°å½•è¡¨

```sql
CREATE TABLE withdraws (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- æç°ä¿¡æ¯
    amount DECIMAL(10,2) NOT NULL,                   -- æç°é‡‘é¢
    service_fee DECIMAL(10,2) DEFAULT 0.00,          -- æ‰‹ç»­è´¹
    actual_amount DECIMAL(10,2) NOT NULL,            -- å®é™…åˆ°è´¦é‡‘é¢
    
    -- é“¶è¡Œä¿¡æ¯ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    bank_info JSONB NOT NULL, -- {account_number, bank_name, account_holder, branch}
    
    -- æç°çŠ¶æ€
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'rejected')),
    
    -- å¤„ç†ä¿¡æ¯
    admin_note TEXT,                                 -- ç®¡ç†å‘˜å¤‡æ³¨
    processed_at TIMESTAMP,                         -- å¤„ç†æ—¶é—´
    processed_by UUID REFERENCES users(id),         -- å¤„ç†äºº
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_withdraw_amount_positive CHECK (amount > 0)
);

-- ç´¢å¼•
CREATE INDEX idx_withdraws_user_id ON withdraws(user_id);
CREATE INDEX idx_withdraws_status ON withdraws(status);
CREATE INDEX idx_withdraws_bank_info ON withdraws USING gin(bank_info);
```

### 8. income_records - æ”¶å…¥è®°å½•è¡¨

```sql
CREATE TABLE income_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- æ”¶å…¥ä¿¡æ¯
    source_type VARCHAR(20) NOT NULL CHECK (source_type IN ('invite_reward', 'membership_commission', 'referral_bonus', 'other')),
    source_id UUID,                                  -- æ¥æºID(é‚€è¯·è®°å½•IDç­‰)
    amount DECIMAL(10,2) NOT NULL,                   -- æ”¶å…¥é‡‘é¢
    commission_rate DECIMAL(5,2),                    -- ä½£é‡‘æ¯”ä¾‹
    
    -- æ”¶å…¥è¯¦æƒ…ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    income_details JSONB, -- æ”¶å…¥è¯¦ç»†ä¿¡æ¯ {description, calculation, related_order}
    
    -- æ”¶å…¥çŠ¶æ€
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'settled', 'cancelled')),
    settled_at TIMESTAMP,                           -- ç»“ç®—æ—¶é—´
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_income_amount_positive CHECK (amount > 0)
);

-- ç´¢å¼•
CREATE INDEX idx_income_records_user_id ON income_records(user_id);
CREATE INDEX idx_income_records_source ON income_records(source_type, source_id);
CREATE INDEX idx_income_records_details ON income_records USING gin(income_details);
```

---

## ğŸª è¥é”€æ¨å¹¿æ¨¡å—

### 9. invite_records - é‚€è¯·è®°å½•è¡¨

```sql
CREATE TABLE invite_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inviter_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- é‚€è¯·äºº
    invitee_id UUID REFERENCES users(id) ON DELETE SET NULL,          -- è¢«é‚€è¯·äºº
    
    -- é‚€è¯·ä¿¡æ¯
    invite_code VARCHAR(20) NOT NULL UNIQUE,                 -- é‚€è¯·ç 
    contact_info JSONB, -- è”ç³»ä¿¡æ¯ {email, phone, social_media}
    
    -- é‚€è¯·çŠ¶æ€
    status VARCHAR(20) DEFAULT 'sent' CHECK (status IN ('sent', 'registered', 'activated', 'rewarded')),
    
    -- å¥–åŠ±ä¿¡æ¯ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    reward_config JSONB, -- å¥–åŠ±é…ç½® {amount, conditions, tier}
    reward_paid BOOLEAN DEFAULT FALSE,                -- å¥–åŠ±æ˜¯å¦å·²å‘æ”¾
    
    -- æ—¶é—´è®°å½•
    registered_at TIMESTAMP,                         -- æ³¨å†Œæ—¶é—´
    first_purchase_at TIMESTAMP,                     -- é¦–æ¬¡è´­ä¹°æ—¶é—´
    reward_paid_at TIMESTAMP,                        -- å¥–åŠ±å‘æ”¾æ—¶é—´
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_invite_records_inviter ON invite_records(inviter_id);
CREATE INDEX idx_invite_records_code ON invite_records(invite_code);
CREATE INDEX idx_invite_records_contact ON invite_records USING gin(contact_info);
```

### 10. marketing_activities - è¥é”€æ´»åŠ¨è¡¨

```sql
CREATE TABLE marketing_activities (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- æ´»åŠ¨åŸºæœ¬ä¿¡æ¯
    name VARCHAR(200) NOT NULL,                      -- æ´»åŠ¨åç§°
    type VARCHAR(50) NOT NULL CHECK (type IN ('countdown_sale', 'invite_campaign', 'new_user_bonus', 'loyalty_program')),
    description TEXT,                                -- æ´»åŠ¨æè¿°
    
    -- æ´»åŠ¨é…ç½®ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    activity_config JSONB NOT NULL, -- æ´»åŠ¨é…ç½® {rules, rewards, conditions, ui_settings}
    target_audience JSONB, -- ç›®æ ‡ç”¨æˆ·ç¾¤ä½“ {user_levels, geographic, behavioral}
    
    -- æ´»åŠ¨çŠ¶æ€
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'paused', 'completed', 'cancelled')),
    
    -- æ—¶é—´æ§åˆ¶
    start_date TIMESTAMP,                            -- å¼€å§‹æ—¶é—´
    end_date TIMESTAMP,                              -- ç»“æŸæ—¶é—´
    
    -- é¢„ç®—å’Œç»Ÿè®¡
    budget DECIMAL(10,2),                            -- é¢„ç®—
    actual_cost DECIMAL(10,2) DEFAULT 0,             -- å®é™…èŠ±è´¹
    
    -- æ•ˆæœç»Ÿè®¡ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    performance_metrics JSONB DEFAULT '{}', -- æ•ˆæœæŒ‡æ ‡ {participants, conversions, roi}
    
    -- ç®¡ç†ä¿¡æ¯
    created_by UUID REFERENCES users(id),         -- åˆ›å»ºäºº
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_marketing_activities_status ON marketing_activities(status, start_date, end_date);
CREATE INDEX idx_marketing_activities_type ON marketing_activities(type);
CREATE INDEX idx_marketing_activities_config ON marketing_activities USING gin(activity_config);
CREATE INDEX idx_marketing_activities_audience ON marketing_activities USING gin(target_audience);
```

---

## ğŸ“Š ç»Ÿè®¡åˆ†ææ¨¡å—

### 11. article_statistics - æ–‡ç« ç»Ÿè®¡è¡¨

```sql
CREATE TABLE article_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    article_slug VARCHAR(200) UNIQUE NOT NULL,
    
    -- åŸºç¡€ç»Ÿè®¡
    view_count INTEGER DEFAULT 0,
    unique_view_count INTEGER DEFAULT 0, -- å»é‡è®¿é—®
    bookmark_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,
    
    -- é˜…è¯»è´¨é‡æŒ‡æ ‡
    avg_reading_time INTEGER DEFAULT 0, -- å¹³å‡é˜…è¯»æ—¶é•¿ï¼ˆç§’ï¼‰
    completion_rate DECIMAL(5,2) DEFAULT 0, -- å®Œæˆç‡ç™¾åˆ†æ¯”
    bounce_rate DECIMAL(5,2) DEFAULT 0, -- è·³å‡ºç‡
    
    -- SEOç›¸å…³ç»Ÿè®¡ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    seo_metrics JSONB DEFAULT '{}', -- SEOæŒ‡æ ‡ {impressions, clicks, position, ctr}
    
    -- æ¥æºç»Ÿè®¡ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    traffic_sources JSONB DEFAULT '{}', -- æµé‡æ¥æº {direct, search, social, referral}
    
    -- æ—¶é—´ç»Ÿè®¡
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_article_stats_slug ON article_statistics(article_slug);
CREATE INDEX idx_article_stats_views ON article_statistics(view_count DESC);
CREATE INDEX idx_article_stats_seo ON article_statistics USING gin(seo_metrics);
CREATE INDEX idx_article_stats_traffic ON article_statistics USING gin(traffic_sources);
```

### 12. analytics_events - åˆ†æäº‹ä»¶è¡¨

```sql
CREATE TABLE analytics_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ç”¨æˆ·å’Œä¼šè¯
    user_id UUID REFERENCES users(id),            -- ç”¨æˆ·ID(å¯ä¸ºç©ºï¼Œæ”¯æŒåŒ¿åäº‹ä»¶)
    session_id VARCHAR(100),                         -- ä¼šè¯ID
    
    -- äº‹ä»¶ä¿¡æ¯
    event_type VARCHAR(50) NOT NULL,                 -- äº‹ä»¶ç±»å‹
    event_name VARCHAR(100) NOT NULL,                -- äº‹ä»¶åç§°
    
    -- äº‹ä»¶å±æ€§ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    event_properties JSONB DEFAULT '{}', -- äº‹ä»¶å±æ€§ {page, action, value, category}
    user_properties JSONB DEFAULT '{}', -- ç”¨æˆ·å±æ€§ {device, location, preferences}
    
    -- é¡µé¢ä¿¡æ¯
    page_url VARCHAR(500),                           -- é¡µé¢URL
    referrer VARCHAR(500),                           -- æ¥æºé¡µé¢
    
    -- æŠ€æœ¯ä¿¡æ¯
    user_agent TEXT,                                 -- ç”¨æˆ·ä»£ç†
    ip_address INET,                                 -- IPåœ°å€
    
    -- åœ°ç†ä¿¡æ¯ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    geo_info JSONB, -- åœ°ç†ä¿¡æ¯ {country, city, region, timezone}
    
    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE analytics_events_y2024m01 PARTITION OF analytics_events
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- ç´¢å¼•
CREATE INDEX idx_analytics_events_user ON analytics_events(user_id, created_at);
CREATE INDEX idx_analytics_events_type ON analytics_events(event_type, event_name, created_at);
CREATE INDEX idx_analytics_events_session ON analytics_events(session_id, created_at);
CREATE INDEX idx_analytics_events_properties ON analytics_events USING gin(event_properties);
CREATE INDEX idx_analytics_events_geo ON analytics_events USING gin(geo_info);
```

---

## âš™ï¸ ç³»ç»Ÿé…ç½®æ¨¡å—

### 13. site_configs - ç½‘ç«™é…ç½®è¡¨

```sql
CREATE TABLE site_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) NOT NULL UNIQUE,         -- é…ç½®é”®
    config_value JSONB,                              -- é…ç½®å€¼ï¼ˆJSONBä¼˜åŠ¿ï¼‰
    data_type VARCHAR(20) DEFAULT 'string' CHECK (data_type IN ('string', 'number', 'boolean', 'json', 'array')),
    category VARCHAR(50),                            -- é…ç½®åˆ†ç±»
    description TEXT,                                -- é…ç½®æè¿°
    is_public BOOLEAN DEFAULT FALSE,                 -- æ˜¯å¦å…¬å¼€(å‰ç«¯å¯è®¿é—®)
    is_encrypted BOOLEAN DEFAULT FALSE,              -- æ˜¯å¦åŠ å¯†å­˜å‚¨
    updated_by UUID REFERENCES users(id),         -- æ›´æ–°äºº
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_site_configs_category ON site_configs(category, is_public);
CREATE INDEX idx_site_configs_key ON site_configs(config_key);
```

---

## ğŸ›¡ï¸ æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•ç­–ç•¥

```sql
-- å¤åˆç´¢å¼•
CREATE INDEX idx_users_membership_active ON users(membership_level, membership_expire_at) 
WHERE deleted_at IS NULL AND membership_expire_at > CURRENT_TIMESTAMP;

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_orders_pending ON orders(created_at, expires_at) 
WHERE status = 'pending';

-- JSONBå­—æ®µç´¢å¼•
CREATE INDEX idx_activities_config_type ON marketing_activities 
USING gin((activity_config->>'type')) 
WHERE status = 'active';

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_articles_fulltext ON articles 
USING gin(to_tsvector('chinese', title || ' ' || content));
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```sql
-- ç”¨æˆ·dashboardæŸ¥è¯¢ä¼˜åŒ–
CREATE MATERIALIZED VIEW user_dashboard_stats AS
SELECT 
    u.id,
    u.nickname,
    u.membership_level,
    u.membership_expire_at,
    COUNT(DISTINCT ub.id) as bookmark_count,
    COUNT(DISTINCT urh.id) as articles_read,
    COALESCE(SUM(urh.reading_time), 0) as total_reading_time,
    ub_recent.recent_bookmarks,
    (SELECT available_balance FROM user_balance WHERE user_id = u.id) as balance
FROM users u
LEFT JOIN user_bookmarks ub ON u.id = ub.user_id
LEFT JOIN user_reading_history urh ON u.id = urh.user_id
LEFT JOIN LATERAL (
    SELECT jsonb_agg(jsonb_build_object(
        'slug', article_slug,
        'created_at', created_at,
        'article_data', article_data
    ) ORDER BY created_at DESC) as recent_bookmarks
    FROM user_bookmarks 
    WHERE user_id = u.id 
    LIMIT 5
) ub_recent ON true
WHERE u.deleted_at IS NULL
GROUP BY u.id, u.nickname, u.membership_level, u.membership_expire_at, ub_recent.recent_bookmarks;

-- åˆ›å»ºå”¯ä¸€ç´¢å¼•æ”¯æŒå¹¶å‘åˆ·æ–°
CREATE UNIQUE INDEX idx_user_dashboard_stats_id ON user_dashboard_stats(id);

-- è‡ªåŠ¨åˆ·æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION refresh_user_dashboard_stats()
RETURNS trigger AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY user_dashboard_stats;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- åœ¨ç›¸å…³è¡¨æ›´æ–°æ—¶åˆ·æ–°ç‰©åŒ–è§†å›¾
CREATE TRIGGER refresh_dashboard_on_bookmark_change
    AFTER INSERT OR UPDATE OR DELETE ON user_bookmarks
    FOR EACH STATEMENT EXECUTE FUNCTION refresh_user_dashboard_stats();
```

### 3. æ•°æ®å½’æ¡£ç­–ç•¥

```sql
-- å½’æ¡£æ—§çš„åˆ†æäº‹ä»¶æ•°æ®ï¼ˆè¶…è¿‡6ä¸ªæœˆï¼‰
CREATE TABLE analytics_events_archive (LIKE analytics_events INCLUDING ALL);

-- å®šæœŸå½’æ¡£ä»»åŠ¡
CREATE OR REPLACE FUNCTION archive_old_analytics()
RETURNS void AS $$
BEGIN
    WITH moved_rows AS (
        DELETE FROM analytics_events 
        WHERE created_at < CURRENT_DATE - INTERVAL '6 months'
        RETURNING *
    )
    INSERT INTO analytics_events_archive SELECT * FROM moved_rows;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®šæœŸä»»åŠ¡ï¼ˆéœ€è¦pg_cronæ‰©å±•ï¼‰
SELECT cron.schedule('archive-analytics', '0 2 1 * *', 'SELECT archive_old_analytics();');
```

---

## ğŸ”’ æ•°æ®å®‰å…¨å’Œæƒé™

### 1. è¡Œçº§å®‰å…¨(RLS)

```sql
-- å¯ç”¨ç”¨æˆ·è¡¨çš„è¡Œçº§å®‰å…¨
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
CREATE POLICY user_self_access ON users
    FOR ALL USING (id = current_setting('app.user_id')::uuid);

-- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®
CREATE POLICY admin_all_access ON users
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE id = current_setting('app.user_id')::uuid 
            AND 'admin' = ANY(permissions)
        )
    );

-- ç”¨æˆ·ä½™é¢è¡¨çš„è¡Œçº§å®‰å…¨
ALTER TABLE user_balance ENABLE ROW LEVEL SECURITY;

CREATE POLICY user_balance_self_access ON user_balance
    FOR ALL USING (user_id = current_setting('app.user_id')::uuid);
```

### 2. æ•æ„Ÿæ•°æ®åŠ å¯†

```sql
-- åˆ›å»ºåŠ å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data text)
RETURNS text AS $$
BEGIN
    RETURN encode(encrypt(data::bytea, current_setting('app.encryption_key'), 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§£å¯†å‡½æ•°
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data text)
RETURNS text AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_data, 'base64'), current_setting('app.encryption_key'), 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql;

-- é“¶è¡Œä¿¡æ¯åŠ å¯†å­˜å‚¨è§¦å‘å™¨
CREATE OR REPLACE FUNCTION encrypt_bank_info()
RETURNS trigger AS $$
BEGIN
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        -- åŠ å¯†é“¶è¡Œè´¦å·
        IF NEW.bank_info->>'account_number' IS NOT NULL THEN
            NEW.bank_info = jsonb_set(
                NEW.bank_info,
                '{account_number_encrypted}',
                to_jsonb(encrypt_sensitive_data(NEW.bank_info->>'account_number'))
            );
            NEW.bank_info = NEW.bank_info - 'account_number';
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER encrypt_withdraw_bank_info
    BEFORE INSERT OR UPDATE ON withdraws
    FOR EACH ROW EXECUTE FUNCTION encrypt_bank_info();
```

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§å’Œç»´æŠ¤

### 1. æ€§èƒ½ç›‘æ§è§†å›¾

```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§
CREATE VIEW slow_queries AS
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    stddev_time,
    min_time,
    max_time,
    rows
FROM pg_stat_statements 
WHERE mean_time > 100 -- å¹³å‡æ‰§è¡Œæ—¶é—´è¶…è¿‡100ms
ORDER BY mean_time DESC;

-- è¡¨å¤§å°ç›‘æ§
CREATE VIEW table_sizes AS
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as bytes
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY bytes DESC;

-- ç´¢å¼•ä½¿ç”¨æƒ…å†µç›‘æ§
CREATE VIEW index_usage AS
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_tup_read,
    idx_tup_fetch,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes 
ORDER BY idx_scan DESC;
```

### 2. è‡ªåŠ¨ç»´æŠ¤ä»»åŠ¡

```sql
-- å®šæœŸæ›´æ–°æ–‡ç« ç»Ÿè®¡
CREATE OR REPLACE FUNCTION update_article_statistics()
RETURNS void AS $$
BEGIN
    -- æ›´æ–°æ–‡ç« ç»Ÿè®¡
    INSERT INTO article_statistics (
        article_slug, 
        view_count, 
        unique_view_count, 
        bookmark_count,
        avg_reading_time,
        completion_rate
    )
    SELECT 
        ae.event_properties->>'article_slug' as article_slug,
        COUNT(*) as view_count,
        COUNT(DISTINCT ae.user_id) as unique_view_count,
        (SELECT COUNT(*) FROM user_bookmarks ub WHERE ub.article_slug = ae.event_properties->>'article_slug') as bookmark_count,
        AVG((ae.event_properties->>'reading_time')::integer) as avg_reading_time,
        AVG(CASE WHEN ae.event_properties->>'completed' = 'true' THEN 100.0 ELSE 0.0 END) as completion_rate
    FROM analytics_events ae
    WHERE ae.event_type = 'article_read'
        AND ae.created_at >= CURRENT_DATE - INTERVAL '1 day'
        AND ae.event_properties->>'article_slug' IS NOT NULL
    GROUP BY ae.event_properties->>'article_slug'
    ON CONFLICT (article_slug) DO UPDATE SET
        view_count = article_statistics.view_count + EXCLUDED.view_count,
        unique_view_count = EXCLUDED.unique_view_count,
        bookmark_count = EXCLUDED.bookmark_count,
        avg_reading_time = EXCLUDED.avg_reading_time,
        completion_rate = EXCLUDED.completion_rate,
        last_updated = CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- å®šæœŸæ‰§è¡Œç»Ÿè®¡æ›´æ–°ï¼ˆéœ€è¦pg_cronæ‰©å±•ï¼‰
SELECT cron.schedule('update-article-stats', '0 */6 * * *', 'SELECT update_article_statistics();');
```

---

## ğŸš€ éƒ¨ç½²å’Œè¿ç§»

### 1. æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

```sql
-- init.sql
-- 1. åˆ›å»ºæ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

-- 2. åˆ›å»ºè‡ªå®šä¹‰ç±»å‹
CREATE TYPE user_role AS ENUM ('user', 'editor', 'admin');
CREATE TYPE subscription_status AS ENUM ('active', 'expired', 'cancelled', 'suspended');
CREATE TYPE order_status AS ENUM ('pending', 'paid', 'cancelled', 'refunded', 'expired');

-- 3. åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER aibianx_app WITH PASSWORD 'your_secure_password';
GRANT CONNECT ON DATABASE aibianx_prod TO aibianx_app;
GRANT USAGE ON SCHEMA public TO aibianx_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO aibianx_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO aibianx_app;

-- 4. è®¾ç½®é»˜è®¤æƒé™
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO aibianx_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO aibianx_app;
```

### 2. è¿ç§»ç‰ˆæœ¬ç®¡ç†

```sql
-- migrations/001_initial_schema.sql
-- migrations/002_add_jsonb_indexes.sql  
-- migrations/003_create_materialized_views.sql
-- migrations/004_add_rls_policies.sql

-- è¿ç§»çŠ¶æ€è·Ÿè¸ªè¡¨
CREATE TABLE schema_migrations (
    version VARCHAR(255) PRIMARY KEY,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description TEXT
);
```

---

## ğŸ“š æ€»ç»“

### ğŸ¯ PostgreSQLè®¾è®¡ä¼˜åŠ¿

1. **JSONBå­—æ®µ**ï¼šå®Œç¾æ”¯æŒå¤æ‚çš„é…ç½®æ•°æ®ã€ç”¨æˆ·åå¥½ã€äº‹ä»¶å±æ€§ç­‰
2. **æ•°ç»„ç±»å‹**ï¼šç®€åŒ–æƒé™ç®¡ç†ã€æ ‡ç­¾ç³»ç»Ÿã€å¤šå€¼å­—æ®µå­˜å‚¨
3. **å…¨æ–‡æœç´¢**ï¼šå†…ç½®ä¸­æ–‡åˆ†è¯ï¼Œæ”¯æŒå¤æ‚çš„å†…å®¹æœç´¢éœ€æ±‚
4. **åˆ†åŒºè¡¨**ï¼šå¤§æ•°æ®é‡çš„åˆ†æäº‹ä»¶è¡¨æŒ‰æœˆåˆ†åŒºï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
5. **ç‰©åŒ–è§†å›¾**ï¼šç”¨æˆ·dashboardç­‰å¤æ‚æŸ¥è¯¢çš„æ€§èƒ½ä¼˜åŒ–
6. **è¡Œçº§å®‰å…¨**ï¼šç»†ç²’åº¦çš„æ•°æ®è®¿é—®æ§åˆ¶
7. **ä¸°å¯Œç´¢å¼•**ï¼šGINç´¢å¼•æ”¯æŒJSONBå’Œæ•°ç»„çš„é«˜æ•ˆæŸ¥è¯¢

### ğŸ”— ä¸å…¶ä»–æ–‡æ¡£çš„å…³ç³»

- **[æŠ€æœ¯æ–¹æ¡ˆæ€»è§ˆæŒ‡å—](./AIå˜ç°ä¹‹è·¯_æŠ€æœ¯æ–¹æ¡ˆæ€»è§ˆæŒ‡å—.md)**ï¼šæœ¬æ–‡æ¡£çš„ä¸Šçº§æ–‡æ¡£ï¼Œè§£é‡Šæ•´ä½“æŠ€æœ¯é€‰å‹
- **[å¼€å‘æ‰§è¡Œæ­¥éª¤è¯¦ç»†æŒ‡å—](./å¼€å‘æ‰§è¡Œæ­¥éª¤è¯¦ç»†æŒ‡å—.md)**ï¼šå…·ä½“çš„å¼€å‘å®æ–½æ­¥éª¤
- **[ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—](./ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—.md)**ï¼šæ•°æ®åº“åœ¨ç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²æ–¹æ¡ˆ

### ğŸ’¡ ä¸‹ä¸€æ­¥å®æ–½

1. **æ ¹æ®æœ¬è®¾è®¡åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„**
2. **é…ç½®Strapiä»¥ä½¿ç”¨PostgreSQL**
3. **å®ç°æ•°æ®è¿ç§»è„šæœ¬**
4. **å»ºç«‹ç›‘æ§å’Œå¤‡ä»½ç­–ç•¥**
5. **ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½å’Œç´¢å¼•ç­–ç•¥**

è¿™ä¸ªPostgreSQLæ•°æ®åº“è®¾è®¡å……åˆ†å‘æŒ¥äº†PostgreSQLçš„æŠ€æœ¯ä¼˜åŠ¿ï¼Œä¸ºAIå˜ç°ä¹‹è·¯é¡¹ç›®æä¾›äº†é«˜æ€§èƒ½ã€å¯æ‰©å±•ã€å®‰å…¨å¯é çš„æ•°æ®åŸºç¡€ã€‚ ğŸ¯ 