# DockeræœåŠ¡åˆ†ç¦»æ¶æ„ç­–ç•¥

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šåŒä¸€æœåŠ¡ç±»å‹ + åŠŸèƒ½åˆ†ç¦» + æ•°æ®æºéš”ç¦»

### ğŸ“‹ å½“å‰æ¶æ„è®¾è®¡ç†å¿µ

#### âœ… **åˆç†çš„æœåŠ¡åˆ†ç¦» (ä¿æŒ)**
```
åŒä¸€æœåŠ¡ç±»å‹ â†’ ä¸åŒåŠŸèƒ½å®ä¾‹ â†’ ç‹¬ç«‹æ•°æ®æº

PostgreSQL {
  â”œâ”€â”€ aibianx-postgres (ç«¯å£5432)     â†’ ä¸»é¡¹ç›®æ•°æ®åº“
  â””â”€â”€ billionmail-postgres (ç«¯å£25432) â†’ é‚®ä»¶ç³»ç»Ÿæ•°æ®åº“
}

Redis {
  â”œâ”€â”€ aibianx-redis (ç«¯å£6379)        â†’ ä¸»é¡¹ç›®ç¼“å­˜
  â””â”€â”€ billionmail-redis (ç«¯å£26379)   â†’ é‚®ä»¶ç³»ç»Ÿç¼“å­˜
}
```

#### âŒ **çœŸæ­£çš„å†—ä½™æœåŠ¡ (éœ€è¦é¿å…)**
```
rspamd {
  â”œâ”€â”€ aibianx-rspamd          â†’ ç»Ÿä¸€éƒ¨ç½² (å†—ä½™)
  â””â”€â”€ billionmail-rspamd      â†’ BillionMailéƒ¨ç½² (ä¿ç•™)
}
```

### ğŸ›¡ï¸ **é•¿æœŸä¿è¯ç­–ç•¥**

#### 1. **é…ç½®æ–‡ä»¶çº§åˆ«çš„ä¿è¯**

**ä¿®æ”¹ç»Ÿä¸€éƒ¨ç½²é…ç½®ï¼Œæ˜ç¡®æœåŠ¡èŒè´£åˆ†å·¥ï¼š**

```yaml
# deployment/docker-compose.unified.yml
services:
  # ===== ä¸»é¡¹ç›®ä¸“ç”¨æœåŠ¡ =====
  postgres:
    container_name: aibianx-postgres
    # ä¸“ç”¨äºä¸»é¡¹ç›®æ•°æ®åº“
    
  redis:
    container_name: aibianx-redis
    # ä¸“ç”¨äºä¸»é¡¹ç›®ç¼“å­˜
    
  meilisearch:
    container_name: aibianx-meilisearch
    # ä¸“ç”¨äºä¸»é¡¹ç›®æœç´¢
    
  # ===== ç§»é™¤é‚®ä»¶ç›¸å…³æœåŠ¡ =====
  # rspamd: # å·²æ³¨é‡Šï¼Œä½¿ç”¨BillionMailçš„
  # dovecot: # å·²æ³¨é‡Šï¼Œä½¿ç”¨BillionMailçš„
  # postfix: # å·²æ³¨é‡Šï¼Œä½¿ç”¨BillionMailçš„
```

#### 2. **å¯åŠ¨è„šæœ¬çº§åˆ«çš„ä¿è¯**

**ä¿®æ”¹å¯åŠ¨é€»è¾‘ï¼Œé¿å…é‡å¤éƒ¨ç½²ï¼š**

```bash
# scripts/deployment/start-dev.sh
deploy_infrastructure() {
    echo "ğŸ”µ å¯åŠ¨ä¸»é¡¹ç›®åŸºç¡€è®¾æ–½..."
    
    # åªå¯åŠ¨ä¸»é¡¹ç›®éœ€è¦çš„æœåŠ¡
    docker-compose -f docker-compose.unified.yml up -d \
        postgres redis meilisearch
    
    # è·³è¿‡é‚®ä»¶æœåŠ¡ (ä½¿ç”¨BillionMailç‹¬ç«‹éƒ¨ç½²)
    echo "ğŸ“§ é‚®ä»¶æœåŠ¡ç”±BillionMailç‹¬ç«‹ç®¡ç†"
}
```

#### 3. **ç¯å¢ƒæ£€æŸ¥çº§åˆ«çš„ä¿è¯**

**æ·»åŠ å¯åŠ¨å‰æ£€æŸ¥ï¼Œé˜²æ­¢å†²çªï¼š**

```bash
check_service_conflicts() {
    echo "ğŸ” æ£€æŸ¥æœåŠ¡å†²çª..."
    
    # æ£€æŸ¥PostgreSQLå†²çª
    local postgres_count=$(docker ps | grep postgres | wc -l)
    if [ "$postgres_count" -gt 2 ]; then
        echo "âš ï¸ å‘ç°è¶…è¿‡2ä¸ªPostgreSQLæœåŠ¡ï¼Œå¯èƒ½æœ‰å†²çª"
        return 1
    fi
    
    # æ£€æŸ¥rspamdå†²çª
    local rspamd_count=$(docker ps | grep rspamd | wc -l)
    if [ "$rspamd_count" -gt 1 ]; then
        echo "âš ï¸ å‘ç°å¤šä¸ªrspamdæœåŠ¡ï¼Œåœæ­¢é‡å¤çš„"
        docker-compose -f docker-compose.unified.yml stop rspamd
    fi
}
```

### ğŸ“‹ **æœåŠ¡èŒè´£çŸ©é˜µ**

| æœåŠ¡ç±»å‹ | ä¸»é¡¹ç›®å®ä¾‹ | é‚®ä»¶ç³»ç»Ÿå®ä¾‹ | èŒè´£åˆ†å·¥ |
|---------|------------|--------------|----------|
| **PostgreSQL** | âœ… aibianx-postgres | âœ… billionmail-postgres | æ•°æ®å®Œå…¨éš”ç¦» |
| **Redis** | âœ… aibianx-redis | âœ… billionmail-redis | ç¼“å­˜å®Œå…¨éš”ç¦» |
| **rspamd** | âŒ ä¸éƒ¨ç½² | âœ… billionmail-rspamd | ç»Ÿä¸€ä½¿ç”¨é‚®ä»¶ç³»ç»Ÿçš„ |
| **postfix** | âŒ ä¸éƒ¨ç½² | âœ… billionmail-postfix | ç»Ÿä¸€ä½¿ç”¨é‚®ä»¶ç³»ç»Ÿçš„ |
| **dovecot** | âŒ ä¸éƒ¨ç½² | âœ… billionmail-dovecot | ç»Ÿä¸€ä½¿ç”¨é‚®ä»¶ç³»ç»Ÿçš„ |

### ğŸ¯ **å®æ–½æ­¥éª¤**

#### é˜¶æ®µ1ï¼šé…ç½®æ–‡ä»¶ä¿®æ”¹
- [ ] ä¿®æ”¹ `docker-compose.unified.yml`
- [ ] æ³¨é‡Šæ‰é‚®ä»¶ç›¸å…³æœåŠ¡
- [ ] æ˜ç¡®ä¸»é¡¹ç›®æœåŠ¡èŒƒå›´

#### é˜¶æ®µ2ï¼šå¯åŠ¨è„šæœ¬ä¼˜åŒ–
- [ ] ä¿®æ”¹ `start-dev.sh`
- [ ] æ·»åŠ å†²çªæ£€æŸ¥é€»è¾‘
- [ ] ä¼˜åŒ–æœåŠ¡å¯åŠ¨é¡ºåº

#### é˜¶æ®µ3ï¼šæ–‡æ¡£å’Œç›‘æ§
- [ ] æ›´æ–°æ¶æ„æ–‡æ¡£
- [ ] æ·»åŠ æœåŠ¡ç›‘æ§è„šæœ¬
- [ ] åˆ›å»ºæ•…éšœæ¢å¤æŒ‡å—

### ğŸ’¡ **æ ¸å¿ƒä»·å€¼è§‚**

1. **åŠŸèƒ½åˆ†ç¦»ä¼˜äºèµ„æºèŠ‚çº¦** - ä¸åŒåŠŸèƒ½ç”¨ä¸åŒå®ä¾‹
2. **æ•°æ®éš”ç¦»ä¼˜äºç»Ÿä¸€ç®¡ç†** - å…³é”®æ•°æ®å®Œå…¨åˆ†ç¦»
3. **æ¸…æ™°èŒè´£ä¼˜äºå¤æ‚ä¼˜åŒ–** - æ¯ä¸ªæœåŠ¡èŒè´£æ˜ç¡®
4. **æ•…éšœéš”ç¦»ä¼˜äºç³»ç»Ÿè€¦åˆ** - ä¸€ä¸ªæ•…éšœä¸å½±å“å¦ä¸€ä¸ª

### ğŸš¨ **çº¢çº¿åŸåˆ™**

âŒ **ç»å¯¹ä¸èƒ½åšçš„ï¼š**
- è®©ä¸»é¡¹ç›®å’Œé‚®ä»¶ç³»ç»Ÿå…±äº«æ•°æ®åº“
- è®©ä¸»é¡¹ç›®å’Œé‚®ä»¶ç³»ç»Ÿå…±äº«ç¼“å­˜
- è®©å…³é”®ä¸šåŠ¡æ•°æ®äº¤å‰ä¾èµ–

âœ… **å¿…é¡»ä¿æŒçš„ï¼š**
- æ•°æ®åº“å®Œå…¨åˆ†ç¦»
- ç¼“å­˜å®Œå…¨åˆ†ç¦»  
- åŠŸèƒ½æ¨¡å—ç‹¬ç«‹éƒ¨ç½²
- æ•…éšœå½±å“éš”ç¦»