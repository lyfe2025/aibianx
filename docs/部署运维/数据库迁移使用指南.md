# æ•°æ®åº“è¿ç§»ä½¿ç”¨æŒ‡å—

> ğŸ—„ï¸ **AIå˜ç°ä¹‹è·¯é¡¹ç›®æ•°æ®åº“è¿ç§»è„šæœ¬ä½¿ç”¨è¯´æ˜**

## ğŸ“š æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•ä½¿ç”¨é¡¹ç›®ä¸­çš„æ•°æ®åº“è¿ç§»è„šæœ¬ï¼Œè¿™äº›è„šæœ¬ç”¨äºä¸ºæ•°æ®åº“è¡¨å’Œå­—æ®µæ·»åŠ å®Œæ•´çš„ä¸­æ–‡æ³¨é‡Šï¼Œç¡®ä¿Strapiç®¡ç†ç•Œé¢èƒ½å¤Ÿæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡å­—æ®µæè¿°ã€‚

## ğŸ¯ è¿ç§»è„šæœ¬ä½œç”¨

### ğŸ“‹ è¿ç§»æ–‡ä»¶æ¸…å•

é¡¹ç›®åŒ…å«ä»¥ä¸‹4ä¸ªæ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼Œä½äº `backend/database/migrations/` ç›®å½•ï¼š

| æ–‡ä»¶å | å¤§å° | ä½œç”¨æè¿° |
|--------|------|----------|
| `add_missing_table_comments.sql` | 9.7KB | ä¸ºä¸šåŠ¡æ ¸å¿ƒè¡¨æ·»åŠ æ³¨é‡Šï¼ˆcommissions, invitations, orders, payments, refunds, subscriptionsï¼‰ |
| `add_link_table_comments.sql` | 11.5KB | ä¸ºæ‰€æœ‰å…³ç³»è¡¨(_lnk)æ·»åŠ å®Œæ•´æ³¨é‡Š |
| `add_core_table_comments.sql` | 4.3KB | ä¸ºç³»ç»Ÿæ ¸å¿ƒè¡¨æ·»åŠ æ³¨é‡Šï¼ˆfiles, i18n_localeï¼‰ |
| `add_user_table_comments.sql` | 5.0KB | ä¸ºç”¨æˆ·ç›¸å…³è¡¨æ·»åŠ æ³¨é‡Š |

### âœ¨ æ‰§è¡Œåæ•ˆæœ

**æ‰§è¡Œå‰**ï¼šStrapiç®¡ç†ç•Œé¢æ˜¾ç¤ºè‹±æ–‡å­—æ®µå
- `commission_rate` - ç®¡ç†å‘˜ä¸çŸ¥é“å«ä¹‰
- `is_premium` - ä¸æ¸…æ¥šç”¨é€”
- `invitation_code` - å­—æ®µæ„ä¹‰ä¸æ˜

**æ‰§è¡Œå**ï¼šStrapiç®¡ç†ç•Œé¢æ˜¾ç¤ºä¸­æ–‡æè¿°
- `ä½£é‡‘æ¯”ä¾‹` - æ˜ç¡®æ˜¯è®¾ç½®ä½£é‡‘ç™¾åˆ†æ¯”
- `æ˜¯å¦ä¼šå‘˜ä¸“äº«` - æ˜ç¡®æ˜¯ä»˜è´¹å†…å®¹æ ‡è®°
- `é‚€è¯·ç ` - æ˜ç¡®æ˜¯ç”¨æˆ·é‚€è¯·åŠŸèƒ½

## ğŸš€ ä½¿ç”¨åœºæ™¯

### 1. æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»º

**é€‚ç”¨æƒ…å†µ**ï¼šæ–°å›¢é˜Ÿæˆå‘˜ç¬¬ä¸€æ¬¡æ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# 1. å¯åŠ¨å¼€å‘ç¯å¢ƒ
./scripts.sh deploy start
# æˆ–
./start-dev.sh

# 2. ç­‰å¾…Strapiåˆ›å»ºåŸºç¡€è¡¨ï¼ˆçº¦30ç§’ï¼‰

# 3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
cd backend
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_missing_table_comments.sql
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_link_table_comments.sql
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_core_table_comments.sql
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_user_table_comments.sql
cd ..

# 4. éªŒè¯æ•ˆæœ
echo "è®¿é—® http://localhost:1337/admin æŸ¥çœ‹ç®¡ç†ç•Œé¢"
```

### 2. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

**é€‚ç”¨æƒ…å†µ**ï¼šéƒ¨ç½²åˆ°æ­£å¼æœåŠ¡å™¨ï¼ˆRailway + Supabaseï¼‰

```bash
# 1. è·å–ç”Ÿäº§æ•°æ®åº“è¿æ¥ä¿¡æ¯
DATABASE_URL="postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres"

# 2. æœ¬åœ°æ‰§è¡Œè¿ç§»ï¼ˆæ¨èï¼‰
cd /path/to/your/project/backend
psql $DATABASE_URL -f database/migrations/add_missing_table_comments.sql
psql $DATABASE_URL -f database/migrations/add_link_table_comments.sql
psql $DATABASE_URL -f database/migrations/add_core_table_comments.sql
psql $DATABASE_URL -f database/migrations/add_user_table_comments.sql

# 3. éªŒè¯ç”Ÿäº§ç¯å¢ƒ
psql $DATABASE_URL -c "
SELECT 
    table_name,
    CASE WHEN obj_description(c.oid) IS NOT NULL THEN 'âœ… æœ‰æ³¨é‡Š' ELSE 'âŒ ç¼ºå°‘æ³¨é‡Š' END as status
FROM information_schema.tables t
LEFT JOIN pg_class c ON c.relname = t.table_name
WHERE t.table_schema = 'public' AND t.table_name IN ('articles', 'commissions', 'orders', 'payments')
ORDER BY t.table_name;
"
```

### 3. å®¢æˆ·éƒ¨ç½²äº¤ä»˜

**é€‚ç”¨æƒ…å†µ**ï¼šä¸ºå®¢æˆ·æä¾›å®Œæ•´çš„éƒ¨ç½²æ–¹æ¡ˆ

```bash
# å®¢æˆ·æ‰§è¡Œçš„å®Œæ•´éƒ¨ç½²æµç¨‹
git clone your-repo
cd project
chmod +x *.sh

# å¯åŠ¨æœåŠ¡
./start-dev.sh

# ç­‰å¾…æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ
sleep 60

# æ‰§è¡Œè¿ç§»è„šæœ¬
cd backend
for sql_file in database/migrations/*.sql; do
    echo "æ‰§è¡Œ: $sql_file"
    psql -U your_db_user -d your_db_name -f "$sql_file"
done
cd ..

echo "âœ… éƒ¨ç½²å®Œæˆï¼Œæ•°æ®åº“å·²æœ‰å®Œæ•´ä¸­æ–‡æ³¨é‡Š"
```

## ğŸ”§ é«˜çº§ä½¿ç”¨

### æ‰¹é‡æ‰§è¡Œè„šæœ¬

åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–æ‰§è¡Œè„šæœ¬ï¼š

```bash
#!/bin/bash
# deploy-migrations.sh

PROJECT_ROOT="/path/to/your/project"
DB_USER="aibianx_dev"
DB_NAME="aibianx_dev"

echo "ğŸš€ å¼€å§‹æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
cd $PROJECT_ROOT/backend

migrations=(
    "add_missing_table_comments.sql"
    "add_link_table_comments.sql" 
    "add_core_table_comments.sql"
    "add_user_table_comments.sql"
)

for i in "${!migrations[@]}"; do
    migration=${migrations[$i]}
    echo "$(($i + 1))/4 æ‰§è¡Œ: $migration"
    
    if psql -U $DB_USER -d $DB_NAME -f "database/migrations/$migration"; then
        echo "âœ… $migration æ‰§è¡ŒæˆåŠŸ"
    else
        echo "âŒ $migration æ‰§è¡Œå¤±è´¥"
        exit 1
    fi
done

echo "ğŸ‰ æ‰€æœ‰è¿ç§»æ‰§è¡Œå®Œæˆï¼"
```

### Railway CLI æ‰§è¡Œ

å¦‚æœä½¿ç”¨Railwayéƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Railway CLIæ‰§è¡Œï¼š

```bash
# 1. ç™»å½•Railway
railway login

# 2. é“¾æ¥é¡¹ç›®
railway link [your-project-id]

# 3. é€šè¿‡Railwayæ‰§è¡Œè¿ç§»
railway run psql $DATABASE_URL -f database/migrations/add_missing_table_comments.sql
railway run psql $DATABASE_URL -f database/migrations/add_link_table_comments.sql
railway run psql $DATABASE_URL -f database/migrations/add_core_table_comments.sql
railway run psql $DATABASE_URL -f database/migrations/add_user_table_comments.sql
```

## âœ… éªŒè¯å’Œæ•…éšœæ’é™¤

### éªŒè¯è¿ç§»ç»“æœ

```sql
-- æ£€æŸ¥è¡¨æ³¨é‡Š
SELECT 
    table_name,
    obj_description(c.oid) as table_comment
FROM information_schema.tables t
LEFT JOIN pg_class c ON c.relname = t.table_name
WHERE t.table_schema = 'public' 
AND t.table_name IN ('commissions', 'orders', 'payments', 'articles')
ORDER BY t.table_name;

-- æ£€æŸ¥å­—æ®µæ³¨é‡Šï¼ˆä»¥commissionsè¡¨ä¸ºä¾‹ï¼‰
SELECT 
    column_name,
    col_description(pgc.oid, ordinal_position) as field_comment
FROM information_schema.columns c
LEFT JOIN pg_class pgc ON pgc.relname = c.table_name
WHERE c.table_name = 'commissions'
ORDER BY c.ordinal_position;
```

### å¸¸è§é—®é¢˜è§£å†³

#### 1. è¿æ¥æ•°æ®åº“å¤±è´¥

```bash
# é”™è¯¯ï¼šconnection refused
# è§£å†³ï¼šæ£€æŸ¥æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ
./scripts.sh tools status
./scripts.sh database check

# é”™è¯¯ï¼šauthentication failed
# è§£å†³ï¼šæ£€æŸ¥ç”¨æˆ·åå¯†ç å’Œæ•°æ®åº“å
echo $DATABASE_URL
```

#### 2. SQLæ‰§è¡ŒæŠ¥é”™

```bash
# é”™è¯¯ï¼štable does not exist
# è§£å†³ï¼šç¡®è®¤Strapiå·²åˆ›å»ºåŸºç¡€è¡¨
# è®¿é—® http://localhost:1337/admin åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦å·

# é”™è¯¯ï¼špermission denied
# è§£å†³ï¼šæ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™
psql -U aibianx_dev -d aibianx_dev -c "\dt"
```

#### 3. æ³¨é‡Šæœªåœ¨Strapiæ˜¾ç¤º

```bash
# è§£å†³æ–¹æ³•1ï¼šé‡å¯StrapiæœåŠ¡
./scripts.sh deploy restart

# è§£å†³æ–¹æ³•2ï¼šæ¸…é™¤Strapiç¼“å­˜
rm -rf backend/.cache
./scripts.sh deploy start

# è§£å†³æ–¹æ³•3ï¼šæ£€æŸ¥å­—æ®µæè¿°é…ç½®
./scripts.sh content-type configure commission
```

## ğŸ“ é‡è¦æé†’

### âš ï¸ æ‰§è¡Œæ—¶æœº

- **é¦–æ¬¡éƒ¨ç½²**ï¼šåœ¨Strapiåˆ›å»ºåŸºç¡€è¡¨**ä¹‹å**æ‰§è¡Œ
- **æ•°æ®è¿ç§»**ï¼šåœ¨æ•°æ®åº“ç»“æ„å˜æ›´**ä¹‹å**æ‰§è¡Œ
- **ç¯å¢ƒå¤åˆ¶**ï¼šæ¯æ¬¡æ–°ç¯å¢ƒæ­å»ºæ—¶éƒ½éœ€è¦æ‰§è¡Œ

### ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

- ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œå‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
- æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯è„šæœ¬æ­£ç¡®æ€§
- æ£€æŸ¥DATABASE_URLç¡®ä¿è¿æ¥åˆ°æ­£ç¡®æ•°æ®åº“

### ğŸ’¡ æœ€ä½³å®è·µ

1. **æŒ‰é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰ç…§æ–‡æ¡£ä¸­çš„é¡ºåºæ‰§è¡Œè¿ç§»æ–‡ä»¶
2. **é€ä¸ªéªŒè¯**ï¼šæ¯ä¸ªæ–‡ä»¶æ‰§è¡Œåæ£€æŸ¥æ˜¯å¦æˆåŠŸ
3. **è®°å½•æ—¥å¿—**ï¼šä¿ç•™æ‰§è¡Œæ—¥å¿—ä¾¿äºæ•…éšœæ’æŸ¥
4. **å›¢é˜Ÿå…±äº«**ï¼šç¡®ä¿å›¢é˜Ÿæˆå‘˜éƒ½äº†è§£è¿ç§»æµç¨‹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—](../ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—.md) - å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹
- [é¡¹ç›®README](../../../README.md) - å¿«é€Ÿå¼€å§‹å’Œæœ¬åœ°å¼€å‘æŒ‡å—
- [å¼€å‘è„šæœ¬ä½¿ç”¨æŒ‡å—](../../../DEV-SCRIPTS.md) - é¡¹ç›®è„šæœ¬è¯¦ç»†è¯´æ˜

---

**ğŸ’¡ å°è´´å£«**ï¼šæ•°æ®åº“è¿ç§»æ˜¯ä¸€æ¬¡æ€§æ“ä½œï¼Œæ‰§è¡ŒæˆåŠŸåæ— éœ€é‡å¤æ‰§è¡Œã€‚å¦‚æœéœ€è¦ä¿®æ”¹æ³¨é‡Šå†…å®¹ï¼Œåº”è¯¥åˆ›å»ºæ–°çš„è¿ç§»æ–‡ä»¶è€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰æ–‡ä»¶ã€‚