# 📦 AI变现之路 - 完整备份与恢复指南

> **更新时间：2025年3月** | **基于Strapi 5.22.0 + PostgreSQL + 71个脚本工具链**

## 🎯 **备份系统概述**

AI变现之路项目采用**智能简化备份策略**，基于Next.js 15.4.2 + Strapi 5.22.0架构，只备份核心数据，让系统自动重建缓存和索引，既保证数据完整性又提升备份效率。

### ✅ **备份内容**

| 类型 | 内容 | 说明 |
|------|------|------|
| **🗄️ PostgreSQL数据库** | Strapi 5.22.0主业务数据库 | 包含文章、用户、分类等16种内容类型数据 |
| **📧 邮件订阅数据** | Strapi集成邮件订阅 | 包含用户邮件订阅、订阅分析数据 |
| **⚙️ 配置文件** | deploy.conf, .env配置 | 系统配置和环境变量（71个脚本自动配置） |
| **📁 上传文件** | 媒体文件、附件 | 用户上传的图片、文档等静态资源 |
| **📦 项目文件** | package.json依赖配置 | 前后端依赖管理配置文件 |

### ❌ **自动重建内容**

| 类型 | 说明 | 重建时机 |
|------|------|----------|
| **Redis缓存** | 会话和临时数据 | 服务启动时自动重建 |
| **MeiliSearch索引** | 全文搜索索引 | 首次访问时自动同步（支持中文分词） |
| **Node依赖** | node_modules | npm install重新安装 |
| **前端构建** | .next目录 | npm run build重新构建 |

---

## 🚀 **快速使用**

### **📦 创建备份**

```bash
# 💡 推荐：创建完整备份（数据库 + 重要文件）
./scripts.sh backup create

# 🎯 或通过交互式菜单
./scripts.sh
# 选择 4) 备份管理
# 选择 2) 创建完整备份
```

### **🔄 恢复备份**

```bash
# 🎯 从最新备份恢复（使用deploy.conf中的BACKUP_VERSION=latest）
./scripts.sh backup restore

# 📋 恢复指定版本
./scripts.sh backup restore 20250806_202417

# 🎯 或通过交互式菜单
./scripts.sh
# 选择 4) 备份管理
# 选择 3) 从备份恢复系统
```

### **📋 查看备份**

```bash
./scripts.sh backup list
```

---

## 📊 **备份管理**

### **🎛️ 交互式菜单**

```bash
./scripts.sh
# 选择 4) 📦 备份管理
```

菜单选项：
- **1) 📋 查看可用备份** - 分类显示所有备份版本
- **2) 📦 创建完整备份** - 备份数据库和重要文件
- **3) 🔄 从备份恢复系统** - 恢复数据库和配置
- **4) ✅ 验证备份文件** - 检查备份文件完整性

### **⌨️ 命令行模式**

```bash
# 📋 查看备份
./scripts.sh backup list

# 📦 创建完整备份
./scripts.sh backup create

# 🔄 恢复系统
./scripts.sh backup restore [版本号]

# ✅ 验证备份
./scripts.sh backup verify [文件路径]
```

---

## 🗂️ **备份目录结构**

### **📁 主备份目录**
```
/Volumes/wwx/dev/WebProjects/aibianx/backups/
├── complete_backup_20250806_202417/     # 🆕 完整备份目录
│   ├── databases/                       # 数据库文件
│   │   ├── strapi_database.sql          # Strapi 5.22.0数据库
│   │   └── email_subscription.sql       # 邮件订阅数据
│   ├── config/                          # 配置文件
│   │   ├── deployment/config/deploy.conf
│   │   ├── backend/package.json
│   │   ├── frontend/package.json
│   │   └── BillionMail/env_init
│   ├── uploads/                         # 上传文件
│   └── backup_info.txt                  # 备份信息
└── complete_backup_20250806_202417.tar.gz  # 压缩包
```

### **📋 备份信息文件示例**
```
AI变现之路项目 - 数据库备份信息
====================================

备份时间: 2025年 8月 6日 星期三 20时24分17秒 CST
备份版本: 20250806_202417
备份类型: 完整备份
项目路径: /Volumes/wwx/dev/WebProjects/aibianx

备份内容:
- Strapi 5.22.0数据库: ✅ 已备份 (724K) - 16种内容类型
- 邮件订阅数据: ✅ 已备份 (100K) - Strapi集成邮件系统
- 配置文件: ✅ 已备份 - 71个脚本自动配置
- Redis缓存: ⚠️ 跳过 (会自动重建)
- MeiliSearch索引: ⚠️ 跳过 (会自动重建，支持中文分词)

还原命令:
./scripts.sh backup restore 20250806_202417
```

---

## ⚙️ **配置管理**

### **📋 deploy.conf 配置**

备份系统通过 `deployment/config/deploy.conf` 统一配置：

```bash
# 🗄️ 备份恢复配置
BACKUP_VERSION=latest              # 自动使用最新备份版本

# 📋 备份类型说明:
# - 数据库备份: 仅备份PostgreSQL数据库 (Strapi 5.22.0 + 邮件订阅)
# - Redis缓存和MeiliSearch索引会在服务启动时自动重建，无需备份
```

### **🔄 恢复优先级**

恢复脚本按以下优先级选择备份：

1. **命令行参数** - `./scripts.sh backup restore 20250806_202417`
2. **deploy.conf配置** - `BACKUP_VERSION=latest`
3. **默认值** - `latest`

### **📂 备份类型优先级**

当使用 `latest` 时，系统按以下顺序查找：

1. **complete_backup_*** - 最新完整备份
2. **db_backup_*** - 数据库备份
3. **strapi_backup_*** - 旧版完整备份

---

## 🛡️ **安全措施**

### **🔒 恢复前安全备份**

恢复操作会自动创建当前数据的安全备份：

```bash
# 自动创建安全备份目录
backups/safety_backup_20250806_202500/
├── current_strapi.sql      # 当前Strapi 5.22.0数据
└── current_email_subscription.sql # 当前邮件订阅数据
```

### **✅ 用户确认机制**

恢复数据库前需要用户手动确认：

```bash
⚠️ 这将清空并恢复Strapi数据库: aibianx_dev
确认继续? (y/N):
```

### **🔄 数据库重建策略**

恢复过程采用完全重建策略：

1. **断开连接** - 终止所有数据库连接
2. **删除数据库** - DROP DATABASE
3. **重建数据库** - CREATE DATABASE
4. **恢复数据** - pg_restore / psql

---

## 💡 **最佳实践**

### **📅 备份策略建议**

- **🚀 日常开发**: 重要功能完成后创建备份
- **📦 版本发布**: 发布前必须创建完整备份
- **🔄 数据迁移**: 迁移前后都要创建备份
- **⚡ 测试环境**: 定期从生产备份恢复

### **🎯 性能优化**

- **📦 压缩存储**: 自动压缩备份文件，节省80%+空间
- **⚡ 快速恢复**: Redis和搜索引擎自动重建，无需等待
- **🔍 智能选择**: 自动选择最新版本，无需手动查找
- **📋 版本管理**: 清晰的时间戳命名，易于识别

### **🔧 故障排除**

#### **❌ 备份失败**
```bash
# 检查数据库连接
./scripts.sh tools status

# 检查磁盘空间
df -h

# 检查权限
ls -la backups/
```

#### **❌ 恢复失败**
```bash
# 检查备份文件完整性
./scripts.sh backup verify backups/complete_backup_*/backup_info.txt

# 检查数据库服务
docker ps | grep postgres

# 手动重启服务
./scripts.sh deploy restart
```

---

## 🔗 **相关链接**

- **📋 项目文档**: [README.md](../../README.md)
- **⚙️ 部署指南**: [../部署运维/服务分离部署实现报告.md](../部署运维/服务分离部署实现报告.md)
- **🛠️ 开发指南**: [../开发指南/开发执行步骤总览.md](../开发指南/开发执行步骤总览.md)
- **🔧 故障排除**: [../问题解决/](../问题解决/)

---

**💡 提示**: Redis缓存和MeiliSearch索引会在服务启动时自动重建，恢复后只需重启服务即可完整恢复系统功能！