# 数据库迁移使用指南

> 🗄️ **AI变现之路项目数据库迁移脚本使用说明**

## 📚 概述

本指南说明如何使用项目中的数据库迁移脚本，这些脚本用于为数据库表和字段添加完整的中文注释，确保Strapi管理界面能够正确显示中文字段描述。

## 🎯 迁移脚本作用

### 📋 迁移文件清单

项目包含以下4个数据库迁移文件，位于 `backend/database/migrations/` 目录：

| 文件名 | 大小 | 作用描述 |
|--------|------|----------|
| `add_missing_table_comments.sql` | 9.7KB | 为业务核心表添加注释（commissions, invitations, orders, payments, refunds, subscriptions） |
| `add_link_table_comments.sql` | 11.5KB | 为所有关系表(_lnk)添加完整注释 |
| `add_core_table_comments.sql` | 4.3KB | 为系统核心表添加注释（files, i18n_locale） |
| `add_user_table_comments.sql` | 5.0KB | 为用户相关表添加注释 |

### ✨ 执行后效果

**执行前**：Strapi管理界面显示英文字段名
- `commission_rate` - 管理员不知道含义
- `is_premium` - 不清楚用途
- `invitation_code` - 字段意义不明

**执行后**：Strapi管理界面显示中文描述
- `佣金比例` - 明确是设置佣金百分比
- `是否会员专享` - 明确是付费内容标记
- `邀请码` - 明确是用户邀请功能

## 🚀 使用场景

### 1. 本地开发环境搭建

**适用情况**：新团队成员第一次搭建本地开发环境

```bash
# 1. 启动开发环境
./scripts.sh deploy start
# 或
./start-dev.sh

# 2. 等待Strapi创建基础表（约30秒）

# 3. 执行数据库迁移
cd backend
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_missing_table_comments.sql
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_link_table_comments.sql
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_core_table_comments.sql
psql -U aibianx_dev -d aibianx_dev -f database/migrations/add_user_table_comments.sql
cd ..

# 4. 验证效果
echo "访问 http://localhost:1337/admin 查看管理界面"
```

### 2. 生产环境部署

**适用情况**：部署到正式服务器（Railway + Supabase）

```bash
# 1. 获取生产数据库连接信息
DATABASE_URL="postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres"

# 2. 本地执行迁移（推荐）
cd /path/to/your/project/backend
psql $DATABASE_URL -f database/migrations/add_missing_table_comments.sql
psql $DATABASE_URL -f database/migrations/add_link_table_comments.sql
psql $DATABASE_URL -f database/migrations/add_core_table_comments.sql
psql $DATABASE_URL -f database/migrations/add_user_table_comments.sql

# 3. 验证生产环境
psql $DATABASE_URL -c "
SELECT 
    table_name,
    CASE WHEN obj_description(c.oid) IS NOT NULL THEN '✅ 有注释' ELSE '❌ 缺少注释' END as status
FROM information_schema.tables t
LEFT JOIN pg_class c ON c.relname = t.table_name
WHERE t.table_schema = 'public' AND t.table_name IN ('articles', 'commissions', 'orders', 'payments')
ORDER BY t.table_name;
"
```

### 3. 客户部署交付

**适用情况**：为客户提供完整的部署方案

```bash
# 客户执行的完整部署流程
git clone your-repo
cd project
chmod +x *.sh

# 启动服务
./start-dev.sh

# 等待数据库初始化完成
sleep 60

# 执行迁移脚本
cd backend
for sql_file in database/migrations/*.sql; do
    echo "执行: $sql_file"
    psql -U your_db_user -d your_db_name -f "$sql_file"
done
cd ..

echo "✅ 部署完成，数据库已有完整中文注释"
```

## 🔧 高级使用

### 批量执行脚本

创建一个自动化执行脚本：

```bash
#!/bin/bash
# deploy-migrations.sh

PROJECT_ROOT="/path/to/your/project"
DB_USER="aibianx_dev"
DB_NAME="aibianx_dev"

echo "🚀 开始执行数据库迁移..."
cd $PROJECT_ROOT/backend

migrations=(
    "add_missing_table_comments.sql"
    "add_link_table_comments.sql" 
    "add_core_table_comments.sql"
    "add_user_table_comments.sql"
)

for i in "${!migrations[@]}"; do
    migration=${migrations[$i]}
    echo "$(($i + 1))/4 执行: $migration"
    
    if psql -U $DB_USER -d $DB_NAME -f "database/migrations/$migration"; then
        echo "✅ $migration 执行成功"
    else
        echo "❌ $migration 执行失败"
        exit 1
    fi
done

echo "🎉 所有迁移执行完成！"
```

### Railway CLI 执行

如果使用Railway部署，也可以通过Railway CLI执行：

```bash
# 1. 登录Railway
railway login

# 2. 链接项目
railway link [your-project-id]

# 3. 通过Railway执行迁移
railway run psql $DATABASE_URL -f database/migrations/add_missing_table_comments.sql
railway run psql $DATABASE_URL -f database/migrations/add_link_table_comments.sql
railway run psql $DATABASE_URL -f database/migrations/add_core_table_comments.sql
railway run psql $DATABASE_URL -f database/migrations/add_user_table_comments.sql
```

## ✅ 验证和故障排除

### 验证迁移结果

```sql
-- 检查表注释
SELECT 
    table_name,
    obj_description(c.oid) as table_comment
FROM information_schema.tables t
LEFT JOIN pg_class c ON c.relname = t.table_name
WHERE t.table_schema = 'public' 
AND t.table_name IN ('commissions', 'orders', 'payments', 'articles')
ORDER BY t.table_name;

-- 检查字段注释（以commissions表为例）
SELECT 
    column_name,
    col_description(pgc.oid, ordinal_position) as field_comment
FROM information_schema.columns c
LEFT JOIN pg_class pgc ON pgc.relname = c.table_name
WHERE c.table_name = 'commissions'
ORDER BY c.ordinal_position;
```

### 常见问题解决

#### 1. 连接数据库失败

```bash
# 错误：connection refused
# 解决：检查数据库服务是否运行
./scripts.sh tools status
./scripts.sh database check

# 错误：authentication failed
# 解决：检查用户名密码和数据库名
echo $DATABASE_URL
```

#### 2. SQL执行报错

```bash
# 错误：table does not exist
# 解决：确认Strapi已创建基础表
# 访问 http://localhost:1337/admin 创建第一个管理员账号

# 错误：permission denied
# 解决：检查数据库用户权限
psql -U aibianx_dev -d aibianx_dev -c "\dt"
```

#### 3. 注释未在Strapi显示

```bash
# 解决方法1：重启Strapi服务
./scripts.sh deploy restart

# 解决方法2：清除Strapi缓存
rm -rf backend/.cache
./scripts.sh deploy start

# 解决方法3：检查字段描述配置
./scripts.sh content-type configure commission
```

## 📝 重要提醒

### ⚠️ 执行时机

- **首次部署**：在Strapi创建基础表**之后**执行
- **数据迁移**：在数据库结构变更**之后**执行
- **环境复制**：每次新环境搭建时都需要执行

### 🔒 安全注意事项

- 生产环境执行前务必备份数据库
- 测试环境先验证脚本正确性
- 检查DATABASE_URL确保连接到正确数据库

### 💡 最佳实践

1. **按顺序执行**：按照文档中的顺序执行迁移文件
2. **逐个验证**：每个文件执行后检查是否成功
3. **记录日志**：保留执行日志便于故障排查
4. **团队共享**：确保团队成员都了解迁移流程

---

## 📚 相关文档

- [生产环境部署指南](../生产环境部署指南.md) - 完整的生产环境部署流程
- [项目README](../../../README.md) - 快速开始和本地开发指南
- [开发脚本使用指南](../../../DEV-SCRIPTS.md) - 项目脚本详细说明

---

**💡 小贴士**：数据库迁移是一次性操作，执行成功后无需重复执行。如果需要修改注释内容，应该创建新的迁移文件而不是修改现有文件。