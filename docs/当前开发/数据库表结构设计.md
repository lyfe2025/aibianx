# AI变现之路 - PostgreSQL数据库设计 📊

> 📋 **设计文档**：基于PostgreSQL的完整数据库设计方案，支持SEO优化和商业化功能

## 📚 文档说明

本文档是 **[技术方案总览指南](./AI变现之路_技术方案总览指南.md)** 的配套文档，详细设计PostgreSQL数据库表结构。

### 🎯 设计原则

基于主文档的**Strapi + PostgreSQL统一数据管理策略**：
- **内容数据**（文章、作者、标签、分类）→ Strapi数据库管理，API自动生成
- **用户数据**（用户、权限、会话、偏好）→ Strapi用户系统，完整认证流程
- **业务数据**（订单、支付、会员、营销）→ PostgreSQL存储，Strapi管理
- **行为数据**（收藏、统计、分析、通知）→ 数据库实时记录和分析

---

## 🗄️ 为什么选择PostgreSQL？

基于项目的复杂需求和长期发展考虑，PostgreSQL是最佳选择：

### ✅ **技术优势**
- **强大的JSONB支持**：营销活动配置、用户偏好等复杂数据存储更高效
- **原生数组类型**：权限列表、标签数组等不需要额外关联表
- **复杂查询功能**：用户行为分析、收入统计等需要强大的分析功能
- **内置全文搜索**：文章内容搜索，无需额外集成ElasticSearch
- **严格的ACID特性**：财务数据安全可靠
- **优秀的扩展性**：支持海量内容和用户增长

### 🚀 **具体业务场景优势**

#### **1. 营销活动配置（JSONB威力）**
```sql
-- PostgreSQL轻松处理复杂配置
CREATE TABLE marketing_activities (
    config JSONB DEFAULT '{}',
    target_audience JSONB
);

-- 高效查询
SELECT * FROM marketing_activities 
WHERE config->>'type' = 'countdown_sale' 
AND config->'budget'::numeric > 1000;
```

#### **2. 用户权限管理（数组便利性）**
```sql
-- 原生数组支持
CREATE TABLE users (
    permissions TEXT[] DEFAULT ARRAY[]::TEXT[],
    tags VARCHAR(50)[]
);

-- 简单的权限查询
SELECT * FROM users 
WHERE 'premium_content' = ANY(permissions);
```

#### **3. 内容全文搜索（内置功能）**
```sql
-- 中文内容搜索
CREATE INDEX idx_articles_search ON articles 
USING gin(to_tsvector('chinese', title || ' ' || content));

-- 搜索查询
SELECT * FROM articles 
WHERE to_tsvector('chinese', title || ' ' || content) 
      @@ plainto_tsquery('chinese', 'AI变现');
```

---

## 📋 核心表结构设计

### 🗂️ **数据库架构总览**

```
用户相关模块:
users (用户基础信息)
├── user_profiles (扩展资料)
├── user_subscriptions (会员订阅)
├── user_sessions (登录会话)
├── user_bookmarks (收藏记录)
├── user_balance (用户余额)
└── reading_history (阅读历史)

内容管理模块:
articles (文章) → Strapi管理
├── authors (作者) → Strapi管理
├── tags (标签) → Strapi管理
└── categories (分类) → Strapi管理

财务管理模块:
orders (订单记录)
├── payments (支付记录)
├── withdraws (提现记录)
├── income_records (收入记录)
└── coupons (优惠券)

营销推广模块:
invite_records (邀请记录)
├── marketing_activities (营销活动)
├── coupon_usage (优惠券使用)
└── referral_rewards (推荐奖励)

通信系统模块:
email_subscriptions (邮件订阅)
├── email_templates (邮件模板)
├── notifications (站内通知)
└── notification_settings (通知设置)

统计分析模块:
article_statistics (文章统计)
├── user_activities (用户行为)
├── business_stats (业务统计)
└── analytics_events (分析事件)

系统配置模块:
site_configs (网站配置)
├── payment_configs (支付配置)
├── seo_configs (SEO配置)
└── email_configs (邮件配置)
```

---

## 👤 用户管理模块

### 1. users - 用户基础信息表

```sql
CREATE TABLE users (
    -- 基础字段
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    email_verified BOOLEAN DEFAULT FALSE,
    password_hash VARCHAR(255), -- 可为空，支持OAuth登录
    
    -- 基本信息
    nickname VARCHAR(100),
    avatar_url TEXT,
    bio TEXT,
    location VARCHAR(100),
    website_url TEXT,
    
    -- 认证相关
    github_id VARCHAR(50) UNIQUE, -- GitHub OAuth ID
    google_id VARCHAR(50) UNIQUE, -- Google OAuth ID (预留)
    wechat_id VARCHAR(50) UNIQUE, -- 微信登录ID (预留)
    
    -- 会员状态
    membership_level VARCHAR(20) DEFAULT 'free' CHECK (membership_level IN ('free', 'monthly', 'yearly')),
    membership_expire_at TIMESTAMP,
    
    -- 用户偏好（JSONB优势）
    preferences JSONB DEFAULT '{}', -- 用户偏好设置
    notification_settings JSONB DEFAULT '{}', -- 通知设置
    
    -- 权限管理（数组优势）
    permissions TEXT[] DEFAULT ARRAY[]::TEXT[], -- 用户权限列表
    
    -- 基础设置
    language VARCHAR(10) DEFAULT 'zh-CN',
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    
    -- SEO相关字段
    public_profile BOOLEAN DEFAULT FALSE, -- 是否公开个人资料页面
    profile_slug VARCHAR(100) UNIQUE, -- 用户主页slug，如：/user/li-mingyang
    seo_title VARCHAR(200), -- 个人页面SEO标题
    seo_description TEXT, -- 个人页面SEO描述
    
    -- 统计数据（冗余字段，提升查询性能）
    articles_read_count INTEGER DEFAULT 0,
    bookmarks_count INTEGER DEFAULT 0,
    total_reading_time INTEGER DEFAULT 0, -- 总阅读时长（分钟）
    
    -- 软删除
    deleted_at TIMESTAMP
);

-- 索引优化
CREATE INDEX idx_users_email ON users(email) WHERE deleted_at IS NULL;
CREATE INDEX idx_users_membership ON users(membership_level, membership_expire_at);
CREATE INDEX idx_users_permissions ON users USING gin(permissions);
CREATE INDEX idx_users_preferences ON users USING gin(preferences);
CREATE INDEX idx_users_profile_slug ON users(profile_slug) WHERE profile_slug IS NOT NULL;

-- 更新时间触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 2. user_sessions - 用户会话管理

```sql
CREATE TABLE user_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- JWT Token相关
    token_hash VARCHAR(255) NOT NULL, -- JWT token的hash值
    refresh_token_hash VARCHAR(255), -- 刷新token的hash值
    
    -- 会话信息（JSONB优势）
    device_info JSONB, -- 设备信息 {browser, os, device_type, version}
    location_info JSONB, -- 位置信息 {country, city, ip}
    
    -- 网络信息
    ip_address INET,
    user_agent TEXT,
    
    -- 时间控制
    expires_at TIMESTAMP NOT NULL,
    refresh_expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 会话状态
    is_active BOOLEAN DEFAULT TRUE,
    logout_reason VARCHAR(50) -- manual, expired, force_logout
);

-- 索引
CREATE INDEX idx_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_sessions_token_hash ON user_sessions(token_hash);
CREATE INDEX idx_sessions_expires ON user_sessions(expires_at) WHERE is_active = TRUE;
CREATE INDEX idx_sessions_device_info ON user_sessions USING gin(device_info);
```

### 3. user_bookmarks - 用户收藏表

```sql
CREATE TABLE user_bookmarks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- 收藏内容（文章通过slug标识）
    article_slug VARCHAR(200) NOT NULL, -- 文章slug，对应Strapi中的文章
    
    -- 冗余存储（提升查询性能）
    article_data JSONB, -- 冗余存储文章基本信息 {title, excerpt, cover_image, tags}
    
    -- 收藏信息
    bookmark_note TEXT, -- 用户添加的收藏备注
    is_public BOOLEAN DEFAULT FALSE, -- 是否公开此收藏
    
    -- 分类管理
    collection_name VARCHAR(100) DEFAULT 'default', -- 收藏夹名称
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 唯一约束和索引
CREATE UNIQUE INDEX idx_bookmarks_user_article ON user_bookmarks(user_id, article_slug);
CREATE INDEX idx_bookmarks_user_collection ON user_bookmarks(user_id, collection_name);
CREATE INDEX idx_bookmarks_article_data ON user_bookmarks USING gin(article_data);
CREATE INDEX idx_bookmarks_created_at ON user_bookmarks(created_at);
```

---

## 💎 会员订阅模块

### 4. user_subscriptions - 会员订阅记录

```sql
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    
    -- 订阅信息
    plan_type VARCHAR(20) NOT NULL CHECK (plan_type IN ('monthly', 'yearly')),
    plan_name VARCHAR(100) NOT NULL, -- 套餐显示名称
    original_price DECIMAL(10,2) NOT NULL, -- 原价
    paid_price DECIMAL(10,2) NOT NULL, -- 实付价格
    currency VARCHAR(3) DEFAULT 'CNY',
    
    -- 时间范围
    started_at TIMESTAMP NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    
    -- 订阅状态
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'expired', 'cancelled', 'suspended')),
    auto_renew BOOLEAN DEFAULT TRUE,
    
    -- 关联订单
    order_id UUID, -- 关联orders表
    
    -- 优惠信息（JSONB优势）
    discount_info JSONB, -- 优惠详情 {coupon_code, discount_amount, discount_type}
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    cancelled_at TIMESTAMP,
    cancel_reason TEXT
);

-- 索引
CREATE INDEX idx_subscriptions_user_id ON user_subscriptions(user_id);
CREATE INDEX idx_subscriptions_status_expires ON user_subscriptions(status, expires_at);
CREATE INDEX idx_subscriptions_order_id ON user_subscriptions(order_id);
CREATE INDEX idx_subscriptions_discount_info ON user_subscriptions USING gin(discount_info);
```

### 5. orders - 订单记录表

```sql
CREATE TABLE orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    order_number VARCHAR(50) UNIQUE NOT NULL, -- 订单号：ORD20241201001
    user_id UUID REFERENCES users(id),
    
    -- 订单内容（JSONB优势）
    order_items JSONB NOT NULL, -- 订单项目详情
    order_metadata JSONB DEFAULT '{}', -- 订单元数据
    
    -- 金额信息
    original_amount DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    final_amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    
    -- 优惠信息（JSONB优势）
    promotions JSONB DEFAULT '[]', -- 应用的优惠活动列表
    
    -- 订单状态
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'cancelled', 'refunded', 'expired')),
    
    -- 支付信息
    payment_method VARCHAR(20), -- alipay, wechat, unionpay
    paid_at TIMESTAMP,
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP, -- 订单过期时间（30分钟）
    
    -- 附加信息
    notes TEXT
);

-- 索引
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_number ON orders(order_number);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_orders_expires_at ON orders(expires_at) WHERE status = 'pending';
CREATE INDEX idx_orders_items ON orders USING gin(order_items);
```

---

## 💰 财务管理模块

### 6. user_balance - 用户余额表

```sql
CREATE TABLE user_balance (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- 余额信息
    available_balance DECIMAL(10,2) DEFAULT 0.00,    -- 可用余额
    frozen_balance DECIMAL(10,2) DEFAULT 0.00,       -- 冻结余额
    total_income DECIMAL(10,2) DEFAULT 0.00,         -- 累计收入
    total_withdraw DECIMAL(10,2) DEFAULT 0.00,       -- 累计提现
    
    -- 版本控制（乐观锁）
    version INTEGER DEFAULT 1,
    
    -- 时间戳
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_balance_positive CHECK (available_balance >= 0),
    CONSTRAINT check_frozen_positive CHECK (frozen_balance >= 0),
    CONSTRAINT unique_user_balance UNIQUE (user_id)
);

-- 索引
CREATE INDEX idx_user_balance_user_id ON user_balance(user_id);
```

### 7. withdraws - 提现记录表

```sql
CREATE TABLE withdraws (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- 提现信息
    amount DECIMAL(10,2) NOT NULL,                   -- 提现金额
    service_fee DECIMAL(10,2) DEFAULT 0.00,          -- 手续费
    actual_amount DECIMAL(10,2) NOT NULL,            -- 实际到账金额
    
    -- 银行信息（JSONB优势）
    bank_info JSONB NOT NULL, -- {account_number, bank_name, account_holder, branch}
    
    -- 提现状态
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'rejected')),
    
    -- 处理信息
    admin_note TEXT,                                 -- 管理员备注
    processed_at TIMESTAMP,                         -- 处理时间
    processed_by UUID REFERENCES users(id),         -- 处理人
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_withdraw_amount_positive CHECK (amount > 0)
);

-- 索引
CREATE INDEX idx_withdraws_user_id ON withdraws(user_id);
CREATE INDEX idx_withdraws_status ON withdraws(status);
CREATE INDEX idx_withdraws_bank_info ON withdraws USING gin(bank_info);
```

### 8. income_records - 收入记录表

```sql
CREATE TABLE income_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    -- 收入信息
    source_type VARCHAR(20) NOT NULL CHECK (source_type IN ('invite_reward', 'membership_commission', 'referral_bonus', 'other')),
    source_id UUID,                                  -- 来源ID(邀请记录ID等)
    amount DECIMAL(10,2) NOT NULL,                   -- 收入金额
    commission_rate DECIMAL(5,2),                    -- 佣金比例
    
    -- 收入详情（JSONB优势）
    income_details JSONB, -- 收入详细信息 {description, calculation, related_order}
    
    -- 收入状态
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'settled', 'cancelled')),
    settled_at TIMESTAMP,                           -- 结算时间
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT check_income_amount_positive CHECK (amount > 0)
);

-- 索引
CREATE INDEX idx_income_records_user_id ON income_records(user_id);
CREATE INDEX idx_income_records_source ON income_records(source_type, source_id);
CREATE INDEX idx_income_records_details ON income_records USING gin(income_details);
```

---

## 🎪 营销推广模块

### 9. invite_records - 邀请记录表

```sql
CREATE TABLE invite_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    inviter_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE, -- 邀请人
    invitee_id UUID REFERENCES users(id) ON DELETE SET NULL,          -- 被邀请人
    
    -- 邀请信息
    invite_code VARCHAR(20) NOT NULL UNIQUE,                 -- 邀请码
    contact_info JSONB, -- 联系信息 {email, phone, social_media}
    
    -- 邀请状态
    status VARCHAR(20) DEFAULT 'sent' CHECK (status IN ('sent', 'registered', 'activated', 'rewarded')),
    
    -- 奖励信息（JSONB优势）
    reward_config JSONB, -- 奖励配置 {amount, conditions, tier}
    reward_paid BOOLEAN DEFAULT FALSE,                -- 奖励是否已发放
    
    -- 时间记录
    registered_at TIMESTAMP,                         -- 注册时间
    first_purchase_at TIMESTAMP,                     -- 首次购买时间
    reward_paid_at TIMESTAMP,                        -- 奖励发放时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_invite_records_inviter ON invite_records(inviter_id);
CREATE INDEX idx_invite_records_code ON invite_records(invite_code);
CREATE INDEX idx_invite_records_contact ON invite_records USING gin(contact_info);
```

### 10. marketing_activities - 营销活动表

```sql
CREATE TABLE marketing_activities (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 活动基本信息
    name VARCHAR(200) NOT NULL,                      -- 活动名称
    type VARCHAR(50) NOT NULL CHECK (type IN ('countdown_sale', 'invite_campaign', 'new_user_bonus', 'loyalty_program')),
    description TEXT,                                -- 活动描述
    
    -- 活动配置（JSONB优势）
    activity_config JSONB NOT NULL, -- 活动配置 {rules, rewards, conditions, ui_settings}
    target_audience JSONB, -- 目标用户群体 {user_levels, geographic, behavioral}
    
    -- 活动状态
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'paused', 'completed', 'cancelled')),
    
    -- 时间控制
    start_date TIMESTAMP,                            -- 开始时间
    end_date TIMESTAMP,                              -- 结束时间
    
    -- 预算和统计
    budget DECIMAL(10,2),                            -- 预算
    actual_cost DECIMAL(10,2) DEFAULT 0,             -- 实际花费
    
    -- 效果统计（JSONB优势）
    performance_metrics JSONB DEFAULT '{}', -- 效果指标 {participants, conversions, roi}
    
    -- 管理信息
    created_by UUID REFERENCES users(id),         -- 创建人
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_marketing_activities_status ON marketing_activities(status, start_date, end_date);
CREATE INDEX idx_marketing_activities_type ON marketing_activities(type);
CREATE INDEX idx_marketing_activities_config ON marketing_activities USING gin(activity_config);
CREATE INDEX idx_marketing_activities_audience ON marketing_activities USING gin(target_audience);
```

---

## 📊 统计分析模块

### 11. article_statistics - 文章统计表

```sql
CREATE TABLE article_statistics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    article_slug VARCHAR(200) UNIQUE NOT NULL,
    
    -- 基础统计
    view_count INTEGER DEFAULT 0,
    unique_view_count INTEGER DEFAULT 0, -- 去重访问
    bookmark_count INTEGER DEFAULT 0,
    share_count INTEGER DEFAULT 0,
    
    -- 阅读质量指标
    avg_reading_time INTEGER DEFAULT 0, -- 平均阅读时长（秒）
    completion_rate DECIMAL(5,2) DEFAULT 0, -- 完成率百分比
    bounce_rate DECIMAL(5,2) DEFAULT 0, -- 跳出率
    
    -- SEO相关统计（JSONB优势）
    seo_metrics JSONB DEFAULT '{}', -- SEO指标 {impressions, clicks, position, ctr}
    
    -- 来源统计（JSONB优势）
    traffic_sources JSONB DEFAULT '{}', -- 流量来源 {direct, search, social, referral}
    
    -- 时间统计
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_article_stats_slug ON article_statistics(article_slug);
CREATE INDEX idx_article_stats_views ON article_statistics(view_count DESC);
CREATE INDEX idx_article_stats_seo ON article_statistics USING gin(seo_metrics);
CREATE INDEX idx_article_stats_traffic ON article_statistics USING gin(traffic_sources);
```

### 12. analytics_events - 分析事件表

```sql
CREATE TABLE analytics_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 用户和会话
    user_id UUID REFERENCES users(id),            -- 用户ID(可为空，支持匿名事件)
    session_id VARCHAR(100),                         -- 会话ID
    
    -- 事件信息
    event_type VARCHAR(50) NOT NULL,                 -- 事件类型
    event_name VARCHAR(100) NOT NULL,                -- 事件名称
    
    -- 事件属性（JSONB优势）
    event_properties JSONB DEFAULT '{}', -- 事件属性 {page, action, value, category}
    user_properties JSONB DEFAULT '{}', -- 用户属性 {device, location, preferences}
    
    -- 页面信息
    page_url VARCHAR(500),                           -- 页面URL
    referrer VARCHAR(500),                           -- 来源页面
    
    -- 技术信息
    user_agent TEXT,                                 -- 用户代理
    ip_address INET,                                 -- IP地址
    
    -- 地理信息（JSONB优势）
    geo_info JSONB, -- 地理信息 {country, city, region, timezone}
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 分区表（按月分区）
CREATE TABLE analytics_events_y2024m01 PARTITION OF analytics_events
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- 索引
CREATE INDEX idx_analytics_events_user ON analytics_events(user_id, created_at);
CREATE INDEX idx_analytics_events_type ON analytics_events(event_type, event_name, created_at);
CREATE INDEX idx_analytics_events_session ON analytics_events(session_id, created_at);
CREATE INDEX idx_analytics_events_properties ON analytics_events USING gin(event_properties);
CREATE INDEX idx_analytics_events_geo ON analytics_events USING gin(geo_info);
```

---

## ⚙️ 系统配置模块

### 13. site_configs - 网站配置表

```sql
CREATE TABLE site_configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    config_key VARCHAR(100) NOT NULL UNIQUE,         -- 配置键
    config_value JSONB,                              -- 配置值（JSONB优势）
    data_type VARCHAR(20) DEFAULT 'string' CHECK (data_type IN ('string', 'number', 'boolean', 'json', 'array')),
    category VARCHAR(50),                            -- 配置分类
    description TEXT,                                -- 配置描述
    is_public BOOLEAN DEFAULT FALSE,                 -- 是否公开(前端可访问)
    is_encrypted BOOLEAN DEFAULT FALSE,              -- 是否加密存储
    updated_by UUID REFERENCES users(id),         -- 更新人
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_site_configs_category ON site_configs(category, is_public);
CREATE INDEX idx_site_configs_key ON site_configs(config_key);
```

---

## 🛡️ 数据库优化策略

### 1. 索引策略

```sql
-- 复合索引
CREATE INDEX idx_users_membership_active ON users(membership_level, membership_expire_at) 
WHERE deleted_at IS NULL AND membership_expire_at > CURRENT_TIMESTAMP;

-- 部分索引
CREATE INDEX idx_orders_pending ON orders(created_at, expires_at) 
WHERE status = 'pending';

-- JSONB字段索引
CREATE INDEX idx_activities_config_type ON marketing_activities 
USING gin((activity_config->>'type')) 
WHERE status = 'active';

-- 全文搜索索引
CREATE INDEX idx_articles_fulltext ON articles 
USING gin(to_tsvector('chinese', title || ' ' || content));
```

### 2. 查询优化

```sql
-- 用户dashboard查询优化
CREATE MATERIALIZED VIEW user_dashboard_stats AS
SELECT 
    u.id,
    u.nickname,
    u.membership_level,
    u.membership_expire_at,
    COUNT(DISTINCT ub.id) as bookmark_count,
    COUNT(DISTINCT urh.id) as articles_read,
    COALESCE(SUM(urh.reading_time), 0) as total_reading_time,
    ub_recent.recent_bookmarks,
    (SELECT available_balance FROM user_balance WHERE user_id = u.id) as balance
FROM users u
LEFT JOIN user_bookmarks ub ON u.id = ub.user_id
LEFT JOIN user_reading_history urh ON u.id = urh.user_id
LEFT JOIN LATERAL (
    SELECT jsonb_agg(jsonb_build_object(
        'slug', article_slug,
        'created_at', created_at,
        'article_data', article_data
    ) ORDER BY created_at DESC) as recent_bookmarks
    FROM user_bookmarks 
    WHERE user_id = u.id 
    LIMIT 5
) ub_recent ON true
WHERE u.deleted_at IS NULL
GROUP BY u.id, u.nickname, u.membership_level, u.membership_expire_at, ub_recent.recent_bookmarks;

-- 创建唯一索引支持并发刷新
CREATE UNIQUE INDEX idx_user_dashboard_stats_id ON user_dashboard_stats(id);

-- 自动刷新触发器
CREATE OR REPLACE FUNCTION refresh_user_dashboard_stats()
RETURNS trigger AS $$
BEGIN
    REFRESH MATERIALIZED VIEW CONCURRENTLY user_dashboard_stats;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- 在相关表更新时刷新物化视图
CREATE TRIGGER refresh_dashboard_on_bookmark_change
    AFTER INSERT OR UPDATE OR DELETE ON user_bookmarks
    FOR EACH STATEMENT EXECUTE FUNCTION refresh_user_dashboard_stats();
```

### 3. 数据归档策略

```sql
-- 归档旧的分析事件数据（超过6个月）
CREATE TABLE analytics_events_archive (LIKE analytics_events INCLUDING ALL);

-- 定期归档任务
CREATE OR REPLACE FUNCTION archive_old_analytics()
RETURNS void AS $$
BEGIN
    WITH moved_rows AS (
        DELETE FROM analytics_events 
        WHERE created_at < CURRENT_DATE - INTERVAL '6 months'
        RETURNING *
    )
    INSERT INTO analytics_events_archive SELECT * FROM moved_rows;
END;
$$ LANGUAGE plpgsql;

-- 创建定期任务（需要pg_cron扩展）
SELECT cron.schedule('archive-analytics', '0 2 1 * *', 'SELECT archive_old_analytics();');
```

---

## 🔒 数据安全和权限

### 1. 行级安全(RLS)

```sql
-- 启用用户表的行级安全
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- 用户只能查看自己的数据
CREATE POLICY user_self_access ON users
    FOR ALL USING (id = current_setting('app.user_id')::uuid);

-- 管理员可以查看所有数据
CREATE POLICY admin_all_access ON users
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM users 
            WHERE id = current_setting('app.user_id')::uuid 
            AND 'admin' = ANY(permissions)
        )
    );

-- 用户余额表的行级安全
ALTER TABLE user_balance ENABLE ROW LEVEL SECURITY;

CREATE POLICY user_balance_self_access ON user_balance
    FOR ALL USING (user_id = current_setting('app.user_id')::uuid);
```

### 2. 敏感数据加密

```sql
-- 创建加密函数
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data text)
RETURNS text AS $$
BEGIN
    RETURN encode(encrypt(data::bytea, current_setting('app.encryption_key'), 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;

-- 创建解密函数
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data text)
RETURNS text AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_data, 'base64'), current_setting('app.encryption_key'), 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql;

-- 银行信息加密存储触发器
CREATE OR REPLACE FUNCTION encrypt_bank_info()
RETURNS trigger AS $$
BEGIN
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        -- 加密银行账号
        IF NEW.bank_info->>'account_number' IS NOT NULL THEN
            NEW.bank_info = jsonb_set(
                NEW.bank_info,
                '{account_number_encrypted}',
                to_jsonb(encrypt_sensitive_data(NEW.bank_info->>'account_number'))
            );
            NEW.bank_info = NEW.bank_info - 'account_number';
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER encrypt_withdraw_bank_info
    BEFORE INSERT OR UPDATE ON withdraws
    FOR EACH ROW EXECUTE FUNCTION encrypt_bank_info();
```

---

## 📈 性能监控和维护

### 1. 性能监控视图

```sql
-- 慢查询监控
CREATE VIEW slow_queries AS
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    stddev_time,
    min_time,
    max_time,
    rows
FROM pg_stat_statements 
WHERE mean_time > 100 -- 平均执行时间超过100ms
ORDER BY mean_time DESC;

-- 表大小监控
CREATE VIEW table_sizes AS
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as bytes
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY bytes DESC;

-- 索引使用情况监控
CREATE VIEW index_usage AS
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_tup_read,
    idx_tup_fetch,
    idx_scan,
    pg_size_pretty(pg_relation_size(indexrelid)) as index_size
FROM pg_stat_user_indexes 
ORDER BY idx_scan DESC;
```

### 2. 自动维护任务

```sql
-- 定期更新文章统计
CREATE OR REPLACE FUNCTION update_article_statistics()
RETURNS void AS $$
BEGIN
    -- 更新文章统计
    INSERT INTO article_statistics (
        article_slug, 
        view_count, 
        unique_view_count, 
        bookmark_count,
        avg_reading_time,
        completion_rate
    )
    SELECT 
        ae.event_properties->>'article_slug' as article_slug,
        COUNT(*) as view_count,
        COUNT(DISTINCT ae.user_id) as unique_view_count,
        (SELECT COUNT(*) FROM user_bookmarks ub WHERE ub.article_slug = ae.event_properties->>'article_slug') as bookmark_count,
        AVG((ae.event_properties->>'reading_time')::integer) as avg_reading_time,
        AVG(CASE WHEN ae.event_properties->>'completed' = 'true' THEN 100.0 ELSE 0.0 END) as completion_rate
    FROM analytics_events ae
    WHERE ae.event_type = 'article_read'
        AND ae.created_at >= CURRENT_DATE - INTERVAL '1 day'
        AND ae.event_properties->>'article_slug' IS NOT NULL
    GROUP BY ae.event_properties->>'article_slug'
    ON CONFLICT (article_slug) DO UPDATE SET
        view_count = article_statistics.view_count + EXCLUDED.view_count,
        unique_view_count = EXCLUDED.unique_view_count,
        bookmark_count = EXCLUDED.bookmark_count,
        avg_reading_time = EXCLUDED.avg_reading_time,
        completion_rate = EXCLUDED.completion_rate,
        last_updated = CURRENT_TIMESTAMP;
END;
$$ LANGUAGE plpgsql;

-- 定期执行统计更新（需要pg_cron扩展）
SELECT cron.schedule('update-article-stats', '0 */6 * * *', 'SELECT update_article_statistics();');
```

---

## 🚀 部署和迁移

### 1. 数据库初始化脚本

```sql
-- init.sql
-- 1. 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

-- 2. 创建自定义类型
CREATE TYPE user_role AS ENUM ('user', 'editor', 'admin');
CREATE TYPE subscription_status AS ENUM ('active', 'expired', 'cancelled', 'suspended');
CREATE TYPE order_status AS ENUM ('pending', 'paid', 'cancelled', 'refunded', 'expired');

-- 3. 创建应用用户
CREATE USER aibianx_app WITH PASSWORD 'your_secure_password';
GRANT CONNECT ON DATABASE aibianx_prod TO aibianx_app;
GRANT USAGE ON SCHEMA public TO aibianx_app;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO aibianx_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO aibianx_app;

-- 4. 设置默认权限
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO aibianx_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO aibianx_app;
```

### 2. 迁移版本管理

```sql
-- migrations/001_initial_schema.sql
-- migrations/002_add_jsonb_indexes.sql  
-- migrations/003_create_materialized_views.sql
-- migrations/004_add_rls_policies.sql

-- 迁移状态跟踪表
CREATE TABLE schema_migrations (
    version VARCHAR(255) PRIMARY KEY,
    applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    description TEXT
);
```

---

## 📚 总结

### 🎯 PostgreSQL设计优势

1. **JSONB字段**：完美支持复杂的配置数据、用户偏好、事件属性等
2. **数组类型**：简化权限管理、标签系统、多值字段存储
3. **全文搜索**：内置中文分词，支持复杂的内容搜索需求
4. **分区表**：大数据量的分析事件表按月分区，提升查询性能
5. **物化视图**：用户dashboard等复杂查询的性能优化
6. **行级安全**：细粒度的数据访问控制
7. **丰富索引**：GIN索引支持JSONB和数组的高效查询

### 🔗 与其他文档的关系

- **[技术方案总览指南](./AI变现之路_技术方案总览指南.md)**：本文档的上级文档，解释整体技术选型
- **[开发执行步骤详细指南](./开发执行步骤详细指南.md)**：具体的开发实施步骤
- **[生产环境部署指南](./生产环境部署指南.md)**：数据库在生产环境的部署方案

### 💡 下一步实施

1. **根据本设计创建数据库表结构**
2. **配置Strapi以使用PostgreSQL**
3. **实现数据迁移脚本**
4. **建立监控和备份策略**
5. **优化查询性能和索引策略**

这个PostgreSQL数据库设计充分发挥了PostgreSQL的技术优势，为AI变现之路项目提供了高性能、可扩展、安全可靠的数据基础。 🎯 