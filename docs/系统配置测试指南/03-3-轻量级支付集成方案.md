# 轻量级支付集成方案 - 基于现有表结构

> **适用场景**: 已有完整Payment/Order表结构，需要保持页面体验的轻量级支付集成
> **核心优势**: 零额外部署，内嵌支付体验，完全利用现有数据结构

---

## 1. 方案概述

### 1.1 设计原则
- ✅ **利用现有表结构**：充分利用已设计的Payment、Order、Subscription表
- ✅ **保持用户体验**：支付组件内嵌，无需跳转到外部页面
- ✅ **最小部署复杂度**：仅需添加NPM包，无需额外服务
- ✅ **渐进式实现**：先支持核心支付方式，后续逐步扩展

### 1.2 技术选择

| 支付方式 | 技术方案 | 体验方式 |
|----------|----------|----------|
| **支付宝** | 官方SDK + 内嵌H5 | 页面内H5支付，无跳转 |
| **微信支付** | 官方SDK + JSAPI | 微信内直接支付 |
| **Stripe** | Stripe Elements | 页面内信用卡支付 |

---

## 2. 核心技术实现

### 2.1 支付服务层设计

```typescript
// backend/src/services/payment-manager.ts
interface PaymentProvider {
  name: string;
  createPayment(orderData: OrderData): Promise<PaymentResult>;
  handleCallback(data: any): Promise<void>;
  queryPayment(paymentNo: string): Promise<PaymentStatus>;
}

export class PaymentManager {
  private providers = new Map<string, PaymentProvider>();
  
  register(provider: PaymentProvider) {
    this.providers.set(provider.name, provider);
  }
  
  async processPayment(method: string, orderData: OrderData) {
    // 1. 创建支付记录
    const payment = await strapi.entityService.create('api::payment.payment', {
      data: {
        paymentNo: this.generatePaymentNo(),
        order: orderData.orderId,
        user: orderData.userId,
        paymentMethod: method,
        amount: orderData.amount,
        status: 'pending'
      }
    });
    
    // 2. 调用对应支付提供商
    const provider = this.providers.get(method);
    const result = await provider.createPayment({
      ...orderData,
      paymentNo: payment.paymentNo
    });
    
    // 3. 更新支付记录
    await strapi.entityService.update('api::payment.payment', payment.id, {
      data: {
        thirdPartyOrderNo: result.orderNo,
        thirdPartyResponse: result.rawResponse
      }
    });
    
    return {
      paymentId: payment.id,
      paymentUrl: result.paymentUrl,
      paymentData: result.paymentData
    };
  }
}
```

### 2.2 支付宝集成 - 内嵌H5体验

```typescript
// backend/src/services/alipay-provider.ts
import AlipaySdk from 'alipay-sdk';

export class AlipayProvider implements PaymentProvider {
  name = 'alipay';
  private sdk: AlipaySdk;
  
  constructor() {
    this.sdk = new AlipaySdk({
      appId: process.env.ALIPAY_APP_ID,
      privateKey: process.env.ALIPAY_PRIVATE_KEY,
      alipayPublicKey: process.env.ALIPAY_PUBLIC_KEY,
      gateway: 'https://openapi.alipay.com/gateway.do'
    });
  }
  
  async createPayment(orderData: OrderData): Promise<PaymentResult> {
    // 使用支付宝H5支付，支持内嵌
    const result = await this.sdk.pageExecute('alipay.trade.wap.pay', {
      bizContent: {
        out_trade_no: orderData.paymentNo,
        product_code: 'QUICK_WAP_WAY',
        total_amount: (orderData.amount / 100).toFixed(2),
        subject: orderData.productName,
        quit_url: `${process.env.FRONTEND_URL}/payment/cancel`,
        // 关键：不设置return_url，支持内嵌体验
      }
    });
    
    return {
      success: true,
      paymentUrl: result,
      paymentData: { 
        type: 'redirect',
        url: result
      }
    };
  }
  
  async handleCallback(data: any): Promise<void> {
    // 验证签名
    const isValid = this.sdk.checkNotifySign(data);
    if (!isValid) {
      throw new Error('Invalid signature');
    }
    
    // 更新支付记录
    const payment = await strapi.entityService.findMany('api::payment.payment', {
      filters: { paymentNo: data.out_trade_no }
    });
    
    if (payment.length > 0) {
      await strapi.entityService.update('api::payment.payment', payment[0].id, {
        data: {
          status: data.trade_status === 'TRADE_SUCCESS' ? 'success' : 'failed',
          thirdPartyTransactionId: data.trade_no,
          completedAt: new Date(),
          notifiedAt: new Date()
        }
      });
      
      // 更新订单状态
      if (data.trade_status === 'TRADE_SUCCESS') {
        await strapi.service('api::order.order').handlePaymentSuccess(payment[0].order);
      }
    }
  }
}
```

### 2.3 微信支付集成 - JSAPI内嵌

```typescript
// backend/src/services/wechat-provider.ts
import { Payment } from 'wechatpay-axios-plugin';

export class WechatProvider implements PaymentProvider {
  name = 'wechat';
  private payment: Payment;
  
  constructor() {
    this.payment = new Payment({
      appid: process.env.WECHAT_APP_ID,
      mchid: process.env.WECHAT_MCH_ID,
      private_key: process.env.WECHAT_PRIVATE_KEY,
      certificate: process.env.WECHAT_CERTIFICATE
    });
  }
  
  async createPayment(orderData: OrderData): Promise<PaymentResult> {
    // 创建微信预付单
    const result = await this.payment.transactions.jsapi({
      appid: process.env.WECHAT_APP_ID,
      mchid: process.env.WECHAT_MCH_ID,
      description: orderData.productName,
      out_trade_no: orderData.paymentNo,
      amount: {
        total: orderData.amount,
        currency: 'CNY'
      },
      payer: {
        openid: orderData.openid // 前端需要获取用户openid
      }
    });
    
    // 生成前端支付参数
    const paymentParams = {
      appId: process.env.WECHAT_APP_ID,
      timeStamp: Math.floor(Date.now() / 1000).toString(),
      nonceStr: this.generateNonceStr(),
      package: `prepay_id=${result.prepay_id}`,
      signType: 'RSA',
      paySign: this.generatePaySign(paymentParams)
    };
    
    return {
      success: true,
      paymentData: {
        type: 'jsapi',
        params: paymentParams
      }
    };
  }
}
```

### 2.4 Stripe集成 - Elements内嵌

```typescript
// backend/src/services/stripe-provider.ts
import Stripe from 'stripe';

export class StripeProvider implements PaymentProvider {
  name = 'stripe';
  private stripe: Stripe;
  
  constructor() {
    this.stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
      apiVersion: '2023-10-16'
    });
  }
  
  async createPayment(orderData: OrderData): Promise<PaymentResult> {
    // 创建PaymentIntent
    const paymentIntent = await this.stripe.paymentIntents.create({
      amount: orderData.amount,
      currency: 'usd',
      metadata: {
        order_id: orderData.orderId,
        payment_no: orderData.paymentNo
      }
    });
    
    return {
      success: true,
      paymentData: {
        type: 'stripe_elements',
        clientSecret: paymentIntent.client_secret
      }
    };
  }
}
```

---

## 3. 前端支付组件

### 3.1 统一支付组件

```tsx
// frontend/src/components/molecules/PaymentCheckout.tsx
import React, { useState } from 'react';
import { AlipayCheckout } from './AlipayCheckout';
import { WechatCheckout } from './WechatCheckout';
import { StripeCheckout } from './StripeCheckout';

interface PaymentCheckoutProps {
  orderData: OrderData;
  onSuccess: (result: PaymentResult) => void;
  onError: (error: Error) => void;
}

export const PaymentCheckout: React.FC<PaymentCheckoutProps> = ({
  orderData,
  onSuccess,
  onError
}) => {
  const [selectedMethod, setSelectedMethod] = useState<string>('');
  const [paymentData, setPaymentData] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(false);
  
  const handleMethodSelect = async (method: string) => {
    setSelectedMethod(method);
    setIsLoading(true);
    
    try {
      const response = await strapiApi.createPayment({
        ...orderData,
        paymentMethod: method
      });
      
      setPaymentData(response.paymentData);
    } catch (error) {
      onError(error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const renderPaymentWidget = () => {
    if (!paymentData) return null;
    
    switch (selectedMethod) {
      case 'alipay':
        return <AlipayCheckout data={paymentData} onSuccess={onSuccess} onError={onError} />;
      case 'wechat':
        return <WechatCheckout data={paymentData} onSuccess={onSuccess} onError={onError} />;
      case 'stripe':
        return <StripeCheckout data={paymentData} onSuccess={onSuccess} onError={onError} />;
      default:
        return null;
    }
  };
  
  return (
    <div className="payment-checkout bg-white rounded-lg shadow-md p-6">
      <h3 className="text-lg font-semibold mb-4">选择支付方式</h3>
      
      {!selectedMethod && (
        <div className="payment-methods grid grid-cols-1 gap-3">
          <button
            onClick={() => handleMethodSelect('alipay')}
            className="flex items-center p-4 border rounded-lg hover:bg-blue-50"
            disabled={isLoading}
          >
            <img src="/icons/alipay.svg" alt="支付宝" className="w-8 h-8 mr-3" />
            <span>支付宝支付</span>
          </button>
          
          <button
            onClick={() => handleMethodSelect('wechat')}
            className="flex items-center p-4 border rounded-lg hover:bg-green-50"
            disabled={isLoading}
          >
            <img src="/icons/wechat.svg" alt="微信支付" className="w-8 h-8 mr-3" />
            <span>微信支付</span>
          </button>
          
          <button
            onClick={() => handleMethodSelect('stripe')}
            className="flex items-center p-4 border rounded-lg hover:bg-purple-50"
            disabled={isLoading}
          >
            <img src="/icons/stripe.svg" alt="信用卡" className="w-8 h-8 mr-3" />
            <span>信用卡支付</span>
          </button>
        </div>
      )}
      
      {selectedMethod && (
        <div className="payment-widget">
          <div className="mb-4">
            <button
              onClick={() => { setSelectedMethod(''); setPaymentData(null); }}
              className="text-blue-600 hover:text-blue-800"
            >
              ← 重新选择支付方式
            </button>
          </div>
          {renderPaymentWidget()}
        </div>
      )}
    </div>
  );
};
```

### 3.2 支付宝内嵌组件

```tsx
// frontend/src/components/molecules/AlipayCheckout.tsx
export const AlipayCheckout: React.FC<AlipayCheckoutProps> = ({
  data,
  onSuccess,
  onError
}) => {
  const [isProcessing, setIsProcessing] = useState(false);
  
  const handlePay = () => {
    setIsProcessing(true);
    
    // 在当前页面中打开支付宝H5支付
    if (data.type === 'redirect') {
      // 可以选择在iframe中打开，或者新窗口
      window.open(data.url, '_blank', 'width=800,height=600');
      
      // 监听支付结果（可以通过轮询订单状态）
      const checkPaymentStatus = setInterval(async () => {
        try {
          const status = await strapiApi.checkPaymentStatus(data.paymentId);
          if (status.success) {
            clearInterval(checkPaymentStatus);
            setIsProcessing(false);
            onSuccess(status);
          } else if (status.failed) {
            clearInterval(checkPaymentStatus);
            setIsProcessing(false);
            onError(new Error(status.error));
          }
        } catch (error) {
          console.error('Check payment status error:', error);
        }
      }, 2000);
      
      // 10分钟后停止检查
      setTimeout(() => {
        clearInterval(checkPaymentStatus);
        setIsProcessing(false);
      }, 600000);
    }
  };
  
  return (
    <div className="alipay-checkout">
      <div className="text-center">
        <div className="mb-4">
          <img src="/icons/alipay-large.svg" alt="支付宝" className="w-16 h-16 mx-auto" />
        </div>
        <p className="text-gray-600 mb-6">点击按钮完成支付宝支付</p>
        <button
          onClick={handlePay}
          disabled={isProcessing}
          className="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50"
        >
          {isProcessing ? '支付处理中...' : '立即支付'}
        </button>
      </div>
    </div>
  );
};
```

### 3.3 微信JSAPI组件

```tsx
// frontend/src/components/molecules/WechatCheckout.tsx
import { useEffect } from 'react';

declare global {
  interface Window {
    WeixinJSBridge: any;
  }
}

export const WechatCheckout: React.FC<WechatCheckoutProps> = ({
  data,
  onSuccess,
  onError
}) => {
  useEffect(() => {
    if (data.type === 'jsapi' && typeof window.WeixinJSBridge !== 'undefined') {
      // 微信内部浏览器支持
      handleWechatPay();
    }
  }, [data]);
  
  const handleWechatPay = () => {
    if (typeof window.WeixinJSBridge === 'undefined') {
      onError(new Error('请在微信中打开'));
      return;
    }
    
    window.WeixinJSBridge.invoke('getBrandWCPayRequest', {
      ...data.params
    }, (res: any) => {
      if (res.err_msg === 'get_brand_wcpay_request:ok') {
        onSuccess({ success: true });
      } else {
        onError(new Error('支付失败'));
      }
    });
  };
  
  return (
    <div className="wechat-checkout text-center">
      <div className="mb-4">
        <img src="/icons/wechat-large.svg" alt="微信支付" className="w-16 h-16 mx-auto" />
      </div>
      {typeof window.WeixinJSBridge !== 'undefined' ? (
        <>
          <p className="text-gray-600 mb-6">正在调起微信支付...</p>
          <button
            onClick={handleWechatPay}
            className="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700"
          >
            立即支付
          </button>
        </>
      ) : (
        <div>
          <p className="text-gray-600 mb-4">请在微信中打开此页面进行支付</p>
          <div className="qr-code-placeholder bg-gray-100 w-48 h-48 mx-auto rounded-lg flex items-center justify-center">
            <span className="text-gray-500">扫码支付功能</span>
          </div>
        </div>
      )}
    </div>
  );
};
```

---

## 4. 实施计划

### Phase 1: 核心支付功能 (3-5天)
- ✅ 支付服务层开发
- ✅ 支付宝H5集成
- ✅ 基础前端支付组件

### Phase 2: 完善体验 (3-4天)
- ✅ 微信JSAPI集成
- ✅ Stripe Elements集成
- ✅ 支付状态轮询

### Phase 3: 高级功能 (2-3天)
- ✅ 支付回调处理
- ✅ 订单状态同步
- ✅ 错误处理优化

**总开发时间: 8-12天**

---

## 5. 优势总结

✅ **零部署复杂度**: 仅需NPM包，无需额外服务
✅ **完美表结构利用**: 充分利用现有Payment/Order表
✅ **最佳用户体验**: 页面内支付，无跳转
✅ **渐进式扩展**: 可以逐步添加新的支付方式
✅ **完全可控**: 所有数据和逻辑都在自己系统内
✅ **开发效率高**: 8-12天完成vs DaxPay的部署调试时间

这个方案既保持了技术简洁性，又充分利用了我们已有的优秀表设计！