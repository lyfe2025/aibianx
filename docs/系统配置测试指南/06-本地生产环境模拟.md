# 06 - 本地生产环境模拟

> **模拟真实生产环境进行部署测试**

---

## 🎯 模拟目标

在本地环境模拟真实的生产部署：
- ✅ 使用生产级配置
- ✅ Docker容器化部署
- ✅ 本地域名配置
- ✅ 生产环境安全设置
- ✅ 完整服务编排

---

## 🏗️ 架构设计

```
本地生产环境架构：
┌─────────────────────────────────────────────┐
│              bianx.local                    │
├─────────────────┬───────────────────────────┤
│   前端容器       │          后端容器          │
│   (Port 80)     │        (Port 1337)       │
└─────────────────┼───────────────────────────┘
                  │
        ┌─────────┼─────────┐
        │    数据库容器      │
        │   (Port 5432)    │
        ├─────────────────┤
        │   搜索引擎容器    │
        │   (Port 7700)   │
        ├─────────────────┤
        │   邮件系统容器    │
        │   (Port 8080)   │
        └─────────────────┘
```

---

## ✅ 步骤1：域名配置检查

### 检查当前域名配置

```bash
# 检查 /etc/hosts 配置
cat /etc/hosts | grep bianx.local
```

### 确认域名解析

你已经配置了 `127.0.0.1 bianx.local`，我们还需要添加子域名：

```bash
# 检查并添加所需的域名解析
sudo nano /etc/hosts

# 添加以下行（如果还没有）：
127.0.0.1 bianx.local
127.0.0.1 api.bianx.local
127.0.0.1 mail.bianx.local
127.0.0.1 admin.bianx.local
```

### 验证域名解析

```bash
# 测试域名解析
ping -c 1 bianx.local
ping -c 1 api.bianx.local
ping -c 1 mail.bianx.local
```

---

## ✅ 步骤2：1:1生产环境模拟部署

### 使用一键1:1生产部署脚本

```bash
# 使用你的域名进行1:1生产环境模拟
./scripts.sh production local-deploy bianx.local

# 这个脚本会：
# ✅ 使用和真实生产环境完全一致的Docker配置
# ✅ 生成和真实生产环境完全一致的安全配置
# ✅ 启动和真实生产环境完全一致的服务栈
# ✅ 进行和真实生产环境完全一致的健康检查
```

### 1:1模拟的关键特点

**与真实生产环境完全一致：**
- ✅ 相同的Docker Compose配置 (`deployment/docker-compose.unified.yml`)
- ✅ 相同的配置生成逻辑 (`deployment/configure-unified-env.sh`)
- ✅ 相同的安全密钥生成方式
- ✅ 相同的容器编排和网络配置
- ✅ 相同的数据持久化配置
- ✅ 相同的服务健康检查流程

**唯一差异：**
- 🔄 域名：`bianx.local` vs 真实生产域名
- 🔄 SSL：本地跳过SSL vs 生产环境自动SSL

### 检查生成的1:1生产配置

```bash
# 检查生产级配置文件
cat backend/.env           # 和真实生产环境一致的后端配置
cat frontend/.env.local     # 和真实生产环境一致的前端配置
cat .env                    # 和真实生产环境一致的Docker配置

# 验证配置特点
grep "NODE_ENV=production" backend/.env
grep "生产级" backend/.env
```

---

## ✅ 步骤3：验证生产环境配置

### 检查生产配置特点

生产环境配置包含：

1. **安全配置**：
   - 随机生成的安全密钥
   - 生产级密码
   - CORS限制配置

2. **域名配置**：
   - 主域名：`bianx.local`
   - API域名：`api.bianx.local`
   - 邮件域名：`mail.bianx.local`

3. **服务配置**：
   - PostgreSQL生产数据库
   - Redis缓存服务
   - MeiliSearch生产模式
   - BillionMail邮件服务

### 查看配置差异

```bash
# 对比开发环境和生产环境配置
echo "=== 开发环境配置 ==="
grep "NODE_ENV\|DATABASE_NAME\|DOMAIN" backend/.env.example

echo "=== 生产环境配置 ==="
grep "NODE_ENV\|DATABASE_NAME\|DOMAIN" backend/.env
```

---

## ✅ 步骤4：1:1生产服务启动和验证

### 启动完整生产服务栈

脚本会自动启动以下生产级服务：

```bash
# 自动启动的生产服务栈（和真实生产环境一致）
# ✅ PostgreSQL 17数据库
# ✅ Redis 7.4缓存
# ✅ MeiliSearch 1.5搜索引擎  
# ✅ Strapi后端应用（生产模式）
# ✅ Next.js前端应用（生产模式）
# ✅ BillionMail邮件系统（7个容器）
#   - rspamd (反垃圾邮件)
#   - dovecot (IMAP/POP3)
#   - postfix (SMTP)
#   - webmail (RoundCube)
#   - billionmail-core (管理后台)
# ✅ Nginx统一网关（生产配置）
```

### 验证1:1生产服务健康状态

```bash
# 查看所有生产容器状态
cd deployment && docker-compose -f docker-compose.unified.yml ps

# 检查生产服务日志
cd deployment && docker-compose -f docker-compose.unified.yml logs -f --tail=50

# 查看特定服务日志
docker logs aibianx-backend      # 后端应用日志
docker logs aibianx-frontend     # 前端应用日志
docker logs aibianx-postgres     # 数据库日志
docker logs aibianx-billionmail-core  # 邮件系统日志
```

### 生产级健康检查

脚本会自动进行7个层面的健康检查：

1. **🗄️ PostgreSQL数据库** - 数据库连接和查询测试
2. **🧠 Redis缓存** - 缓存服务连通性测试
3. **🔍 MeiliSearch搜索** - 搜索引擎健康检查
4. **⚙️ Strapi后端API** - API接口响应测试
5. **🌐 Next.js前端** - 前端应用加载测试
6. **📧 BillionMail邮件** - 邮件系统访问测试
7. **👤 管理后台** - 后台管理界面测试

---

## ✅ 步骤5：功能验证测试

### 前端应用测试

1. **访问主页**：http://bianx.local
2. **检查功能**：
   - 页面加载正常
   - 样式显示正确
   - 搜索功能正常
   - 用户注册登录

### 后端API测试

```bash
# 测试API连通性
curl http://bianx.local:1337/api

# 测试文章API
curl http://bianx.local:1337/api/articles

# 测试管理后台
curl http://bianx.local:1337/admin
```

### 数据库连接测试

```bash
# 连接生产数据库
docker exec -it aibianx-postgres psql -U aibianx_prod -d aibianx_production

# 检查表结构
\dt

# 检查数据
SELECT COUNT(*) FROM articles;
```

### 搜索引擎测试

```bash
# 测试MeiliSearch
curl http://bianx.local:7700/health

# 测试搜索API
curl "http://bianx.local:7700/indexes/articles/search?q=AI"
```

### 邮件系统测试

```bash
# 测试BillionMail
curl http://mail.bianx.local:8080/billion

# 检查邮件服务状态
docker logs aibianx-billionmail-core
```

---

## ✅ 步骤6：性能和安全测试

### 性能测试

```bash
# 前端性能测试
ab -n 100 -c 10 http://bianx.local/

# API性能测试
ab -n 50 -c 5 http://bianx.local:1337/api/articles

# 搜索性能测试
ab -n 30 -c 3 "http://bianx.local:7700/indexes/articles/search?q=test"
```

### 安全配置验证

```bash
# 检查安全头设置
curl -I http://bianx.local

# 检查CORS配置
curl -H "Origin: http://malicious-site.com" \
     -H "Access-Control-Request-Method: GET" \
     -X OPTIONS http://bianx.local:1337/api
```

---

## ✅ 步骤7：生产环境管理

### 服务管理命令

```bash
# 查看所有服务状态
docker-compose -f docker-compose.local-prod.yml ps

# 重启特定服务
docker-compose -f docker-compose.local-prod.yml restart backend

# 查看服务日志
docker-compose -f docker-compose.local-prod.yml logs -f backend

# 停止所有服务
docker-compose -f docker-compose.local-prod.yml down

# 完全清理（包括数据）
docker-compose -f docker-compose.local-prod.yml down -v
```

### 数据备份

```bash
# 备份生产数据库
docker exec aibianx-postgres pg_dump -U aibianx_prod aibianx_production > backup_prod_$(date +%Y%m%d).sql

# 备份上传文件
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz backend/public/uploads/
```

### 监控命令

```bash
# 实时监控资源使用
docker stats

# 监控特定服务
docker logs -f aibianx-backend
docker logs -f aibianx-frontend
docker logs -f aibianx-postgres
```

---

## 🎯 生产环境访问地址

### 主要服务地址

- **🌐 前端应用**：http://bianx.local
- **🔧 后端API**：http://bianx.local:1337
- **👤 管理后台**：http://bianx.local:1337/admin
- **📊 API文档**：http://bianx.local:1337/documentation
- **🔍 搜索引擎**：http://bianx.local:7700
- **📧 邮件管理**：http://mail.bianx.local:8080/billion
- **📮 WebMail**：http://mail.bianx.local:8080/roundcube

### 管理界面登录

- **Strapi管理员**：使用初始管理员账户
- **BillionMail**：用户名 `billion` / 密码 `billion`
- **MeiliSearch**：使用生成的API密钥

---

## 🔍 故障排查

### 常见问题

1. **域名无法访问**：
   ```bash
   # 检查hosts文件
   cat /etc/hosts | grep bianx.local
   
   # 重新添加域名解析
   echo "127.0.0.1 bianx.local" | sudo tee -a /etc/hosts
   ```

2. **服务启动失败**：
   ```bash
   # 检查端口占用
   lsof -i :80,1337,5432,7700,8080
   
   # 清理冲突服务
   docker-compose -f docker-compose.local-prod.yml down
   ```

3. **数据库连接失败**：
   ```bash
   # 检查数据库容器
   docker logs aibianx-postgres
   
   # 重启数据库
   docker-compose -f docker-compose.local-prod.yml restart postgres
   ```

### 日志查看

```bash
# 查看所有服务日志
docker-compose -f docker-compose.local-prod.yml logs

# 查看特定服务错误
docker-compose -f docker-compose.local-prod.yml logs backend | grep ERROR

# 实时监控日志
docker-compose -f docker-compose.local-prod.yml logs -f
```

---

## 🎉 生产环境模拟完成

### 验收标准

- ✅ 所有服务在容器中正常运行
- ✅ 通过本地域名访问应用
- ✅ 生产级配置和安全设置
- ✅ 数据持久化正常
- ✅ 服务间通信正常
- ✅ 性能满足预期
- ✅ 监控和日志系统工作

### 下一步

完成本地生产环境测试后，你可以：
1. 将配置迁移到真实生产服务器
2. 配置真实域名和SSL证书
3. 设置CI/CD自动部署流程
4. 配置生产监控和告警

**🎯 本地生产环境模拟完成，系统已准备好真实生产部署！**