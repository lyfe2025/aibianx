# 06 - æœ¬åœ°ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿ

> **æ¨¡æ‹ŸçœŸå®ç”Ÿäº§ç¯å¢ƒè¿›è¡Œéƒ¨ç½²æµ‹è¯•**

---

## ğŸ¯ æ¨¡æ‹Ÿç›®æ ‡

åœ¨æœ¬åœ°ç¯å¢ƒæ¨¡æ‹ŸçœŸå®çš„ç”Ÿäº§éƒ¨ç½²ï¼š
- âœ… ä½¿ç”¨ç”Ÿäº§çº§é…ç½®
- âœ… Dockerå®¹å™¨åŒ–éƒ¨ç½²
- âœ… æœ¬åœ°åŸŸåé…ç½®
- âœ… ç”Ÿäº§ç¯å¢ƒå®‰å…¨è®¾ç½®
- âœ… å®Œæ•´æœåŠ¡ç¼–æ’

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
æœ¬åœ°ç”Ÿäº§ç¯å¢ƒæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              bianx.local                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å‰ç«¯å®¹å™¨       â”‚          åç«¯å®¹å™¨          â”‚
â”‚   (Port 80)     â”‚        (Port 1337)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    æ•°æ®åº“å®¹å™¨      â”‚
        â”‚   (Port 5432)    â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   æœç´¢å¼•æ“å®¹å™¨    â”‚
        â”‚   (Port 7700)   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚   é‚®ä»¶ç³»ç»Ÿå®¹å™¨    â”‚
        â”‚   (Port 8080)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æ­¥éª¤1ï¼šåŸŸåé…ç½®æ£€æŸ¥

### æ£€æŸ¥å½“å‰åŸŸåé…ç½®

```bash
# æ£€æŸ¥ /etc/hosts é…ç½®
cat /etc/hosts | grep bianx.local
```

### ç¡®è®¤åŸŸåè§£æ

ä½ å·²ç»é…ç½®äº† `127.0.0.1 bianx.local`ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ å­åŸŸåï¼š

```bash
# æ£€æŸ¥å¹¶æ·»åŠ æ‰€éœ€çš„åŸŸåè§£æ
sudo nano /etc/hosts

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š
127.0.0.1 bianx.local
127.0.0.1 api.bianx.local
127.0.0.1 mail.bianx.local
127.0.0.1 admin.bianx.local
```

### éªŒè¯åŸŸåè§£æ

```bash
# æµ‹è¯•åŸŸåè§£æ
ping -c 1 bianx.local
ping -c 1 api.bianx.local
ping -c 1 mail.bianx.local
```

---

## âœ… æ­¥éª¤2ï¼š1:1ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿéƒ¨ç½²

### ä½¿ç”¨ä¸€é”®1:1ç”Ÿäº§éƒ¨ç½²è„šæœ¬

```bash
# ä½¿ç”¨ä½ çš„åŸŸåè¿›è¡Œ1:1ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿ
./scripts.sh production local-deploy bianx.local

# è¿™ä¸ªè„šæœ¬ä¼šï¼š
# âœ… ä½¿ç”¨å’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´çš„Dockeré…ç½®
# âœ… ç”Ÿæˆå’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´çš„å®‰å…¨é…ç½®
# âœ… å¯åŠ¨å’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´çš„æœåŠ¡æ ˆ
# âœ… è¿›è¡Œå’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´çš„å¥åº·æ£€æŸ¥
```

### 1:1æ¨¡æ‹Ÿçš„å…³é”®ç‰¹ç‚¹

**ä¸çœŸå®ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´ï¼š**
- âœ… ç›¸åŒçš„Docker Composeé…ç½® (`deployment/docker-compose.unified.yml`)
- âœ… ç›¸åŒçš„é…ç½®ç”Ÿæˆé€»è¾‘ (`deployment/configure-unified-env.sh`)
- âœ… ç›¸åŒçš„å®‰å…¨å¯†é’¥ç”Ÿæˆæ–¹å¼
- âœ… ç›¸åŒçš„å®¹å™¨ç¼–æ’å’Œç½‘ç»œé…ç½®
- âœ… ç›¸åŒçš„æ•°æ®æŒä¹…åŒ–é…ç½®
- âœ… ç›¸åŒçš„æœåŠ¡å¥åº·æ£€æŸ¥æµç¨‹

**å”¯ä¸€å·®å¼‚ï¼š**
- ğŸ”„ åŸŸåï¼š`bianx.local` vs çœŸå®ç”Ÿäº§åŸŸå
- ğŸ”„ SSLï¼šæœ¬åœ°è·³è¿‡SSL vs ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨SSL

### æ£€æŸ¥ç”Ÿæˆçš„1:1ç”Ÿäº§é…ç½®

```bash
# æ£€æŸ¥ç”Ÿäº§çº§é…ç½®æ–‡ä»¶
cat backend/.env           # å’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒä¸€è‡´çš„åç«¯é…ç½®
cat frontend/.env.local     # å’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒä¸€è‡´çš„å‰ç«¯é…ç½®
cat .env                    # å’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒä¸€è‡´çš„Dockeré…ç½®

# éªŒè¯é…ç½®ç‰¹ç‚¹
grep "NODE_ENV=production" backend/.env
grep "ç”Ÿäº§çº§" backend/.env
```

---

## âœ… æ­¥éª¤3ï¼šéªŒè¯ç”Ÿäº§ç¯å¢ƒé…ç½®

### æ£€æŸ¥ç”Ÿäº§é…ç½®ç‰¹ç‚¹

ç”Ÿäº§ç¯å¢ƒé…ç½®åŒ…å«ï¼š

1. **å®‰å…¨é…ç½®**ï¼š
   - éšæœºç”Ÿæˆçš„å®‰å…¨å¯†é’¥
   - ç”Ÿäº§çº§å¯†ç 
   - CORSé™åˆ¶é…ç½®

2. **åŸŸåé…ç½®**ï¼š
   - ä¸»åŸŸåï¼š`bianx.local`
   - APIåŸŸåï¼š`api.bianx.local`
   - é‚®ä»¶åŸŸåï¼š`mail.bianx.local`

3. **æœåŠ¡é…ç½®**ï¼š
   - PostgreSQLç”Ÿäº§æ•°æ®åº“
   - Redisç¼“å­˜æœåŠ¡
   - MeiliSearchç”Ÿäº§æ¨¡å¼
   - BillionMailé‚®ä»¶æœåŠ¡

### æŸ¥çœ‹é…ç½®å·®å¼‚

```bash
# å¯¹æ¯”å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒé…ç½®
echo "=== å¼€å‘ç¯å¢ƒé…ç½® ==="
grep "NODE_ENV\|DATABASE_NAME\|DOMAIN" backend/.env.example

echo "=== ç”Ÿäº§ç¯å¢ƒé…ç½® ==="
grep "NODE_ENV\|DATABASE_NAME\|DOMAIN" backend/.env
```

---

## âœ… æ­¥éª¤4ï¼š1:1ç”Ÿäº§æœåŠ¡å¯åŠ¨å’ŒéªŒè¯

### å¯åŠ¨å®Œæ•´ç”Ÿäº§æœåŠ¡æ ˆ

è„šæœ¬ä¼šè‡ªåŠ¨å¯åŠ¨ä»¥ä¸‹ç”Ÿäº§çº§æœåŠ¡ï¼š

```bash
# è‡ªåŠ¨å¯åŠ¨çš„ç”Ÿäº§æœåŠ¡æ ˆï¼ˆå’ŒçœŸå®ç”Ÿäº§ç¯å¢ƒä¸€è‡´ï¼‰
# âœ… PostgreSQL 17æ•°æ®åº“
# âœ… Redis 7.4ç¼“å­˜
# âœ… MeiliSearch 1.5æœç´¢å¼•æ“  
# âœ… Strapiåç«¯åº”ç”¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
# âœ… Next.jså‰ç«¯åº”ç”¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
# âœ… BillionMailé‚®ä»¶ç³»ç»Ÿï¼ˆ7ä¸ªå®¹å™¨ï¼‰
#   - rspamd (ååƒåœ¾é‚®ä»¶)
#   - dovecot (IMAP/POP3)
#   - postfix (SMTP)
#   - webmail (RoundCube)
#   - billionmail-core (ç®¡ç†åå°)
# âœ… Nginxç»Ÿä¸€ç½‘å…³ï¼ˆç”Ÿäº§é…ç½®ï¼‰
```

### éªŒè¯1:1ç”Ÿäº§æœåŠ¡å¥åº·çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰ç”Ÿäº§å®¹å™¨çŠ¶æ€
cd deployment && docker-compose -f docker-compose.unified.yml ps

# æ£€æŸ¥ç”Ÿäº§æœåŠ¡æ—¥å¿—
cd deployment && docker-compose -f docker-compose.unified.yml logs -f --tail=50

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker logs aibianx-backend      # åç«¯åº”ç”¨æ—¥å¿—
docker logs aibianx-frontend     # å‰ç«¯åº”ç”¨æ—¥å¿—
docker logs aibianx-postgres     # æ•°æ®åº“æ—¥å¿—
docker logs aibianx-billionmail-core  # é‚®ä»¶ç³»ç»Ÿæ—¥å¿—
```

### ç”Ÿäº§çº§å¥åº·æ£€æŸ¥

è„šæœ¬ä¼šè‡ªåŠ¨è¿›è¡Œ7ä¸ªå±‚é¢çš„å¥åº·æ£€æŸ¥ï¼š

1. **ğŸ—„ï¸ PostgreSQLæ•°æ®åº“** - æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢æµ‹è¯•
2. **ğŸ§  Redisç¼“å­˜** - ç¼“å­˜æœåŠ¡è¿é€šæ€§æµ‹è¯•
3. **ğŸ” MeiliSearchæœç´¢** - æœç´¢å¼•æ“å¥åº·æ£€æŸ¥
4. **âš™ï¸ Strapiåç«¯API** - APIæ¥å£å“åº”æµ‹è¯•
5. **ğŸŒ Next.jså‰ç«¯** - å‰ç«¯åº”ç”¨åŠ è½½æµ‹è¯•
6. **ğŸ“§ BillionMailé‚®ä»¶** - é‚®ä»¶ç³»ç»Ÿè®¿é—®æµ‹è¯•
7. **ğŸ‘¤ ç®¡ç†åå°** - åå°ç®¡ç†ç•Œé¢æµ‹è¯•

---

## âœ… æ­¥éª¤5ï¼šåŠŸèƒ½éªŒè¯æµ‹è¯•

### å‰ç«¯åº”ç”¨æµ‹è¯•

1. **è®¿é—®ä¸»é¡µ**ï¼šhttp://bianx.local
2. **æ£€æŸ¥åŠŸèƒ½**ï¼š
   - é¡µé¢åŠ è½½æ­£å¸¸
   - æ ·å¼æ˜¾ç¤ºæ­£ç¡®
   - æœç´¢åŠŸèƒ½æ­£å¸¸
   - ç”¨æˆ·æ³¨å†Œç™»å½•

### åç«¯APIæµ‹è¯•

```bash
# æµ‹è¯•APIè¿é€šæ€§
curl http://bianx.local:1337/api

# æµ‹è¯•æ–‡ç« API
curl http://bianx.local:1337/api/articles

# æµ‹è¯•ç®¡ç†åå°
curl http://bianx.local:1337/admin
```

### æ•°æ®åº“è¿æ¥æµ‹è¯•

```bash
# è¿æ¥ç”Ÿäº§æ•°æ®åº“
docker exec -it aibianx-postgres psql -U aibianx_prod -d aibianx_production

# æ£€æŸ¥è¡¨ç»“æ„
\dt

# æ£€æŸ¥æ•°æ®
SELECT COUNT(*) FROM articles;
```

### æœç´¢å¼•æ“æµ‹è¯•

```bash
# æµ‹è¯•MeiliSearch
curl http://bianx.local:7700/health

# æµ‹è¯•æœç´¢API
curl "http://bianx.local:7700/indexes/articles/search?q=AI"
```

### é‚®ä»¶ç³»ç»Ÿæµ‹è¯•

```bash
# æµ‹è¯•BillionMail
curl http://mail.bianx.local:8080/billion

# æ£€æŸ¥é‚®ä»¶æœåŠ¡çŠ¶æ€
docker logs aibianx-billionmail-core
```

---

## âœ… æ­¥éª¤6ï¼šæ€§èƒ½å’Œå®‰å…¨æµ‹è¯•

### æ€§èƒ½æµ‹è¯•

```bash
# å‰ç«¯æ€§èƒ½æµ‹è¯•
ab -n 100 -c 10 http://bianx.local/

# APIæ€§èƒ½æµ‹è¯•
ab -n 50 -c 5 http://bianx.local:1337/api/articles

# æœç´¢æ€§èƒ½æµ‹è¯•
ab -n 30 -c 3 "http://bianx.local:7700/indexes/articles/search?q=test"
```

### å®‰å…¨é…ç½®éªŒè¯

```bash
# æ£€æŸ¥å®‰å…¨å¤´è®¾ç½®
curl -I http://bianx.local

# æ£€æŸ¥CORSé…ç½®
curl -H "Origin: http://malicious-site.com" \
     -H "Access-Control-Request-Method: GET" \
     -X OPTIONS http://bianx.local:1337/api
```

---

## âœ… æ­¥éª¤7ï¼šç”Ÿäº§ç¯å¢ƒç®¡ç†

### æœåŠ¡ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.local-prod.yml ps

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.local-prod.yml restart backend

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.local-prod.yml logs -f backend

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.local-prod.yml down

# å®Œå…¨æ¸…ç†ï¼ˆåŒ…æ‹¬æ•°æ®ï¼‰
docker-compose -f docker-compose.local-prod.yml down -v
```

### æ•°æ®å¤‡ä»½

```bash
# å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
docker exec aibianx-postgres pg_dump -U aibianx_prod aibianx_production > backup_prod_$(date +%Y%m%d).sql

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz backend/public/uploads/
```

### ç›‘æ§å‘½ä»¤

```bash
# å®æ—¶ç›‘æ§èµ„æºä½¿ç”¨
docker stats

# ç›‘æ§ç‰¹å®šæœåŠ¡
docker logs -f aibianx-backend
docker logs -f aibianx-frontend
docker logs -f aibianx-postgres
```

---

## ğŸ¯ ç”Ÿäº§ç¯å¢ƒè®¿é—®åœ°å€

### ä¸»è¦æœåŠ¡åœ°å€

- **ğŸŒ å‰ç«¯åº”ç”¨**ï¼šhttp://bianx.local
- **ğŸ”§ åç«¯API**ï¼šhttp://bianx.local:1337
- **ğŸ‘¤ ç®¡ç†åå°**ï¼šhttp://bianx.local:1337/admin
- **ğŸ“Š APIæ–‡æ¡£**ï¼šhttp://bianx.local:1337/documentation
- **ğŸ” æœç´¢å¼•æ“**ï¼šhttp://bianx.local:7700
- **ğŸ“§ é‚®ä»¶ç®¡ç†**ï¼šhttp://mail.bianx.local:8080/billion
- **ğŸ“® WebMail**ï¼šhttp://mail.bianx.local:8080/roundcube

### ç®¡ç†ç•Œé¢ç™»å½•

- **Strapiç®¡ç†å‘˜**ï¼šä½¿ç”¨åˆå§‹ç®¡ç†å‘˜è´¦æˆ·
- **BillionMail**ï¼šç”¨æˆ·å `billion` / å¯†ç  `billion`
- **MeiliSearch**ï¼šä½¿ç”¨ç”Ÿæˆçš„APIå¯†é’¥

---

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **åŸŸåæ— æ³•è®¿é—®**ï¼š
   ```bash
   # æ£€æŸ¥hostsæ–‡ä»¶
   cat /etc/hosts | grep bianx.local
   
   # é‡æ–°æ·»åŠ åŸŸåè§£æ
   echo "127.0.0.1 bianx.local" | sudo tee -a /etc/hosts
   ```

2. **æœåŠ¡å¯åŠ¨å¤±è´¥**ï¼š
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   lsof -i :80,1337,5432,7700,8080
   
   # æ¸…ç†å†²çªæœåŠ¡
   docker-compose -f docker-compose.local-prod.yml down
   ```

3. **æ•°æ®åº“è¿æ¥å¤±è´¥**ï¼š
   ```bash
   # æ£€æŸ¥æ•°æ®åº“å®¹å™¨
   docker logs aibianx-postgres
   
   # é‡å¯æ•°æ®åº“
   docker-compose -f docker-compose.local-prod.yml restart postgres
   ```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose -f docker-compose.local-prod.yml logs

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡é”™è¯¯
docker-compose -f docker-compose.local-prod.yml logs backend | grep ERROR

# å®æ—¶ç›‘æ§æ—¥å¿—
docker-compose -f docker-compose.local-prod.yml logs -f
```

---

## ğŸ‰ ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿå®Œæˆ

### éªŒæ”¶æ ‡å‡†

- âœ… æ‰€æœ‰æœåŠ¡åœ¨å®¹å™¨ä¸­æ­£å¸¸è¿è¡Œ
- âœ… é€šè¿‡æœ¬åœ°åŸŸåè®¿é—®åº”ç”¨
- âœ… ç”Ÿäº§çº§é…ç½®å’Œå®‰å…¨è®¾ç½®
- âœ… æ•°æ®æŒä¹…åŒ–æ­£å¸¸
- âœ… æœåŠ¡é—´é€šä¿¡æ­£å¸¸
- âœ… æ€§èƒ½æ»¡è¶³é¢„æœŸ
- âœ… ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿå·¥ä½œ

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬åœ°ç”Ÿäº§ç¯å¢ƒæµ‹è¯•åï¼Œä½ å¯ä»¥ï¼š
1. å°†é…ç½®è¿ç§»åˆ°çœŸå®ç”Ÿäº§æœåŠ¡å™¨
2. é…ç½®çœŸå®åŸŸåå’ŒSSLè¯ä¹¦
3. è®¾ç½®CI/CDè‡ªåŠ¨éƒ¨ç½²æµç¨‹
4. é…ç½®ç”Ÿäº§ç›‘æ§å’Œå‘Šè­¦

**ğŸ¯ æœ¬åœ°ç”Ÿäº§ç¯å¢ƒæ¨¡æ‹Ÿå®Œæˆï¼Œç³»ç»Ÿå·²å‡†å¤‡å¥½çœŸå®ç”Ÿäº§éƒ¨ç½²ï¼**