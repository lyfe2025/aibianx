# 03 - 支付系统配置

> **第三步：配置三大支付平台集成**

---

## 🎯 配置目标

配置支付宝、微信支付、PayPal三大支付平台：
- ✅ 会员订阅支付
- ✅ 订单管理
- ✅ 支付回调处理
- ✅ 退款管理

---

## ✅ 步骤1：支付平台申请

### 开发环境（沙箱测试）

#### 支付宝沙箱
1. 访问：https://openhome.alipay.com/develop/sandbox/app
2. 获取沙箱应用信息：
   - APPID
   - 私钥
   - 公钥
   - 网关地址

#### 微信支付沙箱
1. 访问：https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_1
2. 获取测试参数：
   - 商户号
   - API密钥
   - 证书文件

#### PayPal沙箱
1. 访问：https://developer.paypal.com/
2. 创建沙箱应用获取：
   - Client ID
   - Client Secret

---

## ✅ 步骤2：配置支付参数

### 编辑 `backend/.env` 添加支付配置：

```bash
# 支付宝配置
ALIPAY_APP_ID=你的支付宝APPID
ALIPAY_PRIVATE_KEY=你的支付宝私钥
ALIPAY_PUBLIC_KEY=支付宝公钥
ALIPAY_GATEWAY=https://openapi.alipaydev.com/gateway.do

# 微信支付配置
WECHAT_APP_ID=你的微信APPID
WECHAT_MCH_ID=你的商户号
WECHAT_API_KEY=你的API密钥
WECHAT_CERT_PATH=证书文件路径

# PayPal配置
PAYPAL_CLIENT_ID=你的PayPal客户端ID
PAYPAL_CLIENT_SECRET=你的PayPal密钥
PAYPAL_SANDBOX=true
```

---

## ✅ 步骤3：测试支付配置

```bash
# 测试支付系统
./scripts/test/payment-system-test.sh

# 检查支付配置
curl http://localhost:1337/api/payment-config
```

---

## ✅ 步骤4：配置支付商品

### 在Strapi后台配置会员套餐

1. 访问：http://localhost:1337/admin
2. 进入"Payment Configs" → 添加支付配置
3. 配置会员套餐：

```json
{
  "name": "月度会员",
  "price": 9900,  // 99.00元（分为单位）
  "currency": "CNY",
  "description": "月度VIP会员权益",
  "features": ["无限制访问", "专属内容", "专家咨询"],
  "duration": 30,
  "type": "subscription"
}
```

---

## ✅ 步骤5：测试支付流程

### 前端支付测试

1. 访问：http://localhost
2. 点击"升级会员"或访问：http://localhost/membership
3. 选择会员套餐
4. 测试支付流程：
   - 支付宝支付
   - 微信支付
   - PayPal支付

### 验证支付数据

```bash
# 检查订单数据
curl http://localhost:1337/api/orders

# 检查支付记录
curl http://localhost:1337/api/payments

# 检查订阅状态
curl http://localhost:1337/api/subscriptions
```

---

## ✅ 步骤6：测试支付回调

### 模拟支付回调

```bash
# 测试支付宝回调
curl -X POST http://localhost:1337/api/payment/alipay/notify \
  -H "Content-Type: application/json" \
  -d '{"trade_status":"TRADE_SUCCESS","out_trade_no":"test_order_123"}'

# 测试微信支付回调
curl -X POST http://localhost:1337/api/payment/wechat/notify \
  -H "Content-Type: application/xml" \
  -d '<xml><return_code>SUCCESS</return_code></xml>'
```

---

## ✅ 步骤7：测试退款功能

### 退款测试

1. 在后台选择一个已支付订单
2. 点击"申请退款"
3. 验证退款流程和状态更新

```bash
# 检查退款记录
curl http://localhost:1337/api/refunds
```

---

## 🎯 配置完成标志

- ✅ 支付平台配置正确
- ✅ 支付接口连通正常
- ✅ 会员套餐配置完成
- ✅ 前端支付流程正常
- ✅ 支付回调处理正确
- ✅ 订单数据记录正常
- ✅ 退款功能正常

**完成后进入下一步：用户认证系统测试**