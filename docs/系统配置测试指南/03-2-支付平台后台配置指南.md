# 三大支付平台后台配置指南

> **目标**: 在Strapi后台管理界面配置支付宝、微信支付、Stripe三大支付平台
> **前提**: 已完成支付平台申请，获得相关配置信息
> **访问**: http://localhost:1337/admin → 内容管理器 → 支付配置

---

## 🔧 **配置前准备**

### **Step 1: 启动服务**
```bash
# 启动后端服务
cd backend && npm run dev

# 启动前端服务 (另一个终端)
cd frontend && npm run dev
```

### **Step 2: 运行字段描述配置**
```bash
# 配置中文字段描述
./scripts/tools/configure-payment-config-descriptions.sh
```

### **Step 3: 登录后台**
1. 访问：http://localhost:1337/admin
2. 使用管理员账号登录
3. 进入：内容管理器 → 单一类型 → 支付配置

---

## 🌐 **基础环境配置**

### **运行环境设置**
```
运行环境: 
- sandbox (开发测试，推荐先用这个)
- production (生产环境，正式上线时使用)

回调基础URL:
- 开发: http://localhost:1337
- 生产: https://yourdomain.com

前端基础URL:
- 开发: http://localhost  
- 生产: https://yourdomain.com

Webhook密钥: (可选)
- 自定义密钥用于额外安全验证
```

### **通用配置设置**
```
网站名称: AI变现之路
支付超时时间: 30 分钟
启用支付日志: 是 ✅
启用自动退款: 否 (建议手动处理)
最小支付金额: 1 分 (0.01元)
最大支付金额: 100000 分 (1000元，可根据需要调整)
```

---

## 📱 **支付宝配置**

### **基础配置**
```
启用支付宝支付: true ✅
配置状态: 
- draft (草稿)
- configured (已配置)  
- testing (测试中)
- active (已激活) ← 最终目标
```

### **核心参数配置**

#### **应用信息**
```
应用ID: 2021001234567890
(从支付宝开放平台获取，长度通常16位)

网关地址:
- 沙箱: https://openapi.alipaydev.com/gateway.do
- 生产: https://openapi.alipay.com/gateway.do

签名类型: RSA2 (推荐)
字符编码: utf-8
```

#### **密钥配置** ⚠️ 重要
```
应用私钥: 
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC...
(完整的RSA私钥，包含BEGIN/END标记，保持换行格式)
-----END PRIVATE KEY-----

支付宝公钥:
-----BEGIN PUBLIC KEY-----  
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
(完整的支付宝公钥，包含BEGIN/END标记，保持换行格式)
-----END PUBLIC KEY-----
```

**⚠️ 密钥配置注意事项**:
- 必须包含 `-----BEGIN` 和 `-----END` 标记
- 保持原有换行格式，不要删除换行符
- 不要添加额外的空格或特殊字符
- 复制时确保内容完整

#### **支持的支付方式**
```json
{
  "web": true,          // 电脑网站支付
  "wap": true,          // 手机网站支付 (主要使用)
  "app": false,         // APP支付 (暂不支持)
  "qrcode": true        // 扫码支付
}
```

#### **回调地址** (自动生成)
```
异步通知地址: {callbackBaseUrl}/api/payments/alipay/callback
同步跳转地址: {callbackBaseUrl}/api/payments/alipay/return
取消跳转地址: {callbackBaseUrl}/api/payments/alipay/cancel
```

### **测试配置示例**
```
应用ID: 9021000000000000 (沙箱固定ID)
网关地址: https://openapi.alipaydev.com/gateway.do
应用私钥: [沙箱应用私钥]
支付宝公钥: [沙箱支付宝公钥]
```

---

## 💬 **微信支付配置**

### **基础配置**
```
启用微信支付: true ✅
配置状态: draft → configured → testing → active
API版本: v3 (推荐使用)
```

### **核心参数配置**

#### **应用信息**
```
应用ID: wx1234567890abcdef
(微信公众号或小程序的AppID，18位字符)

商户号: 1234567890  
(微信支付商户号，10位数字)
```

#### **API密钥配置**
```
API密钥 (APIv2): 
32位字符串密钥，如：
abcd1234efgh5678ijkl9012mnop3456

API私钥 (APIv3):
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwgg...
(商户API私钥，用于APIv3签名)
-----END PRIVATE KEY-----

API证书 (APIv3):
-----BEGIN CERTIFICATE-----
MIIEbjCCA1agAwIBAgIUC7hQnX3Ld6cg9P...
(商户API证书，用于APIv3身份验证)
-----END CERTIFICATE-----
```

#### **支持的支付方式**
```json
{
  "jsapi": true,        // 公众号支付 (主要使用)
  "h5": true,          // H5支付
  "native": true,      // 扫码支付
  "app": false,        // APP支付 (暂不支持)
  "miniprogram": false // 小程序支付 (暂不支持)
}
```

#### **域名配置**
```
JSAPI支付域名: yourdomain.com
(需在微信商户平台配置支付授权目录)

H5支付域名: yourdomain.com
(需在微信商户平台配置H5支付域名)
```

#### **回调地址** (自动生成)
```
异步通知地址: {callbackBaseUrl}/api/payments/wechat/callback
退款通知地址: {callbackBaseUrl}/api/payments/wechat/refund-callback
同步跳转地址: {callbackBaseUrl}/api/payments/wechat/return
取消跳转地址: {callbackBaseUrl}/api/payments/wechat/cancel
```

### **微信公众号配置** (JSAPI支付需要)
如果要使用JSAPI支付，需要额外配置：
1. 注册微信公众号：https://mp.weixin.qq.com/
2. 在微信支付商户平台关联公众号
3. 在上述配置中填入公众号的AppID

---

## 💳 **Stripe配置**

### **基础配置**
```
启用Stripe支付: true ✅
配置状态: draft → configured → testing → active
API版本: 2023-10-16
默认货币: usd (或 cny、eur 等)
```

### **核心参数配置**

#### **API密钥**
```
可发布密钥 (前端使用):
- 测试: pk_test_51xxxxx...
- 生产: pk_live_51xxxxx...

密钥 (后端使用):
- 测试: sk_test_51xxxxx...  
- 生产: sk_live_51xxxxx...

Webhook密钥:
whsec_xxxxx...
(用于验证Webhook回调的签名)
```

#### **支持的货币**
```json
["usd", "eur", "cny", "jpy", "hkd"]
```

#### **支持的支付方式**
```json
{
  "card": true,         // 信用卡支付 (主要使用)
  "alipay": true,       // 支付宝国际版
  "wechat_pay": false,  // 微信支付国际版
  "paypal": false       // PayPal (可选开启)
}
```

#### **高级配置**
```
启用Apple Pay: false (可选)
启用Google Pay: false (可选)
启用自动支付方式检测: true (推荐)
```

#### **Webhook配置**
```
Webhook端点: {callbackBaseUrl}/api/payments/stripe/webhook
支持的事件:
- payment_intent.succeeded
- payment_intent.payment_failed
- payment_intent.canceled
```

---

## ✅ **配置验证**

### **保存配置**
1. 填写完所有必要信息
2. 点击页面底部的"保存"按钮  
3. 确认配置保存成功

### **测试配置连接**
保存后可通过API测试各支付方式配置：

```bash
# 测试支付宝配置
curl -X POST "http://localhost:1337/api/payment-config/test/alipay" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# 测试微信支付配置
curl -X POST "http://localhost:1337/api/payment-config/test/wechat" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# 测试Stripe配置  
curl -X POST "http://localhost:1337/api/payment-config/test/stripe" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

### **前端验证**
检查前端是否能获取到可用的支付方式：
```bash
curl "http://localhost:1337/api/payment-config/available-methods"
```

期望响应：
```json
{
  "success": true,
  "data": {
    "availableMethods": [
      {
        "id": "alipay",
        "name": "支付宝", 
        "icon": "/icons/alipay.svg"
      },
      {
        "id": "wechat",
        "name": "微信支付",
        "icon": "/icons/wechat.svg"  
      },
      {
        "id": "stripe", 
        "name": "信用卡支付",
        "icon": "/icons/stripe.svg"
      }
    ]
  }
}
```

---

## 🧪 **测试流程**

### **配置状态迁移**
1. **draft** (草稿) → 刚创建配置
2. **configured** (已配置) → 填写完基本信息  
3. **testing** (测试中) → 进行沙箱测试
4. **active** (已激活) → 测试通过，正式启用

### **沙箱测试步骤**

#### **支付宝测试**
1. 确保使用沙箱网关和密钥
2. 使用测试账号：jvojfm4615@sandbox.com / 111111
3. 创建小额测试订单进行支付
4. 验证回调和状态更新

#### **微信支付测试**  
1. 使用真实商户号（微信支付无沙箱）
2. 创建1分钱测试订单
3. 完成支付流程验证
4. 检查回调处理

#### **Stripe测试**
1. 使用测试密钥
2. 使用测试卡号：4242 4242 4242 4242
3. 完成支付流程
4. 验证Webhook接收

### **生产环境切换**
测试通过后，切换到生产环境：
1. 修改"运行环境"为 production
2. 更新API密钥为生产环境密钥
3. 更新回调URL为正式域名
4. 将配置状态设为 active

---

## ⚠️ **安全注意事项**

### **密钥安全**
- ❌ 绝不在前端代码中暴露私钥
- ✅ 使用环境变量存储敏感信息  
- ✅ 定期轮换API密钥
- ✅ 限制后台登录IP(生产环境)

### **回调安全**
- ✅ 验证所有回调签名
- ✅ 检查订单金额和状态
- ✅ 防止重复处理同一回调
- ✅ 记录所有回调日志

### **配置备份**
- ✅ 定期导出支付配置
- ✅ 记录配置变更历史
- ✅ 测试和生产环境配置分离

---

## 🐛 **常见问题解决**

### **Q1: 找不到"支付配置"选项**
**解决**:
1. 确保已运行字段描述配置脚本
2. 重启后端服务
3. 清除浏览器缓存重新登录

### **Q2: 密钥格式错误**  
**解决**:
1. 确保复制完整密钥内容，包含BEGIN/END标记
2. 保持原有换行格式，不要删除换行符
3. 检查是否有多余空格或特殊字符

### **Q3: 回调地址无法访问**
**解决**:
1. 检查回调基础URL配置是否正确
2. 确保域名可从外网访问(生产环境)
3. 在第三方平台正确配置回调地址

### **Q4: 支付创建失败**
**解决**:
1. 检查配置状态是否为"active"
2. 验证API密钥是否正确
3. 查看后端日志排查具体错误
4. 确认网络连接正常

### **Q5: 测试支付不成功**
**解决**:
1. 确认使用的是测试环境配置
2. 检查测试账号和密钥是否正确
3. 验证回调URL是否可访问
4. 查看支付平台的交易记录

---

## 📋 **配置检查清单**

### ✅ **支付宝配置检查**
- [ ] AppID填写正确
- [ ] 应用私钥格式正确(包含BEGIN/END)
- [ ] 支付宝公钥格式正确  
- [ ] 网关地址与环境匹配
- [ ] 配置状态设为active
- [ ] 回调地址可从外网访问

### ✅ **微信支付配置检查**
- [ ] AppID和商户号填写正确
- [ ] API密钥长度为32位
- [ ] API私钥格式正确(v3)
- [ ] API证书格式正确(v3)  
- [ ] 支付域名已在商户平台配置
- [ ] 配置状态设为active

### ✅ **Stripe配置检查**
- [ ] 可发布密钥以pk_开头
- [ ] 密钥以sk_开头
- [ ] Webhook密钥以whsec_开头
- [ ] API版本号正确
- [ ] 支持的货币列表正确
- [ ] 配置状态设为active

### ✅ **通用配置检查**  
- [ ] 运行环境设置正确
- [ ] 回调基础URL可访问
- [ ] 前端基础URL正确
- [ ] 支付超时时间合理
- [ ] 金额限制符合业务需求

---

## 🎯 **配置完成后**

### **前端集成测试**
```tsx
import { PaymentCheckout } from '@/components/molecules';

// 测试支付组件
<PaymentCheckout
  orderData={{
    orderId: "test_order_001",
    amount: 100, // 1元测试  
    productName: "测试商品"
  }}
  onSuccess={(result) => console.log('支付成功:', result)}
  onError={(error) => console.error('支付失败:', error)}
/>
```

### **API接口测试**
```bash
# 获取可用支付方式
curl "http://localhost:1337/api/payment-config/available-methods"

# 创建测试支付(需要用户Token)
curl -X POST "http://localhost:1337/api/payments/create" \
  -H "Authorization: Bearer USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "orderId": "test_001",
    "paymentMethod": "alipay", 
    "amount": 100,
    "productName": "测试商品"
  }'
```

---

## 🎉 **配置完成**

恭喜！您已成功配置三大支付平台，现在可以：

1. **开始业务测试** - 使用沙箱环境测试支付流程
2. **完善前端UI** - 集成支付组件到实际页面
3. **监控支付数据** - 关注支付成功率和用户体验
4. **准备上线** - 切换到生产环境配置

**需要帮助？**
- 查看 [支付接入申请配置指南](./支付接入申请配置指南.md)
- 参考 [API端点文档](../../API-ENDPOINTS.md#支付系统)
- 查看后端日志: `tail -f logs/backend.log`

**祝您支付系统运行顺利！** 🚀