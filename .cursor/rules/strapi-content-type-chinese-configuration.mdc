# Strapi内容类型中文配置专用规则（实战优化版）

---

## 🎯 核心目标

基于"AI变现之路"项目的大量实战修复经验，确保每个新建的Strapi内容类型都**100%符合**以下3个标准：

1. **✅ 有字段注释且中文** - 数据库字段级别的中文注释
2. **✅ 有字段描述且中文** - Admin UI字段标签和描述的中文化  
3. **✅ 表单无重复字段** - Admin UI中字段不重复显示

---

## 📋 **强制执行**标准化操作流程

### 🔥 **阶段一：内容类型创建（设计阶段）**

#### **1.1 Schema.json文件创建**
```json
{
  "kind": "collectionType",
  "collectionName": "[英文复数名]",
  "info": {
    "singularName": "[英文单数名]",
    "pluralName": "[英文复数名]",
    "displayName": "[中文显示名]",
    "description": "[中文详细描述] - [业务用途说明]"
  },
  "attributes": {
    "[fieldName]": {
      "type": "[字段类型]",
      "required": true/false,
      "description": "[中文字段描述] - [详细说明，包含业务规则]"
    }
  }
}
```

#### **1.2 ⚠️ 关键检查点（违反即停止）**
- [ ] **必须**: 每个字段都有`description`属性且为中文
- [ ] **必须**: `displayName`使用中文
- [ ] **必须**: 关系字段的`target`正确
- [ ] **必须**: 枚举值使用英文（数据库兼容）
- [ ] **必须**: 字段命名遵循camelCase

### 🔥 **阶段二：数据库注释配置（开发阶段）**

#### **2.1 表注释模板**
```sql
COMMENT ON TABLE [snake_case_table_name] IS '[中文表名] - [详细业务描述]';
```

#### **2.2 字段注释模板（⚠️ 注意snake_case）**
```sql
-- 主要字段
COMMENT ON COLUMN [table_name].[field_name] IS '[中文字段名] - [字段用途和业务规则]';

-- 系统字段（统一标准）
COMMENT ON COLUMN [table_name].id IS 'ID - [表名]的唯一标识符';
COMMENT ON COLUMN [table_name].document_id IS '文档ID - 文档的唯一标识符';
COMMENT ON COLUMN [table_name].created_at IS '创建时间 - 记录创建时间';
COMMENT ON COLUMN [table_name].updated_at IS '更新时间 - 记录最后更新时间';
COMMENT ON COLUMN [table_name].published_at IS '发布时间 - 记录发布时间';
COMMENT ON COLUMN [table_name].created_by_id IS '创建者ID - 创建此记录的用户ID';
COMMENT ON COLUMN [table_name].updated_by_id IS '更新者ID - 最后更新此记录的用户ID';
COMMENT ON COLUMN [table_name].locale IS '语言区域 - 内容的语言区域设置';
```

### 🔥 **阶段三：Admin UI配置（关键阶段）**

#### **3.1 完整配置SQL模板**
```sql
-- ⚠️ 先删除可能存在的配置，避免冲突
DELETE FROM strapi_core_store_settings
WHERE key = 'plugin_content_manager_configuration_content_types::api::[content-type].[content-type]';

-- 插入完整配置（包含metadatas和layouts）
INSERT INTO strapi_core_store_settings (key, value, type)
VALUES (
    'plugin_content_manager_configuration_content_types::api::[content-type].[content-type]',
    '{
        "metadatas": {
            "[fieldName]": {
                "edit": {"label": "[中文标签]", "description": "[中文描述]", "visible": true, "editable": true},
                "list": {"label": "[中文标签]", "searchable": true, "sortable": true}
            },
            "id": {
                "edit": {"label": "ID", "description": "[表名]的唯一标识符", "visible": false, "editable": false},
                "list": {"label": "ID", "sortable": true, "searchable": false}
            },
            "createdAt": {
                "edit": {"label": "创建时间", "description": "记录创建时间", "visible": true, "editable": false},
                "list": {"label": "创建时间", "searchable": false, "sortable": true}
            },
            "updatedAt": {
                "edit": {"label": "更新时间", "description": "记录最后更新时间", "visible": true, "editable": false},
                "list": {"label": "更新时间", "searchable": false, "sortable": true}
            }
        },
        "layouts": {
            "list": ["[field1]", "[field2]", "[field3]", "createdAt"],
            "edit": [
                [{"name": "[field1]", "size": 6}, {"name": "[field2]", "size": 6}],
                [{"name": "[field3]", "size": 12}]
            ]
        }
    }'::jsonb,
    'object'
);
```

#### **3.2 ⚠️ layouts配置关键要求**
- **list数组**: 列表页显示的字段，顺序重要
- **edit数组**: 编辑页字段布局，每行是一个数组
- **size属性**: 字段宽度，总和不超过12
- **⚠️ 绝对禁止**: 同一字段在edit布局中出现多次

---

## 🚨 **实战错误预防（血泪教训）**

### **错误1: JavaScript错误 - Cannot read properties of undefined**
- **原因**: 创建了metadatas但忘记layouts
- **症状**: Admin UI白屏或JavaScript报错
- **预防**: 使用完整配置模板，同时配置metadatas和layouts
- **修复**: 立即添加layouts配置

### **错误2: 字段重复显示**  
- **原因**: layouts.edit中同一字段出现多次
- **症状**: 表单中字段显示2-3次
- **预防**: 检查edit数组中字段唯一性
- **修复**: 重新生成clean layouts配置

### **错误3: 中文配置被覆盖**
- **原因**: 使用错误的SQL更新方式
- **症状**: 修复后又变回英文
- **预防**: 使用DELETE + INSERT而不是UPDATE
- **修复**: 重新执行完整配置SQL

### **错误4: 系统字段英文显示**
- **原因**: 只配置业务字段，忘记系统字段
- **症状**: id、createdAt等字段显示英文
- **预防**: 使用标准系统字段模板
- **修复**: 补充系统字段中文配置

---

## 📝 **强制质量保证检查清单**

### **🔥 创建完成后强制验证（违反即重做）**

#### **阶段验证A: 数据库层面**
```sql
-- 检查表注释
SELECT obj_description(oid) as table_comment 
FROM pg_class WHERE relname = '[table_name]';

-- 检查字段注释
SELECT column_name, col_description(pgc.oid, pa.attnum) as column_comment
FROM pg_attribute pa
JOIN pg_class pgc ON pgc.oid = pa.attrelid
WHERE pgc.relname = '[table_name]' AND pa.attnum > 0;
```

#### **阶段验证B: Admin UI配置**
```sql
-- 检查metadatas配置完整性
WITH field_check AS (
    SELECT 
        jsonb_object_keys(value::jsonb->'metadatas') as field_name,
        value::jsonb->'metadatas'->(jsonb_object_keys(value::jsonb->'metadatas'))->'edit'->>'label' as field_label
    FROM strapi_core_store_settings 
    WHERE key = 'plugin_content_manager_configuration_content_types::api::[content-type].[content-type]'
)
SELECT 
    COUNT(*) as total_fields,
    COUNT(CASE WHEN field_label ~ '[一-龟]' THEN 1 END) as chinese_labels,
    ROUND(COUNT(CASE WHEN field_label ~ '[一-龟]' THEN 1 END) * 100.0 / COUNT(*), 2) as completion_rate
FROM field_check;

-- 检查重复字段
WITH layout_fields AS (
    SELECT jsonb_array_elements(jsonb_array_elements(value::jsonb->'layouts'->'edit')) as field_obj
    FROM strapi_core_store_settings 
    WHERE key = 'plugin_content_manager_configuration_content_types::api::[content-type].[content-type]'
)
SELECT 
    COUNT(field_obj->>'name') - COUNT(DISTINCT field_obj->>'name') as duplicate_count
FROM layout_fields WHERE field_obj ? 'name';
```

#### **🎯 合格标准**
- [ ] **表注释**: 存在且为中文 ✅
- [ ] **字段注释**: 所有字段都有中文注释 ✅  
- [ ] **中文标签**: 完成度 ≥ 95% ✅
- [ ] **重复字段**: 数量 = 0 ✅

### **🔥 强制执行后续操作**
```bash
# 1. 重建Admin UI（必须）
cd backend && npm run strapi build --clean

# 2. 重启后端服务（必须）
./scripts.sh deploy stop backend && ./scripts.sh deploy backend

# 3. 强制刷新浏览器（必须）
# Cmd + Shift + R (Mac) 或 Ctrl + Shift + R (Windows)
```

---

## ⚡ **最佳实践模板库**

### **业务表模板示例**
```json
{
  "kind": "collectionType",
  "collectionName": "products",
  "info": {
    "singularName": "product", 
    "pluralName": "products",
    "displayName": "产品管理",
    "description": "产品系统 - 管理商品信息、库存和销售数据"
  },
  "attributes": {
    "name": {
      "type": "string",
      "required": true,
      "maxLength": 200,
      "description": "产品名称（必填，最长200字符）"
    },
    "price": {
      "type": "decimal",
      "required": true,
      "description": "产品价格，单位：分"
    },
    "status": {
      "type": "enumeration",
      "enum": ["draft", "active", "inactive", "discontinued"],
      "default": "draft", 
      "description": "产品状态：draft草稿/active在售/inactive下架/discontinued停产"
    },
    "category": {
      "type": "relation",
      "relation": "manyToOne", 
      "target": "api::category.category",
      "description": "产品分类"
    }
  }
}
```

### **完整配置SQL实例**
```sql
-- 1. 数据库注释
COMMENT ON TABLE products IS '产品管理 - 管理商品信息、库存和销售数据';
COMMENT ON COLUMN products.name IS '产品名称 - 商品的主要标识名称';
COMMENT ON COLUMN products.price IS '产品价格 - 商品售价，单位：分';
COMMENT ON COLUMN products.status IS '产品状态 - draft草稿/active在售/inactive下架/discontinued停产';

-- 2. Admin UI配置
DELETE FROM strapi_core_store_settings
WHERE key = 'plugin_content_manager_configuration_content_types::api::product.product';

INSERT INTO strapi_core_store_settings (key, value, type)
VALUES (
    'plugin_content_manager_configuration_content_types::api::product.product',
    '{
        "metadatas": {
            "name": {
                "edit": {"label": "产品名称", "description": "商品的主要标识名称", "visible": true, "editable": true},
                "list": {"label": "产品名称", "searchable": true, "sortable": true}
            },
            "price": {
                "edit": {"label": "产品价格", "description": "商品售价，单位：分", "visible": true, "editable": true},
                "list": {"label": "产品价格", "searchable": false, "sortable": true}
            },
            "status": {
                "edit": {"label": "产品状态", "description": "draft草稿/active在售/inactive下架/discontinued停产", "visible": true, "editable": true},
                "list": {"label": "产品状态", "searchable": true, "sortable": true}
            },
            "category": {
                "edit": {"label": "产品分类", "description": "商品所属分类", "visible": true, "editable": true},
                "list": {"label": "产品分类", "searchable": true, "sortable": true}
            },
            "id": {
                "edit": {"label": "ID", "description": "产品的唯一标识符", "visible": false, "editable": false},
                "list": {"label": "ID", "sortable": true, "searchable": false}
            },
            "createdAt": {
                "edit": {"label": "创建时间", "description": "记录创建时间", "visible": true, "editable": false},
                "list": {"label": "创建时间", "searchable": false, "sortable": true}
            },
            "updatedAt": {
                "edit": {"label": "更新时间", "description": "记录最后更新时间", "visible": true, "editable": false},
                "list": {"label": "更新时间", "searchable": false, "sortable": true}
            }
        },
        "layouts": {
            "list": ["name", "price", "status", "category", "createdAt"],
            "edit": [
                [{"name": "name", "size": 8}, {"name": "status", "size": 4}],
                [{"name": "price", "size": 6}, {"name": "category", "size": 6}]
            ]
        }
    }'::jsonb,
    'object'
);
```

---

## 🚨 **应急修复工具包**

### **快速修复脚本**
```bash
# 检查字段描述完整性
./scripts/tools/auto-check-field-descriptions.sh

# 配置特定内容类型的字段描述  
./scripts/tools/configure-any-field-descriptions.sh [content-type]

# 清理重复字段
./scripts/tools/clean-duplicate-fields.sh [content-type]
```

### **通用修复SQL模板**
```sql
-- 修复重复字段：删除layouts重新生成
UPDATE strapi_core_store_settings
SET value = value::jsonb - 'layouts'
WHERE key = 'plugin_content_manager_configuration_content_types::api::[content-type].[content-type]';

-- 补充系统字段中文配置
UPDATE strapi_core_store_settings
SET value = jsonb_set(
    jsonb_set(
        value::jsonb,
        '{metadatas,createdAt}',
        '{"edit": {"label": "创建时间", "description": "记录创建时间", "visible": true, "editable": false}, "list": {"label": "创建时间", "searchable": false, "sortable": true}}'::jsonb
    ),
    '{metadatas,updatedAt}',
    '{"edit": {"label": "更新时间", "description": "记录最后更新时间", "visible": true, "editable": false}, "list": {"label": "更新时间", "searchable": false, "sortable": true}}'::jsonb
)
WHERE key = 'plugin_content_manager_configuration_content_types::api::[content-type].[content-type]';
```

---

## 🎊 **终极成功标准**

### **阶段性验收**
- **✅ 阶段一**: Schema文件创建完成，所有字段有中文描述
- **✅ 阶段二**: 数据库表和字段注释100%完整
- **✅ 阶段三**: Admin UI配置100%中文化，无重复字段

### **最终验收**
1. **数据库层面**: 表和字段都有完整中文注释 ✅
2. **Admin UI层面**: 所有字段标签和描述都是中文 ✅  
3. **用户体验层面**: 界面清晰，无重复字段，操作顺畅 ✅

### **质量标准**
- **中文配置完成度**: ≥ 95%
- **重复字段数量**: = 0
- **JavaScript错误**: = 0
- **用户体验**: 流畅无障碍

**⚠️ 违反任何一项都视为配置失败，必须立即按照应急修复工具包进行修复！**

---

## 📈 **持续改进机制**

### **经验积累**
每次新建内容类型后，记录：
- 遇到的问题和解决方案
- 配置模板的优化建议  
- 验证清单的补充项目

### **工具优化**
定期优化：
- 自动化脚本的功能
- SQL模板的准确性
- 验证脚本的覆盖率

### **规则更新**
根据Strapi版本更新和项目需求变化，及时更新本规则文件。

**🔥 这是活的规则文件，会随着项目发展不断完善！**