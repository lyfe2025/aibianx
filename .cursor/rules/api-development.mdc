# APIå¼€å‘è§„èŒƒ (API Development Rules)

## ğŸ”Œ **APIå¼€å‘æ ‡å‡†ï¼ˆè¯¦ç»†ï¼‰**

### **ğŸ“¡ RESTful APIè®¾è®¡åŸåˆ™**
```typescript
// âœ… æ ‡å‡†APIè·¯ç”±è®¾è®¡
// GET    /api/articles           # è·å–æ–‡ç« åˆ—è¡¨
// GET    /api/articles/123       # è·å–ç‰¹å®šæ–‡ç« 
// POST   /api/articles           # åˆ›å»ºæ–°æ–‡ç« 
// PUT    /api/articles/123       # æ›´æ–°æ•´ä¸ªæ–‡ç« 
// PATCH  /api/articles/123       # éƒ¨åˆ†æ›´æ–°æ–‡ç« 
// DELETE /api/articles/123       # åˆ é™¤æ–‡ç« 

// GET    /api/articles/123/comments  # è·å–æ–‡ç« è¯„è®º
// POST   /api/articles/123/like      # ç‚¹èµæ–‡ç« 

// âŒ ä¸è§„èŒƒçš„è·¯ç”±è®¾è®¡
// GET    /api/getArticles            # åŠ¨è¯ä¸åº”è¯¥åœ¨URLä¸­
// POST   /api/articles/delete        # åº”è¯¥ä½¿ç”¨DELETEæ–¹æ³•
// GET    /api/article-comment-list   # å…³ç³»åº”è¯¥ç”¨åµŒå¥—è¡¨ç¤º
```

### **ğŸ“Š æ ‡å‡†APIå“åº”æ ¼å¼**
```typescript
// âœ… æˆåŠŸå“åº”æ ¼å¼
interface APIResponse<T> {
  data: T
  meta?: {
    pagination?: {
      page: number
      pageSize: number
      pageCount: number
      total: number
    }
    [key: string]: any
  }
}

// âœ… é”™è¯¯å“åº”æ ¼å¼
interface APIError {
  error: {
    status: number
    name: string
    message: string
    details?: Record<string, any>
  }
}

// âœ… å®é™…APIæ§åˆ¶å™¨å®ç°
export default factories.createCoreController('api::article.article', ({ strapi }) => ({
  async find(ctx) {
    try {
      // å‚æ•°éªŒè¯
      const { page = 1, pageSize = 25, populate = 'author,category,tags' } = ctx.query
      
      // ä¸šåŠ¡é€»è¾‘
      const result = await strapi.entityService.findMany('api::article.article', {
        populate: populate.split(','),
        pagination: {
          page: Math.max(1, parseInt(page)),
          pageSize: Math.min(100, Math.max(1, parseInt(pageSize)))
        },
        sort: { publishedAt: 'desc' }
      })
      
      return {
        data: result.results,
        meta: {
          pagination: result.pagination
        }
      }
    } catch (error) {
      ctx.status = 500
      return {
        error: {
          status: 500,
          name: 'InternalServerError',
          message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
          details: process.env.NODE_ENV === 'development' ? error.message : undefined
        }
      }
    }
  }
}))
```

### **ğŸ” APIæŸ¥è¯¢å’Œè¿‡æ»¤æ ‡å‡†**
```typescript
// âœ… æŸ¥è¯¢å‚æ•°æ ‡å‡†åŒ–
interface ArticleQuery {
  // åŸºç¡€åˆ†é¡µ
  page?: number
  pageSize?: number
  
  // å…³è”æ•°æ®
  populate?: string
  
  // è¿‡æ»¤æ¡ä»¶
  category?: string
  tags?: string[]
  author?: string
  featured?: boolean
  
  // æœç´¢
  search?: string
  
  // æ’åº
  sort?: 'publishedAt:desc' | 'publishedAt:asc' | 'title:asc' | 'viewCount:desc'
  
  // æ—¥æœŸèŒƒå›´
  publishedAfter?: string
  publishedBefore?: string
}

// âœ… APIå®¢æˆ·ç«¯æ ‡å‡†å®ç°
export const strapiClient = {
  async getArticles(params: ArticleQuery): Promise<Article[]> {
    const searchParams = new URLSearchParams()
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°
    if (params.page) searchParams.set('pagination[page]', String(params.page))
    if (params.pageSize) searchParams.set('pagination[pageSize]', String(params.pageSize))
    if (params.populate) searchParams.set('populate', params.populate)
    if (params.category) searchParams.set('filters[category][slug][$eq]', params.category)
    if (params.featured !== undefined) searchParams.set('filters[featured][$eq]', String(params.featured))
    
    const response = await fetch(`${config.backend.apiUrl}/articles?${searchParams}`)
    
    if (!response.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`)
    }
    
    const result = await response.json()
    return result.data
  }
}
```

### **ğŸš¨ é”™è¯¯å¤„ç†æ ‡å‡†æ¨¡æ¿ï¼ˆå¿…é¡»ä½¿ç”¨ï¼‰**
```typescript
// ğŸ”¥ æ‰€æœ‰APIè°ƒç”¨å¿…é¡»ä½¿ç”¨è¿™ä¸ªé”™è¯¯å¤„ç†æ¨¡æ¿

// âœ… å‰ç«¯APIè°ƒç”¨æ ‡å‡†æ¨¡æ¿
export const apiCall = async <T>(
  url: string, 
  options?: RequestInit
): Promise<{ data: T | null; error: string | null }> => {
  try {
    const response = await fetch(url, {
      headers: {
        'Content-Type': 'application/json',
        ...options?.headers,
      },
      ...options,
    })

    if (!response.ok) {
      // å¤„ç†HTTPé”™è¯¯
      const errorData = await response.json().catch(() => ({}))
      const errorMessage = errorData.error?.message || `HTTP Error: ${response.status}`
      
      console.error('APIè°ƒç”¨å¤±è´¥:', {
        url,
        status: response.status,
        statusText: response.statusText,
        error: errorMessage
      })
      
      return { data: null, error: errorMessage }
    }

    const data = await response.json()
    return { data, error: null }
    
  } catch (error) {
    // å¤„ç†ç½‘ç»œé”™è¯¯æˆ–å…¶ä»–å¼‚å¸¸
    const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    
    console.error('ç½‘ç»œé”™è¯¯:', {
      url,
      error: errorMessage
    })
    
    return { data: null, error: errorMessage }
  }
}
```

### **ğŸ“§ é‚®ä»¶ç³»ç»Ÿå¼€å‘è§„èŒƒï¼ˆæ–°å¢ï¼‰**

#### **âš ï¸ æ ¸å¿ƒæ¶æ„åŸåˆ™**
é‚®ä»¶ç³»ç»Ÿé‡‡ç”¨**åˆ†ç¦»æ¶æ„è®¾è®¡**ï¼ŒæŠ€æœ¯é…ç½®ä¸ä¸šåŠ¡é…ç½®åˆ†ç¦»ç®¡ç†ï¼š

- **SMTPæŠ€æœ¯é…ç½®** â†’ `smtp-configs` å†…å®¹ç±»å‹ï¼ˆæ”¯æŒå¤šæœåŠ¡å™¨ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ï¼‰
- **ä¸šåŠ¡é€»è¾‘é…ç½®** â†’ `system-config` å†…å®¹ç±»å‹ï¼ˆå¼€å…³æ§åˆ¶ã€åŠŸèƒ½é…ç½®ï¼‰
- **ç»Ÿä¸€å‘é€æœåŠ¡** â†’ `email-service` APIï¼ˆæ‰€æœ‰é‚®ä»¶å‘é€çš„å”¯ä¸€å…¥å£ï¼‰

#### **ğŸ›¡ï¸ é‚®ä»¶æœåŠ¡æ ‡å‡†è§„èŒƒ**

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€é‚®ä»¶æœåŠ¡
import { emailService } from '@/lib/email-service'

await emailService.sendVerificationCode({
  email: user.email,
  code: verificationCode,
  type: 'register'
})

// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨SMTPé…ç½®
import nodemailer from 'nodemailer'
const transporter = nodemailer.createTransporter(...)
```

#### **ğŸ” é‚®ä»¶å‘é€å®‰å…¨è§„èŒƒ**
- âœ… **å¿…é¡»éªŒè¯é‚®ç®±æ ¼å¼**ï¼šä½¿ç”¨ `email-validator` åº“
- âœ… **å¿…é¡»é™åˆ¶å‘é€é¢‘ç‡**ï¼šæ¯ä¸ªé‚®ç®±æ¯åˆ†é’Ÿæœ€å¤š1å°éªŒè¯ç é‚®ä»¶
- âœ… **å¿…é¡»è®°å½•å‘é€æ—¥å¿—**ï¼šæˆåŠŸ/å¤±è´¥çŠ¶æ€ã€é”™è¯¯åŸå› ã€SMTPæœåŠ¡å™¨
- âœ… **å¿…é¡»æ”¯æŒæ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨SMTPæœåŠ¡å™¨
- âŒ **ç¦æ­¢ç¡¬ç¼–ç SMTPé…ç½®**ï¼šæ‰€æœ‰é…ç½®å¿…é¡»æ¥è‡ªæ•°æ®åº“

#### **ğŸ“ é‚®ä»¶æ¨¡æ¿æ ‡å‡†**
```typescript
// âœ… æ ‡å‡†é‚®ä»¶æ¨¡æ¿ç»“æ„
interface EmailTemplate {
  name: string           // æ¨¡æ¿åç§°ï¼ˆå¦‚ï¼šverification-codeï¼‰
  subject: string        // é‚®ä»¶ä¸»é¢˜ï¼ˆæ”¯æŒå˜é‡æ›¿æ¢ï¼‰
  htmlContent: string    // HTMLå†…å®¹ï¼ˆå“åº”å¼è®¾è®¡ï¼‰
  textContent: string    // çº¯æ–‡æœ¬å¤‡é€‰
  variables: string[]    // æ”¯æŒçš„å˜é‡åˆ—è¡¨
  category: 'auth' | 'marketing' | 'notification'
}

// âœ… å˜é‡æ›¿æ¢å®‰å…¨å¤„ç†
const processTemplate = (template: string, variables: Record<string, string>) => {
  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return escapeHtml(variables[key] || match)
  })
}
```

#### **ğŸ“ˆ é‚®ä»¶å‘é€çŠ¶æ€ç®¡ç†**
- **å®æ—¶çŠ¶æ€æ£€æŸ¥**ï¼šå‘é€å‰æ£€æŸ¥SMTPæœåŠ¡å™¨å¥åº·çŠ¶æ€
- **é‡è¯•æœºåˆ¶**ï¼šå¤±è´¥åè‡ªåŠ¨é‡è¯•3æ¬¡ï¼Œé—´éš”é€’å¢ï¼ˆ1s, 3s, 9sï¼‰
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ¯æ¬¡å‘é€çš„è¯¦ç»†ä¿¡æ¯å’Œç»“æœ
- **ç›‘æ§å‘Šè­¦**ï¼šè¿ç»­å¤±è´¥ç‡è¶…è¿‡20%æ—¶è§¦å‘å‘Šè­¦

### **ğŸ”§ APIè°ƒè¯•å‡çº§ç‰ˆï¼ˆç³»ç»ŸåŒ–ï¼‰**
```bash
# ğŸ” 1. APIå¥åº·æ£€æŸ¥
curl -s "${BACKEND_API_URL}/health" | jq '.status'

# ğŸ“Š 2. æµ‹è¯•æ ¸å¿ƒAPIç«¯ç‚¹
curl -s "${BACKEND_API_URL}/articles?pagination[pageSize]=1" | jq '.data[0].title'

# ğŸ” 3. æµ‹è¯•è®¤è¯ç«¯ç‚¹
curl -s -X POST "${BACKEND_API_URL}/auth/local" \
  -H "Content-Type: application/json" \
  -d '{"identifier":"test@example.com","password":"testpass"}' | jq '.jwt'

# ğŸ“§ 4. æµ‹è¯•é‚®ä»¶æœåŠ¡
curl -s "${BACKEND_API_URL}/email-service/send-test" | jq '.status'

# ğŸ” 5. æµ‹è¯•æœç´¢æœåŠ¡
curl -s "${SEARCH_URL}/health" | jq '.status'

# ğŸ¯ 6. å‰ç«¯APIé›†æˆæµ‹è¯•
curl -s "http://localhost/api/test-articles" | jq '.data | length'

# ğŸ“± 7. å‰ç«¯é¡µé¢å¯ç”¨æ€§æ£€æŸ¥
curl -s "http://localhost/api-debug" | grep -o "API Debug"
```

### **ğŸ—ï¸ APIæ¶æ„è®¾è®¡æ¨¡å¼**

#### **æ§åˆ¶å™¨å±‚è®¾è®¡**
```typescript
// âœ… æ ‡å‡†æ§åˆ¶å™¨ç»“æ„
export default factories.createCoreController('api::article.article', ({ strapi }) => ({
  // è·å–åˆ—è¡¨ï¼ˆå¸¦æœç´¢å’Œè¿‡æ»¤ï¼‰
  async find(ctx) {
    try {
      const { search, ...query } = ctx.query
      
      // æœç´¢é€»è¾‘
      if (search) {
        return await this.searchArticles(ctx, search)
      }
      
      // æ ‡å‡†æŸ¥è¯¢é€»è¾‘
      return await super.find(ctx)
    } catch (error) {
      return this.handleError(ctx, error)
    }
  },
  
  // è‡ªå®šä¹‰æœç´¢æ–¹æ³•
  async searchArticles(ctx, searchTerm) {
    const results = await strapi.entityService.findMany('api::article.article', {
      filters: {
        $or: [
          { title: { $containsi: searchTerm } },
          { content: { $containsi: searchTerm } },
          { excerpt: { $containsi: searchTerm } }
        ]
      },
      populate: ['author', 'category', 'tags'],
      pagination: ctx.query.pagination
    })
    
    return { data: results.results, meta: { pagination: results.pagination } }
  },
  
  // ç»Ÿä¸€é”™è¯¯å¤„ç†
  handleError(ctx, error) {
    strapi.log.error('API Error:', error)
    
    ctx.status = error.status || 500
    return {
      error: {
        status: ctx.status,
        name: error.name || 'InternalServerError',
        message: process.env.NODE_ENV === 'production' 
          ? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' 
          : error.message
      }
    }
  }
}))
```

#### **æœåŠ¡å±‚è®¾è®¡**
```typescript
// âœ… ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
export default factories.createCoreService('api::article.article', ({ strapi }) => ({
  // ä¸šåŠ¡é€»è¾‘æ–¹æ³•
  async findArticlesWithStats(params = {}) {
    const articles = await strapi.entityService.findMany('api::article.article', {
      ...params,
      populate: ['author', 'category', 'tags']
    })
    
    // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
    const articlesWithStats = await Promise.all(
      articles.results.map(async (article) => ({
        ...article,
        stats: {
          commentCount: await this.getCommentCount(article.id),
          likeCount: await this.getLikeCount(article.id),
          shareCount: await this.getShareCount(article.id)
        }
      }))
    )
    
    return {
      results: articlesWithStats,
      pagination: articles.pagination
    }
  },
  
  // ç¼“å­˜æœºåˆ¶
  async findWithCache(params, cacheKey, ttl = 300) {
    const cached = await strapi.cache.get(cacheKey)
    if (cached) return cached
    
    const result = await strapi.entityService.findMany('api::article.article', params)
    await strapi.cache.set(cacheKey, result, ttl)
    
    return result
  }
}))
```

### **ğŸ“Š APIæ€§èƒ½ä¼˜åŒ–**

#### **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**
```typescript
// âœ… ä¼˜åŒ–çš„æŸ¥è¯¢å®ç°
export default factories.createCoreController('api::article.article', ({ strapi }) => ({
  async find(ctx) {
    const { page = 1, pageSize = 25 } = ctx.query
    
    // ç²¾ç¡®æŒ‡å®šéœ€è¦çš„å­—æ®µï¼Œé¿å…over-fetching
    const populate = {
      author: {
        fields: ['name', 'avatar']
      },
      category: {
        fields: ['name', 'slug', 'color']
      },
      tags: {
        fields: ['name', 'color']
      },
      featuredImage: {
        fields: ['url', 'alternativeText', 'width', 'height']
      }
    }
    
    // ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–çš„æŸ¥è¯¢
    const result = await strapi.entityService.findMany('api::article.article', {
      fields: ['title', 'slug', 'excerpt', 'publishedAt', 'viewCount'],
      populate,
      pagination: { page, pageSize },
      sort: { publishedAt: 'desc' },
      // ç¼“å­˜æŸ¥è¯¢ç»“æœ
      cache: {
        key: `articles_${page}_${pageSize}`,
        ttl: 5 * 60 * 1000 // 5åˆ†é’Ÿ
      }
    })
    
    return result
  },
  
  // âœ… æ‰¹é‡æ“ä½œä¼˜åŒ–
  async updateViewCount(ctx) {
    const { id } = ctx.params
    
    // ä½¿ç”¨åŸç”ŸSQLè¿›è¡Œé«˜æ•ˆæ›´æ–°
    await strapi.db.query('api::article.article').update({
      where: { id },
      data: {
        viewCount: strapi.db.connection.raw('view_count + 1')
      }
    })
    
    return { success: true }
  }
}))
```

### **ğŸ”’ APIå®‰å…¨è§„èŒƒ**

#### **è¾“å…¥éªŒè¯å’Œæ¸…ç†**
```typescript
// âœ… è¾“å…¥éªŒè¯ä¸­é—´ä»¶
export const validateInput = (schema) => {
  return async (ctx, next) => {
    try {
      const validatedData = await schema.parseAsync(ctx.request.body)
      ctx.request.body = validatedData
      await next()
    } catch (error) {
      ctx.status = 400
      ctx.body = {
        error: {
          status: 400,
          name: 'ValidationError',
          message: 'è¾“å…¥æ•°æ®éªŒè¯å¤±è´¥',
          details: error.errors
        }
      }
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
import { z } from 'zod'

const articleSchema = z.object({
  title: z.string().min(1).max(255),
  content: z.string().min(1),
  excerpt: z.string().max(500).optional(),
  featured: z.boolean().optional()
})

// åœ¨è·¯ç”±ä¸­ä½¿ç”¨
router.post('/articles', validateInput(articleSchema), controller.create)
```

#### **APIé€Ÿç‡é™åˆ¶**
```typescript
// âœ… é€Ÿç‡é™åˆ¶é…ç½®
export const rateLimitConfig = {
  // é€šç”¨APIé™åˆ¶
  general: {
    max: 100,           // æ¯å°æ—¶æœ€å¤š100ä¸ªè¯·æ±‚
    windowMs: 60 * 60 * 1000,
    message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
  },
  
  // è®¤è¯APIé™åˆ¶
  auth: {
    max: 10,            // æ¯å°æ—¶æœ€å¤š10æ¬¡ç™»å½•å°è¯•
    windowMs: 60 * 60 * 1000,
    message: 'ç™»å½•å°è¯•è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
  },
  
  // é‚®ä»¶å‘é€é™åˆ¶
  email: {
    max: 5,             // æ¯å°æ—¶æœ€å¤š5å°é‚®ä»¶
    windowMs: 60 * 60 * 1000,
    message: 'é‚®ä»¶å‘é€è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
  }
}
```

### **ğŸ“‹ APIå¼€å‘æ£€æŸ¥æ¸…å•**
- [ ] RESTfulè®¾è®¡åŸåˆ™éµå¾ª
- [ ] æ ‡å‡†å“åº”æ ¼å¼å®ç°
- [ ] å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…ç†
- [ ] åˆ†é¡µå’ŒæŸ¥è¯¢ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥å®ç°
- [ ] é€Ÿç‡é™åˆ¶é…ç½®
- [ ] APIæ–‡æ¡£ç”Ÿæˆ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] é›†æˆæµ‹è¯•éªŒè¯
- [ ] æ€§èƒ½ç›‘æ§è®¾ç½®
- [ ] å®‰å…¨å®¡è®¡é€šè¿‡