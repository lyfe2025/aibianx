# Strapi åŽç«¯å¼€å‘è§„èŒƒ (Strapi Backend Rules)

## ðŸš¨ Strapi 5.x å…³é”®é”™è¯¯é¢„é˜²

### **å¿…é¡»ä½¿ç”¨TypeScript + ES6è¯­æ³•**
```typescript
// âœ… æ­£ç¡®æ ¼å¼
import { factories } from '@strapi/strapi'
export default factories.createCoreController('api::article.article');

// âŒ é”™è¯¯æ ¼å¼ - ä¼šå¯¼è‡´404
const { createCoreController } = require('@strapi/strapi').factories;
module.exports = createCoreController('api::article.article');
```

### **å…³é”®æ³¨æ„äº‹é¡¹**
- âŒ åˆ é™¤ `content-types/{name}/index.js` æ–‡ä»¶ (å¯¼è‡´å†²çª)
- âœ… å¿…é¡»ä½¿ç”¨ `.ts` æ‰©å±•å
- âœ… ä¼˜å…ˆä½¿ç”¨Adminç•Œé¢åˆ›å»ºå†…å®¹ç±»åž‹
- âœ… åˆ›å»ºåŽç«‹å³é…ç½®Publicè§’è‰²æƒé™

### **å¿«é€Ÿé—®é¢˜è¯Šæ–­**
```bash
# 1. æµ‹è¯•APIçŠ¶æ€
curl -s "http://localhost:1337/api/articles" | jq '.error.status'
# 404 = æœªè¯†åˆ«æ ¼å¼ | 403 = éœ€è¦æƒé™ | 200 = æ­£å¸¸

# 2. æ£€æŸ¥æ–‡ä»¶æ ¼å¼
find src/api -name "*.js" -o -name "*.ts" | sort
# åº”è¯¥åªæœ‰.tsæ–‡ä»¶

# 3. ä¿®å¤é‡å¯
rm -rf .tmp && npm run develop
```

### **æƒé™è‡ªåŠ¨åŒ–é…ç½® (æŽ¨è)**
åœ¨ `backend/src/index.ts` æ·»åŠ bootstrapå‡½æ•°è‡ªåŠ¨é…ç½®æƒé™ï¼š
```typescript
export default {
  async bootstrap({ strapi }) {
    const publicRole = await strapi.entityService.findMany('plugin::users-permissions.role', {
      filters: { type: 'public' }
    });
    
    const permissions = [
      'api::article.article.find', 'api::article.article.findOne',
      'api::author.author.find', 'api::category.category.find',
      'api::tag.tag.find', 'api::site-config.site-config.find',
      'api::seo-metrics.seo-metrics.find'
    ];
    
    // è‡ªåŠ¨åˆ›å»º/å¯ç”¨æƒé™é€»è¾‘...
  }
};
```

## ðŸ”¥ **æ–°å»ºå†…å®¹ç±»åž‹æ ‡å‡†æµç¨‹ï¼ˆå®Œå…¨è‡ªåŠ¨åŒ–ï¼‰**

**âš ï¸ æ ¸å¿ƒåŽŸåˆ™ï¼šä¸€é”®å¼è‡ªåŠ¨åŒ–ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œ100%æˆåŠŸçŽ‡ï¼**

### **ç¬¬ä¸€æ­¥ï¼šAdminç•Œé¢åˆ›å»ºå†…å®¹ç±»åž‹**
```bash
# 1. è¿›å…¥Strapiç®¡ç†åŽå°
http://localhost:1337/admin â†’ Content-Type Builder

# 2. åˆ›å»ºå†…å®¹ç±»åž‹æ—¶å¿…é¡»éµå¾ªçš„å‘½åè§„èŒƒ
- ç±»åž‹åç§°ï¼šä½¿ç”¨è‹±æ–‡å°å†™ï¼Œå•æ•°å½¢å¼ï¼ˆå¦‚ï¼šarticle, author, categoryï¼‰
- æ˜¾ç¤ºåç§°ï¼šä½¿ç”¨ä¸­æ–‡ï¼Œä¾¿äºŽç®¡ç†å‘˜ç†è§£ï¼ˆå¦‚ï¼šæ–‡ç« ç®¡ç†, ä½œè€…ç®¡ç†ï¼‰
- API IDï¼šç¡®ä¿ä¸Žç±»åž‹åç§°ä¸€è‡´
```

### **ç¬¬äºŒæ­¥ï¼šä¸€é”®å¼å®Œæ•´é…ç½®ï¼ˆè¡¨æ³¨é‡Š+å­—æ®µæè¿°ï¼‰**
```bash
# ðŸ”¥ æ–°å»ºå†…å®¹ç±»åž‹åŽï¼Œç«‹å³æ‰§è¡Œä¸€é”®é…ç½®å‘½ä»¤ï¼š
./scripts.sh content-type configure [content-type-name]

# ðŸŽ¯ è¯¥å‘½ä»¤ä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ‰€æœ‰æ­¥éª¤ï¼š
# 1. åœæ­¢æœåŠ¡å¹¶æ¸…é™¤ç¼“å­˜
# 2. è‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“è¡¨æ³¨é‡ŠSQL
# 3. è‡ªåŠ¨ç”Ÿæˆå­—æ®µæè¿°é…ç½®SQL
# 4. æ‰§è¡Œæ•°æ®åº“æ³¨é‡Šå’Œå­—æ®µæè¿°æ›´æ–°
# 5. é‡å¯æœåŠ¡
# 6. éªŒè¯é…ç½®ç»“æžœ
# 7. æ¸…ç†ä¸´æ—¶æ–‡ä»¶

# âœ… æ‰§è¡Œç»“æžœï¼š
# - æ•°æ®åº“è¡¨å’Œå­—æ®µæ³¨é‡Šï¼š100%è‡ªåŠ¨æ·»åŠ 
# - Adminç•Œé¢å­—æ®µæè¿°ï¼š100%è‡ªåŠ¨é…ç½®
# - APIæƒé™ï¼šè‡ªåŠ¨é…ç½®å…¬å¼€è®¿é—®æƒé™
# - éªŒè¯æµ‹è¯•ï¼šè‡ªåŠ¨å®Œæˆæ‰€æœ‰éªŒè¯
```

### **ç¬¬ä¸‰æ­¥ï¼šè‡ªåŠ¨éªŒè¯ï¼ˆæ— éœ€æ‰‹åŠ¨æ£€æŸ¥ï¼‰**
```bash
# ðŸ”¥ é…ç½®å‘½ä»¤ä¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰éªŒè¯ï¼Œè¾“å‡ºéªŒè¯ç»“æžœï¼š

# âœ… æ•°æ®åº“æ³¨é‡ŠéªŒè¯
# âœ… å­—æ®µæè¿°éªŒè¯
# âœ… APIæƒé™éªŒè¯
# âœ… ç®¡ç†ç•Œé¢éªŒè¯

# ðŸ“Š å¦‚æžœéªŒè¯å¤±è´¥ï¼Œå‘½ä»¤ä¼šè‡ªåŠ¨é‡è¯•å¹¶è¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
```

### **ðŸŽ¯ è‡ªåŠ¨åŒ–é…ç½®è„šæœ¬å®žçŽ°**

#### **è‡ªåŠ¨åŒ–è„šæœ¬åŠŸèƒ½è¯´æ˜Ž**
```bash
# ðŸ”¥ å®Œå…¨è‡ªåŠ¨åŒ–çš„å†…å®¹ç±»åž‹é…ç½®è„šæœ¬
# ä½ç½®ï¼šscripts/content-type/configure-content-type.sh

configure_content_type() {
    local content_type="$1"
    local table_name="${content_type//-/_}s"  # smtp-config -> smtp_configs
    
    echo "ðŸš€ å¼€å§‹é…ç½®å†…å®¹ç±»åž‹: $content_type"
    
    # 1. åœæ­¢æœåŠ¡å¹¶æ¸…é™¤ç¼“å­˜
    ./scripts.sh deploy stop
    cd backend && rm -rf .tmp .cache build dist node_modules/.cache
    cd ../frontend && rm -rf .next node_modules/.cache && cd ..
    
    # 2. è‡ªåŠ¨ç”Ÿæˆå¹¶æ‰§è¡Œæ•°æ®åº“è¡¨æ³¨é‡Š
    generate_table_comments "$content_type" "$table_name"
    
    # 3. è‡ªåŠ¨ç”Ÿæˆå¹¶æ‰§è¡Œå­—æ®µæè¿°é…ç½®
    generate_field_descriptions "$content_type"
    
    # 4. é‡å¯æœåŠ¡
    ./scripts.sh deploy start
    
    # 5. è‡ªåŠ¨éªŒè¯é…ç½®ç»“æžœ
    verify_configuration "$content_type" "$table_name"
    
    # 6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    cleanup_temp_files "$content_type"
    
    echo "âœ… å†…å®¹ç±»åž‹ $content_type é…ç½®å®Œæˆï¼"
}
```

#### **è‡ªåŠ¨è¡¨æ³¨é‡Šç”Ÿæˆå™¨**
```bash
generate_table_comments() {
    local content_type="$1"
    local table_name="$2"
    
    echo "ðŸ“ ç”Ÿæˆæ•°æ®åº“è¡¨æ³¨é‡Š..."
    
    # è‡ªåŠ¨ç”Ÿæˆè¡¨æ³¨é‡ŠSQLï¼ˆåŸºäºŽå†…å®¹ç±»åž‹schema.jsonï¼‰
    cat > "backend/auto-db-comments-${content_type}.sql" << EOF
-- è‡ªåŠ¨ç”Ÿæˆçš„æ•°æ®åº“æ³¨é‡Š - ${content_type}
-- ç”Ÿæˆæ—¶é—´: $(date)

-- ä»Žschema.jsonè‡ªåŠ¨æå–è¡¨æ³¨é‡Š
COMMENT ON TABLE ${table_name} IS '$(extract_table_description "$content_type")';

-- ä»Žschema.jsonè‡ªåŠ¨æå–å­—æ®µæ³¨é‡Š
$(generate_column_comments "$content_type" "$table_name")
EOF

    # æ‰§è¡ŒSQL
    cd backend && psql -U aibianx_dev -d aibianx_dev -f "auto-db-comments-${content_type}.sql"
}
```

#### **è‡ªåŠ¨å­—æ®µæè¿°ç”Ÿæˆå™¨**
```bash
generate_field_descriptions() {
    local content_type="$1"
    
    echo "ðŸŽ¨ ç”Ÿæˆå­—æ®µæè¿°é…ç½®..."
    
    # ç›´æŽ¥æ›´æ–°æ•°æ®åº“é…ç½®è¡¨
    cat > "backend/auto-field-descriptions-${content_type}.sql" << EOF
-- è‡ªåŠ¨ç”Ÿæˆçš„å­—æ®µæè¿°é…ç½® - ${content_type}
-- ç”Ÿæˆæ—¶é—´: $(date)

-- ä»Žschema.jsonè‡ªåŠ¨æå–å­—æ®µæè¿°å¹¶æ›´æ–°Strapié…ç½®
$(generate_field_description_updates "$content_type")
EOF

    # æ‰§è¡Œå­—æ®µæè¿°æ›´æ–°
    cd backend && psql -U aibianx_dev -d aibianx_dev -f "auto-field-descriptions-${content_type}.sql"
}
```

#### **è‡ªåŠ¨éªŒè¯å™¨**
```bash
verify_configuration() {
    local content_type="$1"
    local table_name="$2"
    
    echo "ðŸ” éªŒè¯é…ç½®ç»“æžœ..."
    
    # éªŒè¯æ•°æ®åº“æ³¨é‡Š
    local comment_count=$(psql -U aibianx_dev -d aibianx_dev -t -c "
        SELECT COUNT(*) FROM information_schema.columns cols 
        INNER JOIN pg_class pgc ON pgc.relname = cols.table_name 
        WHERE table_name = '$table_name' 
        AND col_description(pgc.oid, cols.ordinal_position) IS NOT NULL;
    ")
    
    echo "âœ… æ•°æ®åº“æ³¨é‡Š: $comment_count ä¸ªå­—æ®µå·²æ·»åŠ æ³¨é‡Š"
    
    # éªŒè¯å­—æ®µæè¿°é…ç½®
    local desc_count=$(psql -U aibianx_dev -d aibianx_dev -t -c "
        SELECT jsonb_object_keys(value::jsonb->'metadatas') 
        FROM strapi_core_store_settings 
        WHERE key = 'plugin_content_manager_configuration_content_types::api::${content_type}.${content_type}';
    " | wc -l)
    
    echo "âœ… å­—æ®µæè¿°: $desc_count ä¸ªå­—æ®µå·²é…ç½®æè¿°"
    
    # éªŒè¯APIè®¿é—®
    if curl -s "http://localhost:1337/api/${content_type}s" | grep -q "data"; then
        echo "âœ… APIè®¿é—®: æ­£å¸¸"
    else
        echo "âš ï¸ APIè®¿é—®: éœ€è¦é…ç½®æƒé™"
    fi
}
```

## ðŸŒ **åŸŸåé…ç½®æ ‡å‡†ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰**

### **âš ï¸ é‡è¦åŽŸåˆ™**
æ‰€æœ‰URLå’ŒåŸŸåé…ç½®å¿…é¡»ä½¿ç”¨çŽ¯å¢ƒå˜é‡ï¼Œç¦æ­¢ç¡¬ç¼–ç ï¼ç¡®ä¿å¼€å‘çŽ¯å¢ƒã€ç”Ÿäº§çŽ¯å¢ƒé…ç½®ç»Ÿä¸€ç®¡ç†ã€‚

### **ðŸ”§ çŽ¯å¢ƒå˜é‡æ ‡å‡†é…ç½®**

#### **å‰ç«¯çŽ¯å¢ƒå˜é‡ (frontend/.env.local)**
```bash
# å‰ç«¯æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
NEXT_PUBLIC_FRONTEND_DOMAIN=localhost
NEXT_PUBLIC_FRONTEND_PORT=80
NEXT_PUBLIC_FRONTEND_PROTOCOL=http

# åŽç«¯æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
NEXT_PUBLIC_BACKEND_DOMAIN=localhost
NEXT_PUBLIC_BACKEND_PORT=1337
NEXT_PUBLIC_BACKEND_PROTOCOL=http

# æœç´¢æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
NEXT_PUBLIC_SEARCH_DOMAIN=localhost
NEXT_PUBLIC_SEARCH_PORT=7700
NEXT_PUBLIC_SEARCH_PROTOCOL=http

# NextAuthé…ç½®
NEXTAUTH_SECRET=your-secret-key
```

#### **åŽç«¯çŽ¯å¢ƒå˜é‡ (backend/.env)**
```bash
# åŽç«¯æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
BACKEND_DOMAIN=localhost
BACKEND_PORT=1337
BACKEND_PROTOCOL=http
HOST=0.0.0.0
PORT=1337

# å‰ç«¯æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
FRONTEND_DOMAIN=localhost
FRONTEND_PORT=80
FRONTEND_PROTOCOL=http

# æ•°æ®åº“æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=aibianx_dev
DATABASE_USERNAME=aibianx_dev
DATABASE_PASSWORD=aibianx_password

# æœç´¢æœåŠ¡é…ç½®ï¼ˆåŸŸåå’Œç«¯å£åˆ†ç¦»ï¼‰
MEILISEARCH_DOMAIN=localhost
MEILISEARCH_PORT=7700
MEILISEARCH_PROTOCOL=http
MEILISEARCH_API_KEY=

# å®‰å…¨é…ç½®
APP_KEYS=key1,key2,key3,key4
API_TOKEN_SALT=api-token-salt
ADMIN_JWT_SECRET=admin-jwt-secret
JWT_SECRET=jwt-secret
```

### **ðŸ”§ å­—æ®µæè¿°é…ç½®æ ‡å‡†æµç¨‹ï¼ˆå…³é”®ï¼‰**

**âš ï¸ é‡è¦æé†’**ï¼šå­—æ®µæè¿°é…ç½®å¤±è´¥æ˜¯åå¤å‡ºçŽ°çš„é—®é¢˜ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æµç¨‹æ‰§è¡Œï¼

#### **é—®é¢˜ç—‡çŠ¶è¯†åˆ«**
- Adminç•Œé¢å­—æ®µæ²¡æœ‰ä¸­æ–‡æè¿°æ˜¾ç¤º
- æè¿°æ˜¾ç¤ºä¸ºç©ºæˆ–æ˜¾ç¤ºè‹±æ–‡å­—æ®µå
- é…ç½®åŽåˆ·æ–°é¡µé¢æè¿°æ¶ˆå¤±

#### **å¼ºåˆ¶è§£å†³æ–¹æ¡ˆï¼ˆ100%æœ‰æ•ˆï¼‰**

**ç¬¬ä¸€æ­¥ï¼šå½»åº•æ¸…é™¤æ‰€æœ‰ç¼“å­˜**
```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
./scripts.sh deploy stop

# æ¸…é™¤åŽç«¯æ‰€æœ‰ç¼“å­˜ï¼ˆå…³é”®æ­¥éª¤ï¼‰
cd backend && rm -rf .tmp .cache build dist node_modules/.cache

# æ¸…é™¤å‰ç«¯ç¼“å­˜
cd ../frontend && rm -rf .next node_modules/.cache
```

**ç¬¬äºŒæ­¥ï¼šç›´æŽ¥æ›´æ–°æ•°æ®åº“é…ç½®**
```bash
# åˆ›å»ºå­—æ®µæè¿°æ›´æ–°è„šæœ¬
cat > backend/update-field-descriptions.sql << 'EOF'
-- æ›´æ–°Articleå­—æ®µæè¿°ï¼ˆç¤ºä¾‹ï¼‰
UPDATE strapi_core_store_settings 
SET value = jsonb_set(
    value::jsonb, 
    '{metadatas,featured,edit,description}', 
    '"æ˜¯å¦ç½®é¡¶æŽ¨èï¼šç”¨äºŽé¦–é¡µç²¾é€‰æŽ¨èï¼Œç½®é¡¶æ˜¾ç¤ºä¼˜è´¨å†…å®¹ï¼Œæå‡æ–‡ç« æ›å…‰åº¦"'
) 
WHERE key = 'plugin_content_manager_configuration_content_types::api::article.article';

UPDATE strapi_core_store_settings 
SET value = jsonb_set(
    value::jsonb, 
    '{metadatas,isPremium,edit,description}', 
    '"æ˜¯å¦ä¼šå‘˜ä¸“äº«ï¼šæ ‡è®°ä¸ºä¼šå‘˜ä¸“äº«çš„æ–‡ç« éœ€è¦ä¼šå‘˜æƒé™æ‰èƒ½æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œç”¨äºŽä»˜è´¹å†…å®¹ç®¡ç†"'
) 
WHERE key = 'plugin_content_manager_configuration_content_types::api::article.article';
EOF

# æ‰§è¡Œæ•°æ®åº“æ›´æ–°
cd backend && psql -U aibianx_dev -d aibianx_dev -f update-field-descriptions.sql
```

**ç¬¬ä¸‰æ­¥ï¼šé‡å¯æœåŠ¡å¹¶å¼ºåˆ¶åˆ·æ–°**
```bash
# é‡å¯å¼€å‘çŽ¯å¢ƒï¼ˆä¼šè‡ªåŠ¨æ¸…é™¤ç¼“å­˜ï¼‰
./scripts.sh deploy start

# ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨åŽï¼Œå¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨
# æŒ‰ Ctrl+Shift+R (Windows) æˆ– Cmd+Shift+R (Mac)
```

### **âš ï¸ å¸¸è§é—æ¼ç‚¹é¢„é˜²æ¸…å•**
- [ ] **æ•°æ®åº“æ³¨é‡Š** - æœ€å®¹æ˜“å¿˜è®°çš„æ­¥éª¤ï¼
- [ ] **å­—æ®µæè¿°è‡ªåŠ¨åŒ–è„šæœ¬** - å¿…é¡»æ‰§è¡Œè‡ªåŠ¨åŒ–å·¥å…·ï¼Œå½±å“åŽå°ä½¿ç”¨ä½“éªŒ
- [ ] **APIæƒé™é…ç½®** - å¯¼è‡´å‰ç«¯æ— æ³•è®¿é—®
- [ ] **å…³ç³»å­—æ®µé…ç½®** - ä¸€å¯¹å¤š/å¤šå¯¹å¤šå…³ç³»è®¾ç½®
- [ ] **å‰ç«¯ç±»åž‹å®šä¹‰** - æ›´æ–°TypeScriptç±»åž‹
- [ ] **APIæµ‹è¯•éªŒè¯** - ç¡®ä¿é›†æˆæˆåŠŸ

### **ðŸš¨ ç»å¯¹ç¦æ­¢çš„æ“ä½œ**
- âŒ **è·³è¿‡æ•°æ®åº“æ³¨é‡Š** - å¯¼è‡´åŽæœŸç»´æŠ¤å›°éš¾
- âŒ **ä¸æ‰§è¡Œå­—æ®µæè¿°è‡ªåŠ¨åŒ–è„šæœ¬** - å¯¼è‡´Adminç•Œé¢å­—æ®µæ— ä¸­æ–‡æè¿°
- âŒ **å¿˜è®°æƒé™é…ç½®** - å¯¼è‡´APIæ— æ³•è®¿é—®
- âŒ **ä¸éªŒè¯APIç«¯ç‚¹** - å¯èƒ½å­˜åœ¨é…ç½®é”™è¯¯
- âŒ **åˆ›å»ºå¤šä½™çš„index.jsæ–‡ä»¶** - å¯¼è‡´Strapi 5.xå†²çª

### **ðŸ› ï¸ è‡ªåŠ¨åŒ–è§£å†³æ–¹æ¡ˆ**
```bash
# åˆ›å»ºå†…å®¹ç±»åž‹å®Œæ•´é…ç½®è„šæœ¬
./scripts.sh tools create-content-type [name]

# è¯¥è„šæœ¬è‡ªåŠ¨æ‰§è¡Œï¼š
# 1. å­—æ®µæè¿°è‡ªåŠ¨æ·»åŠ ï¼ˆé¢„è®¾ä¸­æ–‡æè¿°ï¼‰
# 2. æ•°æ®åº“æ³¨é‡Šè‡ªåŠ¨æ·»åŠ   
# 3. APIæƒé™è‡ªåŠ¨é…ç½®
# 4. å‰ç«¯é›†æˆè‡ªåŠ¨æµ‹è¯•
# 5. è‡ªåŠ¨éªŒè¯æ£€æŸ¥
```