# é”™è¯¯é¢„é˜²æœºåˆ¶ (Error Prevention Rules)

## ğŸš¨ **é‡ç‚¹é”™è¯¯é¢„é˜²æœºåˆ¶ï¼ˆåŸºäºå®æˆ˜ç»éªŒï¼‰**

### **ğŸ”¥ å†…å®¹ç±»å‹å¼€å‘å¿…é¡»é¿å…çš„é”™è¯¯**

#### **âŒ æ•°æ®åº“å±‚é¢å¸¸è§é”™è¯¯**
```sql
-- âŒ é”™è¯¯ï¼šå¿˜è®°æ·»åŠ æ•°æ®åº“å­—æ®µæ³¨é‡Š
CREATE TABLE articles (...);  -- æ²¡æœ‰æ³¨é‡Š

-- âœ… æ­£ç¡®ï¼šæ¯ä¸ªè¡¨å’Œå­—æ®µéƒ½å¿…é¡»æœ‰æ³¨é‡Š
CREATE TABLE articles (...);
COMMENT ON TABLE articles IS 'æ–‡ç« ç®¡ç†ï¼šå­˜å‚¨ç½‘ç«™æ‰€æœ‰æ–‡ç« å†…å®¹å’Œå…ƒæ•°æ®';
COMMENT ON COLUMN articles.title IS 'æ–‡ç« æ ‡é¢˜ï¼šå¿…å¡«ï¼Œ1-255å­—ç¬¦ï¼Œç”¨äºæ˜¾ç¤ºå’ŒSEO';
```

#### **âŒ Strapié…ç½®å±‚é¢å¸¸è§é”™è¯¯**
```javascript
// âŒ é”™è¯¯ï¼šä½¿ç”¨CommonJSè¯­æ³•ï¼ˆå¯¼è‡´404é”™è¯¯ï¼‰
const { createCoreController } = require('@strapi/strapi').factories;
module.exports = createCoreController('api::article.article');

// âœ… æ­£ç¡®ï¼šå¿…é¡»ä½¿ç”¨ES6è¯­æ³•
import { factories } from '@strapi/strapi'
export default factories.createCoreController('api::article.article');
```

#### **âŒ æƒé™é…ç½®å¸¸è§é”™è¯¯**
```bash
# âŒ é”™è¯¯ï¼šå¿˜è®°é…ç½®Publicæƒé™ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•è®¿é—®API
curl -s "http://localhost:1337/api/articles" 
# è¿”å›: {"error":{"status":403,"name":"ForbiddenError"}}

# âœ… æ­£ç¡®ï¼šå¿…é¡»é…ç½®Publicæƒé™
# Admin â†’ Settings â†’ Roles â†’ Public â†’ å‹¾é€‰ find, findOne
curl -s "http://localhost:1337/api/articles" 
# è¿”å›: {"data":[...]}
```

### **ğŸ”¥ APIå¼€å‘å¿…é¡»é¿å…çš„é”™è¯¯**

#### **âŒ æ§åˆ¶å™¨å¼€å‘å¸¸è§é”™è¯¯**
```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥è¿”å›æ•°æ®åº“æŸ¥è¯¢ç»“æœï¼Œæ²¡æœ‰é”™è¯¯å¤„ç†
export default factories.createCoreController('api::article.article', ({ strapi }) => ({
  async find(ctx) {
    return await strapi.entityService.findMany('api::article.article', ctx.query)
  }
}))

// âœ… æ­£ç¡®ï¼šå¿…é¡»åŒ…å«é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯
export default factories.createCoreController('api::article.article', ({ strapi }) => ({
  async find(ctx) {
    try {
      const { page = 1, pageSize = 25 } = ctx.query
      
      // å‚æ•°éªŒè¯
      const validatedPageSize = Math.min(100, Math.max(1, parseInt(pageSize)))
      
      const result = await strapi.entityService.findMany('api::article.article', {
        ...ctx.query,
        pagination: {
          page: Math.max(1, parseInt(page)),
          pageSize: validatedPageSize
        }
      })
      
      return result
    } catch (error) {
      ctx.status = 500
      return { error: { message: 'è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥', status: 500 } }
    }
  }
}))
```

#### **âŒ APIæµ‹è¯•å¸¸è§é—æ¼**
```bash
# âŒ é”™è¯¯ï¼šåˆ›å»ºAPIåä¸æµ‹è¯•ï¼Œå¯¼è‡´çº¿ä¸Šé—®é¢˜
# æ²¡æœ‰éªŒè¯æ­¥éª¤

# âœ… æ­£ç¡®ï¼šå¿…é¡»æµ‹è¯•æ‰€æœ‰APIç«¯ç‚¹
# 1. æµ‹è¯•åŸºç¡€API
curl -s "http://localhost:1337/api/articles" | jq '.data | length'

# 2. æµ‹è¯•åˆ†é¡µ
curl -s "http://localhost:1337/api/articles?pagination[pageSize]=5" | jq '.meta.pagination'

# 3. æµ‹è¯•populate
curl -s "http://localhost:1337/api/articles?populate=author,category" | jq '.data[0].attributes.author'

# 4. æµ‹è¯•é”™è¯¯æƒ…å†µ
curl -s "http://localhost:1337/api/articles/999999" | jq '.error.status'
```

### **ğŸ”¥ å‰ç«¯å¼€å‘å¿…é¡»é¿å…çš„é”™è¯¯**

#### **âŒ ç»„ä»¶å¼€å‘å¸¸è§é”™è¯¯**
```typescript
// âŒ é”™è¯¯ï¼šç»„ä»¶æ²¡æœ‰é”™è¯¯è¾¹ç•Œå’ŒåŠ è½½çŠ¶æ€
const ArticleList = () => {
  const [articles, setArticles] = useState([])
  
  useEffect(() => {
    fetch('/api/articles').then(res => res.json()).then(setArticles)
  }, [])
  
  return (
    <div>
      {articles.map(article => <div key={article.id}>{article.title}</div>)}
    </div>
  )
}

// âœ… æ­£ç¡®ï¼šå¿…é¡»åŒ…å«é”™è¯¯å¤„ç†ã€åŠ è½½çŠ¶æ€ã€ç±»å‹å®‰å…¨
const ArticleList: React.FC = () => {
  const [articles, setArticles] = useState<Article[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  
  useEffect(() => {
    const fetchArticles = async () => {
      try {
        setLoading(true)
        setError(null)
        const response = await fetch('/api/articles')
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        
        const data = await response.json()
        setArticles(data.data || [])
      } catch (err) {
        setError(err instanceof Error ? err.message : 'è·å–æ–‡ç« å¤±è´¥')
      } finally {
        setLoading(false)
      }
    }
    
    fetchArticles()
  }, [])
  
  if (loading) return <div>Loading...</div>
  if (error) return <div>Error: {error}</div>
  
  return (
    <div>
      {articles.map(article => (
        <div key={article.id}>{article.title}</div>
      ))}
    </div>
  )
}
```

#### **âŒ æ ·å¼å¼€å‘å¸¸è§é”™è¯¯**
```css
/* âŒ é”™è¯¯ï¼šç¡¬ç¼–ç é¢œè‰²å€¼ï¼Œä¸»é¢˜åˆ‡æ¢æ—¶ä¸ç”Ÿæ•ˆ */
.button {
  color: #3B82F6;
  background: #ffffff;
}

/* âœ… æ­£ç¡®ï¼šå¿…é¡»ä½¿ç”¨CSSå˜é‡ï¼Œæ”¯æŒä¸»é¢˜åˆ‡æ¢ */
.button {
  color: var(--color-primary-blue);
  background: var(--color-bg-primary);
}

/* ğŸ”¥ å¦‚æœCSSå˜é‡ä¸ç”Ÿæ•ˆï¼Œä½¿ç”¨ç»ˆæä¼˜å…ˆçº§ç­–ç•¥ */
html body .button,
body .button,
.button,
:root .button,
:root[data-theme="dark"] .button,
:root[data-theme="light"] .button {
  color: var(--color-primary-blue) !important;
  background: var(--color-bg-primary) !important;
}
```

### **ğŸ”¥ ç¯å¢ƒé…ç½®å¿…é¡»é¿å…çš„é”™è¯¯**

#### **âŒ ç¯å¢ƒå˜é‡å¸¸è§é”™è¯¯**
```bash
# âŒ é”™è¯¯ï¼šç¡¬ç¼–ç URLï¼Œæ— æ³•é€‚åº”ä¸åŒç¯å¢ƒ
const API_URL = 'http://localhost:1337/api'

# âœ… æ­£ç¡®ï¼šå¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡
const API_URL = process.env.NEXT_PUBLIC_STRAPI_URL + '/api'
```

#### **âŒ æ•°æ®åº“é…ç½®å¸¸è§é”™è¯¯**
```javascript
// âŒ é”™è¯¯ï¼šæ•°æ®åº“è¿æ¥é…ç½®é”™è¯¯ï¼Œå¯¼è‡´è¿æ¥å¤±è´¥
module.exports = {
  host: 'localhost',
  port: 5432,
  database: 'strapi',
  username: 'root',
  password: ''
}

// âœ… æ­£ç¡®ï¼šå¿…é¡»ä½¿ç”¨ç¯å¢ƒå˜é‡å’Œæ­£ç¡®çš„é…ç½®
module.exports = {
  host: env('DATABASE_HOST', 'localhost'),
  port: env.int('DATABASE_PORT', 5432),
  database: env('DATABASE_NAME', 'aibianx_dev'),
  username: env('DATABASE_USERNAME', 'aibianx_dev'),
  password: env('DATABASE_PASSWORD'),
  ssl: env.bool('DATABASE_SSL', false)
}
```

### **ğŸ”¥ é‚®ä»¶ç³»ç»Ÿå¿…é¡»é¿å…çš„é”™è¯¯**

#### **âŒ SMTPé…ç½®å¸¸è§é”™è¯¯**
```typescript
// âŒ é”™è¯¯ï¼šç›´æ¥ç¡¬ç¼–ç SMTPé…ç½®
const transporter = nodemailer.createTransporter({
  host: 'smtp.gmail.com',
  port: 587,
  auth: {
    user: 'your-email@gmail.com',
    pass: 'your-password'
  }
})

// âœ… æ­£ç¡®ï¼šå¿…é¡»ä½¿ç”¨ç»Ÿä¸€é‚®ä»¶æœåŠ¡
import { emailService } from '@/lib/email-service'

await emailService.sendVerificationCode({
  email: user.email,
  code: verificationCode,
  type: 'register'
})
```

#### **âŒ é‚®ä»¶å‘é€å¸¸è§é”™è¯¯**
```typescript
// âŒ é”™è¯¯ï¼šæ²¡æœ‰é”™è¯¯å¤„ç†å’Œé¢‘ç‡é™åˆ¶
await sendEmail(email, subject, content)

// âœ… æ­£ç¡®ï¼šå¿…é¡»åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†
try {
  // æ£€æŸ¥å‘é€é¢‘ç‡
  await checkEmailRateLimit(email, 'verification')
  
  // éªŒè¯é‚®ç®±æ ¼å¼
  if (!validator.isEmail(email)) {
    throw new Error('é‚®ç®±æ ¼å¼æ— æ•ˆ')
  }
  
  // å‘é€é‚®ä»¶
  const result = await emailService.send({
    to: email,
    subject,
    content,
    type: 'verification'
  })
  
  // è®°å½•å‘é€æ—¥å¿—
  logger.info('é‚®ä»¶å‘é€æˆåŠŸ', { email, type: 'verification', messageId: result.messageId })
  
} catch (error) {
  logger.error('é‚®ä»¶å‘é€å¤±è´¥', { email, error: error.message })
  throw error
}
```

## **ğŸš¨ æœ€å®¹æ˜“è¢«é—æ¼çš„å…³é”®æ£€æŸ¥ç‚¹**

### **ğŸ”´ æ¯æ¬¡åˆ›å»ºå†…å®¹ç±»å‹åå¿…é¡»æ£€æŸ¥ï¼š**
1. **æ•°æ®åº“æ³¨é‡Šæ˜¯å¦å®Œæ•´** â­â­â­
2. **å­—æ®µæè¿°è‡ªåŠ¨åŒ–è„šæœ¬æ˜¯å¦æ‰§è¡ŒæˆåŠŸ** â­â­â­  
3. **APIæƒé™æ˜¯å¦é…ç½®** â­â­â­
4. **APIç«¯ç‚¹æ˜¯å¦å¯è®¿é—®** â­â­â­
5. **å‰ç«¯ç±»å‹å®šä¹‰æ˜¯å¦æ›´æ–°** â­â­

### **ğŸ”´ æ¯æ¬¡å¼€å‘æ–°APIåå¿…é¡»æ£€æŸ¥ï¼š**
1. **é”™è¯¯å¤„ç†æ˜¯å¦å®Œæ•´** â­â­â­
2. **å‚æ•°éªŒè¯æ˜¯å¦å……åˆ†** â­â­â­
3. **APIæµ‹è¯•æ˜¯å¦é€šè¿‡** â­â­â­
4. **å“åº”æ ¼å¼æ˜¯å¦æ ‡å‡†** â­â­
5. **æ—¥å¿—è®°å½•æ˜¯å¦å®Œæ•´** â­â­

### **ğŸ”´ æ¯æ¬¡éƒ¨ç½²å‰å¿…é¡»æ£€æŸ¥ï¼š**
1. **ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®** â­â­â­
2. **æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸** â­â­â­
3. **é‚®ä»¶æœåŠ¡æ˜¯å¦é…ç½®** â­â­â­
4. **æœç´¢æœåŠ¡æ˜¯å¦è¿è¡Œ** â­â­
5. **é™æ€èµ„æºæ˜¯å¦æ­£ç¡®** â­â­

## **ğŸ”§ å¸¸è§é—®é¢˜å¿«é€Ÿè¯Šæ–­å’Œè§£å†³**

### **é—®é¢˜1ï¼šAPIè¿”å›404é”™è¯¯**
```bash
# ğŸ” è¯Šæ–­æ­¥éª¤
echo "1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä½¿ç”¨ES6è¯­æ³•"
grep -r "module.exports\|require(" backend/src/api/

echo "2. æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„index.jsæ–‡ä»¶"
find backend/src/api -name "index.js"

echo "3. æ¸…é™¤ç¼“å­˜é‡å¯"
cd backend && rm -rf .tmp && npm run develop

# ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ
# 1. å°†æ‰€æœ‰.jsæ–‡ä»¶æ”¹ä¸º.ts
# 2. ä½¿ç”¨import/exportè¯­æ³•
# 3. åˆ é™¤å¤šä½™çš„index.jsæ–‡ä»¶
```

### **é—®é¢˜2ï¼šå­—æ®µæè¿°ä¸æ˜¾ç¤ºä¸­æ–‡**
```bash
# ğŸ” è¯Šæ–­æ­¥éª¤
echo "1. æ£€æŸ¥æ˜¯å¦æ‰§è¡Œäº†å­—æ®µæè¿°è„šæœ¬"
./scripts.sh tools fix-fields-any [content-type]

echo "2. æ¸…é™¤æ‰€æœ‰ç¼“å­˜"
cd backend && rm -rf .tmp .cache
cd ../frontend && rm -rf .next

echo "3. é‡å¯æœåŠ¡"
./scripts.sh deploy stop && ./scripts.sh deploy start

# ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ
# 1. ç«‹å³æ‰§è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
# 2. æ¸…é™¤ç¼“å­˜é‡å¯
# 3. å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ (Ctrl+Shift+R)
```

### **é—®é¢˜3ï¼šå‰ç«¯æ ·å¼ä¸ç”Ÿæ•ˆ**
```bash
# ğŸ” è¯Šæ–­æ­¥éª¤
echo "1. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†CSSå˜é‡"
grep -r "color: #[0-9a-fA-F]" frontend/src/styles/

echo "2. æ£€æŸ¥ä¸»é¢˜åˆ‡æ¢é€»è¾‘"
grep -r "data-theme" frontend/src/

echo "3. ä½¿ç”¨ç»ˆæä¼˜å…ˆçº§ç­–ç•¥"
# åœ¨CSSä¸­æ·»åŠ æœ€é«˜ä¼˜å…ˆçº§é€‰æ‹©å™¨

# ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ
# 1. æ›¿æ¢ç¡¬ç¼–ç é¢œè‰²ä¸ºCSSå˜é‡
# 2. ä½¿ç”¨ç»ˆæä¼˜å…ˆçº§é€‰æ‹©å™¨ç»„åˆ
# 3. æµ‹è¯•æ‰€æœ‰ä¸»é¢˜æ¨¡å¼
```

### **é—®é¢˜4ï¼šTypeScriptç±»å‹é”™è¯¯**
```bash
# ğŸ” è¯Šæ–­æ­¥éª¤
echo "1. æ£€æŸ¥ç±»å‹å®šä¹‰æ˜¯å¦æ›´æ–°"
npx tsc --noEmit

echo "2. æ£€æŸ¥APIå“åº”ç±»å‹"
curl -s "http://localhost:1337/api/articles" | jq '.data[0]'

echo "3. æ›´æ–°ç±»å‹å®šä¹‰"
# åœ¨types/api.tsä¸­æ·»åŠ æ–°çš„æ¥å£å®šä¹‰

# ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ
# 1. ç«‹å³æ›´æ–°TypeScriptç±»å‹
# 2. éªŒè¯APIå“åº”æ ¼å¼
# 3. è¿è¡Œç±»å‹æ£€æŸ¥ç¡®è®¤æ— è¯¯
```

### **é—®é¢˜5ï¼šç¯å¢ƒå˜é‡é…ç½®é”™è¯¯**
```bash
# ğŸ” è¯Šæ–­æ­¥éª¤
echo "1. æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨"
test -f backend/.env && echo "åç«¯ç¯å¢ƒå˜é‡å­˜åœ¨" || echo "åç«¯ç¯å¢ƒå˜é‡ç¼ºå¤±"
test -f frontend/.env.local && echo "å‰ç«¯ç¯å¢ƒå˜é‡å­˜åœ¨" || echo "å‰ç«¯ç¯å¢ƒå˜é‡ç¼ºå¤±"

echo "2. éªŒè¯å…³é”®ç¯å¢ƒå˜é‡"
cd backend && node -e "console.log('DATABASE_HOST:', process.env.DATABASE_HOST)"

echo "3. æµ‹è¯•è¿æ¥"
curl -s "${NEXT_PUBLIC_STRAPI_URL}/api/articles"

# ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ
# 1. åˆ›å»ºç¼ºå¤±çš„ç¯å¢ƒå˜é‡æ–‡ä»¶
# 2. å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
# 3. éªŒè¯æ‰€æœ‰è¿æ¥æ­£å¸¸
```

## **ğŸ’¡ é¢„é˜²æ€§æªæ–½å’Œæœ€ä½³å®è·µ**

### **ğŸ›¡ï¸ å¼€å‘å‰é¢„æ£€æ¸…å•**
- [ ] ç¯å¢ƒå˜é‡æ–‡ä»¶å®Œæ•´
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] ä¾èµ–ç‰ˆæœ¬å…¼å®¹
- [ ] å¼€å‘å·¥å…·é…ç½®æ­£ç¡®
- [ ] ç¼“å­˜å·²æ¸…ç†

### **ğŸ”„ å¼€å‘ä¸­æ£€æŸ¥é¢‘ç‡**
- **æ¯æ¬¡ä¿®æ”¹schema** â†’ æ¸…ç†ç¼“å­˜ + é‡å¯æœåŠ¡
- **æ¯æ¬¡æ·»åŠ API** â†’ æµ‹è¯•ç«¯ç‚¹ + æ›´æ–°ç±»å‹
- **æ¯æ¬¡ä¿®æ”¹æ ·å¼** â†’ æµ‹è¯•ä¸»é¢˜åˆ‡æ¢
- **æ¯æ¬¡æäº¤ä»£ç ** â†’ æ‰§è¡Œå®Œæ•´æ£€æŸ¥æ¸…å•

### **ğŸ“‹ é—®é¢˜è¿½è¸ªæœºåˆ¶**
- **è®°å½•å¸¸è§é—®é¢˜** â†’ æ›´æ–°é”™è¯¯é¢„é˜²è§„åˆ™
- **åˆ†ææ ¹æœ¬åŸå› ** â†’ æ”¹è¿›å¼€å‘æµç¨‹  
- **åˆ†äº«è§£å†³æ–¹æ¡ˆ** â†’ å›¢é˜ŸçŸ¥è¯†ç§¯ç´¯
- **æŒç»­æ”¹è¿›** â†’ å®šæœŸæ›´æ–°è§„èŒƒæ–‡æ¡£