module.exports = {

"[project]/.next-internal/server/app/api/auth/[...nextauth]/route/actions.js [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/assert [external] (assert, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[project]/src/lib/config.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

/**
 * 统一的服务配置管理
 * 所有域名和端口配置的单一入口
 */ // 前端服务配置
__turbopack_context__.s({
    "authConfig": ()=>authConfig,
    "config": ()=>config,
    "default": ()=>__TURBOPACK__default__export__,
    "legacyConfig": ()=>legacyConfig
});
const FRONTEND_DOMAIN = ("TURBOPACK compile-time value", "localhost") || 'localhost';
const FRONTEND_PORT = ("TURBOPACK compile-time value", "80") || '80';
const FRONTEND_PROTOCOL = ("TURBOPACK compile-time value", "http") || 'http';
// 后端服务配置
const BACKEND_DOMAIN = ("TURBOPACK compile-time value", "localhost") || 'localhost';
const BACKEND_PORT = ("TURBOPACK compile-time value", "1337") || '1337';
const BACKEND_PROTOCOL = ("TURBOPACK compile-time value", "http") || 'http';
// 搜索服务配置（前端调用后端API，不直接访问MeiliSearch）
const SEARCH_DOMAIN = ("TURBOPACK compile-time value", "localhost") || 'localhost';
const SEARCH_PORT = ("TURBOPACK compile-time value", "7700") || '7700';
const SEARCH_PROTOCOL = ("TURBOPACK compile-time value", "http") || 'http';
/**
 * 构建完整的服务URL
 */ function buildUrl(domain, port, protocol, path = '') {
    const portSuffix = protocol === 'http' && port === '80' || protocol === 'https' && port === '443' ? '' : `:${port}`;
    const baseUrl = `${protocol}://${domain}${portSuffix}`;
    return path ? `${baseUrl}${path.startsWith('/') ? path : `/${path}`}` : baseUrl;
}
const config = {
    // 前端服务
    frontend: {
        domain: FRONTEND_DOMAIN,
        port: FRONTEND_PORT,
        protocol: FRONTEND_PROTOCOL,
        url: buildUrl(FRONTEND_DOMAIN, FRONTEND_PORT, FRONTEND_PROTOCOL),
        getUrl: (path = '')=>buildUrl(FRONTEND_DOMAIN, FRONTEND_PORT, FRONTEND_PROTOCOL, path)
    },
    // 后端服务
    backend: {
        domain: BACKEND_DOMAIN,
        port: BACKEND_PORT,
        protocol: BACKEND_PROTOCOL,
        url: buildUrl(BACKEND_DOMAIN, BACKEND_PORT, BACKEND_PROTOCOL),
        getUrl: (path = '')=>buildUrl(BACKEND_DOMAIN, BACKEND_PORT, BACKEND_PROTOCOL, path),
        apiUrl: buildUrl(BACKEND_DOMAIN, BACKEND_PORT, BACKEND_PROTOCOL, '/api')
    },
    // 搜索服务（注意：前端不直接访问，通过后端代理）
    search: {
        domain: SEARCH_DOMAIN,
        port: SEARCH_PORT,
        protocol: SEARCH_PROTOCOL,
        url: buildUrl(SEARCH_DOMAIN, SEARCH_PORT, SEARCH_PROTOCOL),
        getUrl: (path = '')=>buildUrl(SEARCH_DOMAIN, SEARCH_PORT, SEARCH_PROTOCOL, path)
    }
};
const legacyConfig = {
    STRAPI_URL: config.backend.url,
    STRAPI_API_URL: config.backend.apiUrl,
    SITE_URL: config.frontend.url,
    MEILISEARCH_URL: config.search.url
};
const authConfig = {
    NEXTAUTH_URL: config.frontend.url,
    callbacks: {
        github: config.frontend.getUrl('/api/auth/callback/github'),
        google: config.frontend.getUrl('/api/auth/callback/google'),
        wechat: config.frontend.getUrl('/api/auth/callback/wechat'),
        qq: config.frontend.getUrl('/api/auth/callback/qq')
    }
};
const __TURBOPACK__default__export__ = config;
}),
"[project]/src/app/api/auth/[...nextauth]/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

/**
 * NextAuth.js 完整配置 - 支持三种认证方式
 * 根据架构文档实现：邮箱密码 + GitHub + Google OAuth
 */ __turbopack_context__.s({
    "GET": ()=>handler,
    "POST": ()=>handler
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$credentials$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/providers/credentials.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$github$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/providers/github.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$google$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next-auth/providers/google.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$config$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/lib/config.ts [app-route] (ecmascript)");
;
;
;
;
;
// OAuth用户查找或创建函数
async function findOrCreateOAuthUser(profile, account, strapiUrl) {
    const provider = account.provider;
    let user = null;
    let isNewUser = false;
    // 1. 先通过邮箱查找现有用户
    if (profile.email) {
        const response = await fetch(`${strapiUrl}/api/users?filters[email][$eq]=${profile.email}`);
        if (response.ok) {
            const data = await response.json();
            if (data.length > 0) {
                user = data[0];
            }
        }
    }
    // 2. 如果用户不存在，创建新用户
    if (!user) {
        const userData = mapOAuthProfile(profile, account);
        const createResponse = await fetch(`${strapiUrl}/api/auth/local/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });
        if (createResponse.ok) {
            const result = await createResponse.json();
            user = result.user;
            isNewUser = true;
        }
    } else {
        // 3. 更新OAuth信息
        const updateData = {};
        if (provider === 'github' && !user.githubId) {
            updateData.githubId = profile.id.toString();
            updateData.githubUsername = profile.login;
        } else if (provider === 'google' && !user.googleId) {
            updateData.googleId = profile.sub;
        }
        const connectedProviders = user.connectedProviders || [];
        if (!connectedProviders.includes(provider)) {
            connectedProviders.push(provider);
            updateData.connectedProviders = connectedProviders;
        }
        if (Object.keys(updateData).length > 0) {
            await fetch(`${strapiUrl}/api/users/${user.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            });
        }
    }
    return {
        user,
        isNewUser,
        jwt: 'temp-jwt'
    };
}
// OAuth档案信息映射
function mapOAuthProfile(profile, account) {
    const provider = account.provider;
    switch(provider){
        case 'github':
            return {
                username: profile.login,
                email: profile.email,
                nickname: profile.name,
                provider: 'github',
                providerAccountId: profile.id.toString(),
                githubId: profile.id.toString(),
                githubUsername: profile.login,
                hasPassword: false,
                isEmailVerified: true,
                connectedProviders: [
                    'github'
                ]
            };
        case 'google':
            return {
                username: profile.email.split('@')[0],
                email: profile.email,
                nickname: profile.name,
                provider: 'google',
                providerAccountId: profile.sub,
                googleId: profile.sub,
                hasPassword: false,
                isEmailVerified: profile.email_verified,
                connectedProviders: [
                    'google'
                ]
            };
        default:
            throw new Error(`Unsupported OAuth provider: ${provider}`);
    }
}
const authOptions = {
    providers: [
        // 邮箱密码登录
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$credentials$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            id: 'credentials',
            name: 'credentials',
            credentials: {
                email: {
                    label: "邮箱",
                    type: "email"
                },
                password: {
                    label: "密码",
                    type: "password"
                }
            },
            async authorize (credentials) {
                if (!credentials?.email || !credentials?.password) {
                    return null;
                }
                try {
                    const strapiUrl = __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$config$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["config"].backend.url;
                    // 调用Strapi登录API
                    const response = await fetch(`${strapiUrl}/api/auth/local`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            identifier: credentials.email,
                            password: credentials.password
                        })
                    });
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            id: data.user.id,
                            email: data.user.email,
                            name: data.user.username || data.user.nickname || data.user.email,
                            strapiUser: data.user,
                            strapiToken: data.jwt
                        };
                    }
                    return null;
                } catch (error) {
                    console.error('❌ 登录验证失败:', error);
                    return null;
                }
            }
        }),
        // GitHub OAuth登录
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$github$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            clientId: process.env.GITHUB_CLIENT_ID,
            clientSecret: process.env.GITHUB_CLIENT_SECRET
        }),
        // Google OAuth登录
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$providers$2f$google$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            clientId: process.env.GOOGLE_CLIENT_ID,
            clientSecret: process.env.GOOGLE_CLIENT_SECRET
        })
    ],
    // 使用JWT策略
    session: {
        strategy: 'jwt',
        maxAge: 30 * 24 * 60 * 60
    },
    // JWT配置
    jwt: {
        maxAge: 30 * 24 * 60 * 60
    },
    // 页面配置
    pages: {
        signIn: '/',
        error: '/auth/error'
    },
    // 回调函数
    callbacks: {
        async signIn ({ user, account, profile }) {
            console.log('✅ 用户登录尝试:', user.email, '通过', account?.provider);
            try {
                const strapiUrl = __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$lib$2f$config$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["config"].backend.url;
                // OAuth登录处理（GitHub、Google）
                if (account?.provider === 'github' || account?.provider === 'google') {
                    const existingUser = await findOrCreateOAuthUser(profile, account, strapiUrl);
                    user.strapiUser = existingUser.user;
                    user.strapiToken = existingUser.jwt;
                    user.isNewUser = existingUser.isNewUser;
                    return true;
                }
                return true;
            } catch (error) {
                console.error('❌ 登录处理失败:', error);
                return true;
            }
        },
        async jwt ({ token, user, account }) {
            // 首次登录时，将用户信息存储到JWT
            if (user) {
                token.strapiUser = user.strapiUser;
                token.strapiToken = user.strapiToken;
                token.provider = account?.provider || 'credentials';
                token.isNewUser = user.isNewUser || false;
            }
            return token;
        },
        async session ({ session, token }) {
            // 将JWT中的Strapi数据传递给session
            session.strapiUser = token.strapiUser;
            session.strapiToken = token.strapiToken;
            session.provider = token.provider;
            session.isNewUser = token.isNewUser;
            return session;
        }
    },
    // 事件回调
    events: {
        async signIn ({ user, account, isNewUser }) {
            console.log(`用户登录: ${user.email} 通过 ${account?.provider}`);
            // 如果是新用户，自动订阅功能（BillionMail已移除）
            if (isNewUser) {
                try {
                    console.log(`新用户自动订阅功能: ${user.email} (BillionMail已移除)`);
                // 这里会在邮件集成任务中实现具体逻辑
                } catch (error) {
                    console.error('❌ 自动订阅功能失败:', error);
                }
            }
        },
        async signOut ({ session }) {
            console.log(`用户登出: ${session?.user?.email}`);
        }
    },
    // 调试模式
    debug: ("TURBOPACK compile-time value", "development") === 'development',
    // 信任的主机（用于OAuth回调）
    trustHost: true
};
// 创建NextAuth handler
const handler = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])(authOptions);
;
}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__8683f694._.js.map